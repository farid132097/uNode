   1               	# 1 "kernel.S"
   1               	
   0               	
   0               	
   2               	
   3               	 ; File          : kernel.S
   4               	 ; Author        : MD. Faridul Islam (faridmdislam@gmail.com)
   5               	 ; Description   : AVR kernel for bare-metal RTOS
   6               	 ; Created       : Jul 27, 2025, 09:30 PM
   7               	 ; Last Modified : Nov 29, 2025, 11:32 PM
   8               	
   9               	
  10               	
  11               	
  12               	#include <avr/io.h>
   1               	/* Copyright (c) 2002,2003,2005,2006,2007 Marek Michalkiewicz, Joerg Wunsch
   2               	   Copyright (c) 2007 Eric B. Weddington
   3               	   All rights reserved.
   4               	
   5               	   Redistribution and use in source and binary forms, with or without
   6               	   modification, are permitted provided that the following conditions are met:
   7               	
   8               	   * Redistributions of source code must retain the above copyright
   9               	     notice, this list of conditions and the following disclaimer.
  10               	
  11               	   * Redistributions in binary form must reproduce the above copyright
  12               	     notice, this list of conditions and the following disclaimer in
  13               	     the documentation and/or other materials provided with the
  14               	     distribution.
  15               	
  16               	   * Neither the name of the copyright holders nor the names of
  17               	     contributors may be used to endorse or promote products derived
  18               	     from this software without specific prior written permission.
  19               	
  20               	  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
  21               	  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  22               	  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  23               	  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
  24               	  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  25               	  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  26               	  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  27               	  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  28               	  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  29               	  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
  30               	  POSSIBILITY OF SUCH DAMAGE. */
  31               	
  32               	/* $Id: io.h,v 1.52.2.28 2009/12/20 17:02:53 arcanum Exp $ */
  33               	
  34               	/** \file */
  35               	/** \defgroup avr_io <avr/io.h>: AVR device-specific IO definitions
  36               	    \code #include <avr/io.h> \endcode
  37               	
  38               	    This header file includes the apropriate IO definitions for the
  39               	    device that has been specified by the <tt>-mmcu=</tt> compiler
  40               	    command-line switch.  This is done by diverting to the appropriate
  41               	    file <tt>&lt;avr/io</tt><em>XXXX</em><tt>.h&gt;</tt> which should
  42               	    never be included directly.  Some register names common to all
  43               	    AVR devices are defined directly within <tt>&lt;avr/common.h&gt;</tt>,
  44               	    which is included in <tt>&lt;avr/io.h&gt;</tt>,
  45               	    but most of the details come from the respective include file.
  46               	
  47               	    Note that this file always includes the following files:
  48               	    \code 
  49               	    #include <avr/sfr_defs.h>
  50               	    #include <avr/portpins.h>
  51               	    #include <avr/common.h>
  52               	    #include <avr/version.h>
  53               	    \endcode
  54               	    See \ref avr_sfr for more details about that header file.
  55               	
  56               	    Included are definitions of the IO register set and their
  57               	    respective bit values as specified in the Atmel documentation.
  58               	    Note that inconsistencies in naming conventions,
  59               	    so even identical functions sometimes get different names on
  60               	    different devices.
  61               	
  62               	    Also included are the specific names useable for interrupt
  63               	    function definitions as documented
  64               	    \ref avr_signames "here".
  65               	
  66               	    Finally, the following macros are defined:
  67               	
  68               	    - \b RAMEND
  69               	    <br>
  70               	    The last on-chip RAM address.
  71               	    <br>
  72               	    - \b XRAMEND
  73               	    <br>
  74               	    The last possible RAM location that is addressable. This is equal to 
  75               	    RAMEND for devices that do not allow for external RAM. For devices 
  76               	    that allow external RAM, this will be larger than RAMEND.
  77               	    <br>
  78               	    - \b E2END
  79               	    <br>
  80               	    The last EEPROM address.
  81               	    <br>
  82               	    - \b FLASHEND
  83               	    <br>
  84               	    The last byte address in the Flash program space.
  85               	    <br>
  86               	    - \b SPM_PAGESIZE
  87               	    <br>
  88               	    For devices with bootloader support, the flash pagesize
  89               	    (in bytes) to be used for the \c SPM instruction. 
  90               	    - \b E2PAGESIZE
  91               	    <br>
  92               	    The size of the EEPROM page.
  93               	    
  94               	*/
  95               	
  96               	#ifndef _AVR_IO_H_
  97               	#define _AVR_IO_H_
  98               	
  99               	#include <avr/sfr_defs.h>
   1               	/* Copyright (c) 2002, Marek Michalkiewicz <marekm@amelek.gda.pl>
 100               	
 101               	#if defined (__AVR_AT94K__)
 102               	#  include <avr/ioat94k.h>
 103               	#elif defined (__AVR_AT43USB320__)
 104               	#  include <avr/io43u32x.h>
 105               	#elif defined (__AVR_AT43USB355__)
 106               	#  include <avr/io43u35x.h>
 107               	#elif defined (__AVR_AT76C711__)
 108               	#  include <avr/io76c711.h>
 109               	#elif defined (__AVR_AT86RF401__)
 110               	#  include <avr/io86r401.h>
 111               	#elif defined (__AVR_AT90PWM1__)
 112               	#  include <avr/io90pwm1.h>
 113               	#elif defined (__AVR_AT90PWM2__)
 114               	#  include <avr/io90pwmx.h>
 115               	#elif defined (__AVR_AT90PWM2B__)
 116               	#  include <avr/io90pwm2b.h>
 117               	#elif defined (__AVR_AT90PWM3__)
 118               	#  include <avr/io90pwmx.h>
 119               	#elif defined (__AVR_AT90PWM3B__)
 120               	#  include <avr/io90pwm3b.h>
 121               	#elif defined (__AVR_AT90PWM216__)
 122               	#  include <avr/io90pwm216.h>
 123               	#elif defined (__AVR_AT90PWM316__)
 124               	#  include <avr/io90pwm316.h>
 125               	#elif defined (__AVR_AT90PWM81__)
 126               	#  include <avr/io90pwm81.h>
 127               	#elif defined (__AVR_ATmega8U2__)
 128               	#  include <avr/iom8u2.h>
 129               	#elif defined (__AVR_ATmega16M1__)
 130               	#  include <avr/iom16m1.h>
 131               	#elif defined (__AVR_ATmega16U2__)
 132               	#  include <avr/iom16u2.h>
 133               	#elif defined (__AVR_ATmega16U4__)
 134               	#  include <avr/iom16u4.h>
 135               	#elif defined (__AVR_ATmega32C1__)
 136               	#  include <avr/iom32c1.h>
 137               	#elif defined (__AVR_ATmega32M1__)
 138               	#  include <avr/iom32m1.h>
 139               	#elif defined (__AVR_ATmega32U2__)
 140               	#  include <avr/iom32u2.h>
 141               	#elif defined (__AVR_ATmega32U4__)
 142               	#  include <avr/iom32u4.h>
 143               	#elif defined (__AVR_ATmega32U6__)
 144               	#  include <avr/iom32u6.h>
 145               	#elif defined (__AVR_ATmega64C1__)
 146               	#  include <avr/iom64c1.h>
 147               	#elif defined (__AVR_ATmega64M1__)
 148               	#  include <avr/iom64m1.h>
 149               	#elif defined (__AVR_ATmega128__)
 150               	#  include <avr/iom128.h>
 151               	#elif defined (__AVR_ATmega1280__)
 152               	#  include <avr/iom1280.h>
 153               	#elif defined (__AVR_ATmega1281__)
 154               	#  include <avr/iom1281.h>
 155               	#elif defined (__AVR_ATmega1284P__)
 156               	#  include <avr/iom1284p.h>
 157               	#elif defined (__AVR_ATmega128RFA1__)
 158               	#  include <avr/iom128rfa1.h>
 159               	#elif defined (__AVR_ATmega2560__)
 160               	#  include <avr/iom2560.h>
 161               	#elif defined (__AVR_ATmega2561__)
 162               	#  include <avr/iom2561.h>
 163               	#elif defined (__AVR_AT90CAN32__)
 164               	#  include <avr/iocan32.h>
 165               	#elif defined (__AVR_AT90CAN64__)
 166               	#  include <avr/iocan64.h>
 167               	#elif defined (__AVR_AT90CAN128__)
 168               	#  include <avr/iocan128.h>
 169               	#elif defined (__AVR_AT90USB82__)
 170               	#  include <avr/iousb82.h>
 171               	#elif defined (__AVR_AT90USB162__)
 172               	#  include <avr/iousb162.h>
 173               	#elif defined (__AVR_AT90USB646__)
 174               	#  include <avr/iousb646.h>
 175               	#elif defined (__AVR_AT90USB647__)
 176               	#  include <avr/iousb647.h>
 177               	#elif defined (__AVR_AT90USB1286__)
 178               	#  include <avr/iousb1286.h>
 179               	#elif defined (__AVR_AT90USB1287__)
 180               	#  include <avr/iousb1287.h>
 181               	#elif defined (__AVR_ATmega64__)
 182               	#  include <avr/iom64.h>
 183               	#elif defined (__AVR_ATmega640__)
 184               	#  include <avr/iom640.h>
 185               	#elif defined (__AVR_ATmega644__) || defined (__AVR_ATmega644A__)
 186               	#  include <avr/iom644.h>
 187               	#elif defined (__AVR_ATmega644P__)
 188               	#  include <avr/iom644p.h>
 189               	#elif defined (__AVR_ATmega644PA__)
 190               	#  include <avr/iom644pa.h>
 191               	#elif defined (__AVR_ATmega645__) || defined (__AVR_ATmega645A__) || defined (__AVR_ATmega645P__)
 192               	#  include <avr/iom645.h>
 193               	#elif defined (__AVR_ATmega6450__) || defined (__AVR_ATmega6450A__) || defined (__AVR_ATmega6450P__
 194               	#  include <avr/iom6450.h>
 195               	#elif defined (__AVR_ATmega649__) || defined (__AVR_ATmega649A__)
 196               	#  include <avr/iom649.h>
 197               	#elif defined (__AVR_ATmega6490__) || defined (__AVR_ATmega6490A__) || defined (__AVR_ATmega6490P__
 198               	#  include <avr/iom6490.h>
 199               	#elif defined (__AVR_ATmega649P__)
 200               	#  include <avr/iom649p.h>
 201               	#elif defined (__AVR_ATmega64HVE__)
 202               	#  include <avr/iom64hve.h>
 203               	#elif defined (__AVR_ATmega103__)
 204               	#  include <avr/iom103.h>
 205               	#elif defined (__AVR_ATmega32__)
 206               	#  include <avr/iom32.h>
 207               	#elif defined (__AVR_ATmega323__)
 208               	#  include <avr/iom323.h>
 209               	#elif defined (__AVR_ATmega324P__) || defined (__AVR_ATmega324A__)
 210               	#  include <avr/iom324.h>
 211               	#elif defined (__AVR_ATmega324PA__)
 212               	#  include <avr/iom324pa.h>
 213               	#elif defined (__AVR_ATmega325__)
 214               	#  include <avr/iom325.h>
 215               	#elif defined (__AVR_ATmega325P__)
 216               	#  include <avr/iom325.h>
 217               	#elif defined (__AVR_ATmega3250__)
 218               	#  include <avr/iom3250.h>
 219               	#elif defined (__AVR_ATmega3250P__)
 220               	#  include <avr/iom3250.h>
 221               	#elif defined (__AVR_ATmega328P__) || defined (__AVR_ATmega328__)
 222               	#  include <avr/iom328p.h>
   1               	/* Copyright (c) 2007 Atmel Corporation
 223               	#elif defined (__AVR_ATmega329__)
 224               	#  include <avr/iom329.h>
 225               	#elif defined (__AVR_ATmega329P__) || defined (__AVR_ATmega329PA__)
 226               	#  include <avr/iom329.h>
 227               	#elif defined (__AVR_ATmega3290__)
 228               	#  include <avr/iom3290.h>
 229               	#elif defined (__AVR_ATmega3290P__)
 230               	#  include <avr/iom3290.h>
 231               	#elif defined (__AVR_ATmega32HVB__)
 232               	#  include <avr/iom32hvb.h>
 233               	#elif defined (__AVR_ATmega406__)
 234               	#  include <avr/iom406.h>
 235               	#elif defined (__AVR_ATmega16__)
 236               	#  include <avr/iom16.h>
 237               	#elif defined (__AVR_ATmega16A__)
 238               	#  include <avr/iom16a.h>
 239               	#elif defined (__AVR_ATmega161__)
 240               	#  include <avr/iom161.h>
 241               	#elif defined (__AVR_ATmega162__)
 242               	#  include <avr/iom162.h>
 243               	#elif defined (__AVR_ATmega163__)
 244               	#  include <avr/iom163.h>
 245               	#elif defined (__AVR_ATmega164P__) || defined (__AVR_ATmega164A__)
 246               	#  include <avr/iom164.h>
 247               	#elif defined (__AVR_ATmega165__) || defined (__AVR_ATmega165A__)
 248               	#  include <avr/iom165.h>
 249               	#elif defined (__AVR_ATmega165P__)
 250               	#  include <avr/iom165p.h>
 251               	#elif defined (__AVR_ATmega168__) || defined (__AVR_ATmega168A__)
 252               	#  include <avr/iom168.h>
 253               	#elif defined (__AVR_ATmega168P__)
 254               	#  include <avr/iom168p.h>
 255               	#elif defined (__AVR_ATmega169__) || defined (__AVR_ATmega169A__)
 256               	#  include <avr/iom169.h>
 257               	#elif defined (__AVR_ATmega169P__)
 258               	#  include <avr/iom169p.h>
 259               	#elif defined (__AVR_ATmega169PA__)
 260               	#  include <avr/iom169pa.h>
 261               	#elif defined (__AVR_ATmega8HVA__)
 262               	#  include <avr/iom8hva.h>
 263               	#elif defined (__AVR_ATmega16HVA__)
 264               	#  include <avr/iom16hva.h>
 265               	#elif defined (__AVR_ATmega16HVA2__)
 266               	#  include <avr/iom16hva2.h>
 267               	#elif defined (__AVR_ATmega16HVB__)
 268               	#  include <avr/iom16hvb.h>
 269               	#elif defined (__AVR_ATmega8__)
 270               	#  include <avr/iom8.h>
 271               	#elif defined (__AVR_ATmega48__) || defined (__AVR_ATmega48A__)
 272               	#  include <avr/iom48.h>
 273               	#elif defined (__AVR_ATmega48P__)
 274               	#  include <avr/iom48p.h>
 275               	#elif defined (__AVR_ATmega88__) || defined (__AVR_ATmega88A__)
 276               	#  include <avr/iom88.h>
 277               	#elif defined (__AVR_ATmega88P__)
 278               	#  include <avr/iom88p.h>
 279               	#elif defined (__AVR_ATmega88PA__)
 280               	#  include <avr/iom88pa.h>
 281               	#elif defined (__AVR_ATmega8515__)
 282               	#  include <avr/iom8515.h>
 283               	#elif defined (__AVR_ATmega8535__)
 284               	#  include <avr/iom8535.h>
 285               	#elif defined (__AVR_AT90S8535__)
 286               	#  include <avr/io8535.h>
 287               	#elif defined (__AVR_AT90C8534__)
 288               	#  include <avr/io8534.h>
 289               	#elif defined (__AVR_AT90S8515__)
 290               	#  include <avr/io8515.h>
 291               	#elif defined (__AVR_AT90S4434__)
 292               	#  include <avr/io4434.h>
 293               	#elif defined (__AVR_AT90S4433__)
 294               	#  include <avr/io4433.h>
 295               	#elif defined (__AVR_AT90S4414__)
 296               	#  include <avr/io4414.h>
 297               	#elif defined (__AVR_ATtiny22__)
 298               	#  include <avr/iotn22.h>
 299               	#elif defined (__AVR_ATtiny26__)
 300               	#  include <avr/iotn26.h>
 301               	#elif defined (__AVR_AT90S2343__)
 302               	#  include <avr/io2343.h>
 303               	#elif defined (__AVR_AT90S2333__)
 304               	#  include <avr/io2333.h>
 305               	#elif defined (__AVR_AT90S2323__)
 306               	#  include <avr/io2323.h>
 307               	#elif defined (__AVR_AT90S2313__)
 308               	#  include <avr/io2313.h>
 309               	#elif defined (__AVR_ATtiny2313__)
 310               	#  include <avr/iotn2313.h>
 311               	#elif defined (__AVR_ATtiny2313A__)
 312               	#  include <avr/iotn2313a.h>
 313               	#elif defined (__AVR_ATtiny13__)
 314               	#  include <avr/iotn13.h>
 315               	#elif defined (__AVR_ATtiny13A__)
 316               	#  include <avr/iotn13a.h>
 317               	#elif defined (__AVR_ATtiny25__)
 318               	#  include <avr/iotn25.h>
 319               	#elif defined (__AVR_ATtiny4313__)
 320               	#  include <avr/iotn4313.h>
 321               	#elif defined (__AVR_ATtiny45__)
 322               	#  include <avr/iotn45.h>
 323               	#elif defined (__AVR_ATtiny85__)
 324               	#  include <avr/iotn85.h>
 325               	#elif defined (__AVR_ATtiny24__)
 326               	#  include <avr/iotn24.h>
 327               	#elif defined (__AVR_ATtiny24A__)
 328               	#  include <avr/iotn24a.h>
 329               	#elif defined (__AVR_ATtiny44__)
 330               	#  include <avr/iotn44.h>
 331               	#elif defined (__AVR_ATtiny44A__)
 332               	#  include <avr/iotn44a.h>
 333               	#elif defined (__AVR_ATtiny84__)
 334               	#  include <avr/iotn84.h>
 335               	#elif defined (__AVR_ATtiny261__)
 336               	#  include <avr/iotn261.h>
 337               	#elif defined (__AVR_ATtiny261A__)
 338               	#  include <avr/iotn261a.h>
 339               	#elif defined (__AVR_ATtiny461__)
 340               	#  include <avr/iotn461.h>
 341               	#elif defined (__AVR_ATtiny461A__)
 342               	#  include <avr/iotn461a.h>
 343               	#elif defined (__AVR_ATtiny861__)
 344               	#  include <avr/iotn861.h>
 345               	#elif defined (__AVR_ATtiny861A__)
 346               	#  include <avr/iotn861a.h>
 347               	#elif defined (__AVR_ATtiny43U__)
 348               	#  include <avr/iotn43u.h>
 349               	#elif defined (__AVR_ATtiny48__)
 350               	#  include <avr/iotn48.h>
 351               	#elif defined (__AVR_ATtiny88__)
 352               	#  include <avr/iotn88.h>
 353               	#elif defined (__AVR_ATtiny87__)
 354               	#  include <avr/iotn87.h>
 355               	#elif defined (__AVR_ATtiny167__)
 356               	#  include <avr/iotn167.h>
 357               	#elif defined (__AVR_AT90SCR100__)
 358               	#  include <avr/io90scr100.h>
 359               	#elif defined (__AVR_ATxmega16A4__)
 360               	#  include <avr/iox16a4.h>
 361               	#elif defined (__AVR_ATxmega16D4__)
 362               	#  include <avr/iox16d4.h>
 363               	#elif defined (__AVR_ATxmega32A4__)
 364               	#  include <avr/iox32a4.h>
 365               	#elif defined (__AVR_ATxmega32D4__)
 366               	#  include <avr/iox32d4.h>
 367               	#elif defined (__AVR_ATxmega64A1__)
 368               	#  include <avr/iox64a1.h>
 369               	#elif defined (__AVR_ATxmega64A3__)
 370               	#  include <avr/iox64a3.h>
 371               	#elif defined (__AVR_ATxmega64D3__)
 372               	#  include <avr/iox64d3.h>
 373               	#elif defined (__AVR_ATxmega128A1__)
 374               	#  include <avr/iox128a1.h>
 375               	#elif defined (__AVR_ATxmega128A3__)
 376               	#  include <avr/iox128a3.h>
 377               	#elif defined (__AVR_ATxmega128D3__)
 378               	#  include <avr/iox128d3.h>
 379               	#elif defined (__AVR_ATxmega192A3__)
 380               	#  include <avr/iox192a3.h>
 381               	#elif defined (__AVR_ATxmega192D3__)
 382               	#  include <avr/iox192d3.h>
 383               	#elif defined (__AVR_ATxmega256A3__)
 384               	#  include <avr/iox256a3.h>
 385               	#elif defined (__AVR_ATxmega256A3B__)
 386               	#  include <avr/iox256a3b.h>
 387               	#elif defined (__AVR_ATxmega256D3__)
 388               	#  include <avr/iox256d3.h>
 389               	#elif defined (__AVR_ATA6289__)
 390               	#  include <avr/ioa6289.h>
 391               	/* avr1: the following only supported for assembler programs */
 392               	#elif defined (__AVR_ATtiny28__)
 393               	#  include <avr/iotn28.h>
 394               	#elif defined (__AVR_AT90S1200__)
 395               	#  include <avr/io1200.h>
 396               	#elif defined (__AVR_ATtiny15__)
 397               	#  include <avr/iotn15.h>
 398               	#elif defined (__AVR_ATtiny12__)
 399               	#  include <avr/iotn12.h>
 400               	#elif defined (__AVR_ATtiny11__)
 401               	#  include <avr/iotn11.h>
 402               	#else
 403               	#  if !defined(__COMPILING_AVR_LIBC__)
 404               	#    warning "device type not defined"
 405               	#  endif
 406               	#endif
 407               	
 408               	#include <avr/portpins.h>
   1               	/* Copyright (c) 2003  Theodore A. Roth
 409               	
 410               	#include <avr/common.h>
   1               	/* Copyright (c) 2007 Eric B. Weddington
 411               	
 412               	#include <avr/version.h>
   1               	/* Copyright (c) 2005, Joerg Wunsch                               -*- c -*-
 413               	
 414               	/* Include fuse.h after individual IO header files. */
 415               	#include <avr/fuse.h>
   1               	/* Copyright (c) 2007, Atmel Corporation
 416               	
 417               	/* Include lock.h after individual IO header files. */
 418               	#include <avr/lock.h>
   1               	/* Copyright (c) 2007, Atmel Corporation
 419               	
  13               	#include <avr/interrupt.h>
   1               	/* Copyright (c) 2002,2005,2007 Marek Michalkiewicz
  14               	#include "kernel.h"
   1               	
  15               	
  16               	
  17               	
  18               	
  19               	;;============================define user address or macro starting=========================;; 
  20               	.equ     KER_TR ,         1000                            ;TickRate in Hz, not calculated      
  21               	.equ     KER_PRS,         0x03                            ;For prescaler 64, manually select   
  22               	.equ     KER_RLD,         0x82                            ;KER_RLD=0xFF-(F_CPU/KER_PRS/KER_TR) 
  23               	.equ     KER_STK_SZ,      128                             ;stack size in bytes for each task   
  24               	.equ     KER_MX_NTSK,     10                              ;max number of tasks                 
  25               	;;==============================define user address or macro end============================;; 
  26               	
  27               	
  28               	
  29               	
  30               	
  31               	;;===============================define data offsets starting===============================;; 
  32               	.equ     OFB_TICK0,       0x00                            ;offset from KerBase tick count byte0
  33               	.equ     OFB_TICK1,       0x01                            ;offset from KerBase tick count byte1
  34               	.equ     OFB_TICK2,       0x02                            ;offset from KerBase tick count byte2
  35               	.equ     OFB_TICK3,       0x03                            ;offset from KerBase tick count byte3
  36               	.equ     OFB_TICK4,       0x04                            ;offset from KerBase tick count byte4
  37               	.equ     OFB_PRS  ,       0x05                            ;offset from KerBase prescaler       
  38               	.equ     OFB_RLD  ,       0x06                            ;offset from KerBase counter reload  
  39               	.equ     OFB_TID  ,       0x07                            ;offset from KerBase task id         
  40               	.equ     OFB_NTSK ,       0x08                            ;offset from KerBase ntask           
  41               	.equ     OFB_LPR  ,       0x09                            ;offset from KerBase lowest priority 
  42               	.equ     OFB_PTID ,       0x0A                            ;offset from KerBase prio task_id    
  43               	.equ     OFB_UTC  ,       0x0B                            ;offset from KerBase usage tick cnt  
  44               	.equ     OFB_UATC ,       0x0C                            ;offset from KerBase active tick cnt 
  45               	.equ     OFB_USAGE,       0x0D                            ;offset from KerBase cpu usage       
  46               	.equ     OFB_SLCFG,       0x0E                            ;offset from KerBase sleep config    
  47               	.equ     OFM_MSPI ,       0x00                            ;offset from MSPZP msp index field   
  48               	.equ     OFM_MSPS ,       0x02                            ;offset from MSPZP msp starting      
  49               	;;==================================define data offsets end=================================;; 
  50               	
  51               	
  52               	
  53               	
  54               	
  55               	;;===============================define system macro starting===============================;; 
  56               	.equ     TASK_BLOCKED,    0x00                            ;KerSchSts val=0                     
  57               	.equ     TASK_READY,      0x01                            ;KerSchSts val=1                     
  58               	.equ     TASK_EXECUTING,  0x02                            ;KerSchSts val=2                     
  59               	.equ     TASK_SUSPENDED,  0x03                            ;KerSchSts val=3                     
  60               	.equ     TASK_CONS_LAT,   0x04                            ;KerSchSts val=3, constant latency   
  61               	.equ     SCH_MODE_HANDLER,0x00                            ;handler mode in KER_SLP_TIME_MGNT   
  62               	.equ     SCH_MODE_THREAD, 0x01                            ;thread mode in KER_SLP_TIME_MGNT    
  63               	;;==================================define system macro end=================================;; 
  64               	
  65               	
  66               	
  67               	
  68               	
  69               	;;===========================define hardware reg address starting===========================;; 
  70               	;SRAM Mapped Addresses, LDS/STS can be used                                                    
  71               	.equ     SRASSR  ,        0xB6                            ;manually defined ASSR in SRAM       
  72               	.equ     SROCR2B ,        0xB4                            ;manually defined OCR2B in SRAM      
  73               	.equ     SROCR2A ,        0xB3                            ;manually defined OCR2A in SRAM      
  74               	.equ     SRTCNT2 ,        0xB2                            ;manually defined TNCT2 in SRAM      
  75               	.equ     SRTCCR2B,        0xB1                            ;manually defined TCCR2B in SRAM     
  76               	.equ     SRTCCR2A,        0xB0                            ;manually defined TCCR2A in SRAM     
  77               	.equ     SRADMUX ,        0x7C                            ;manually defined ADMUX in SRAM      
  78               	.equ     SRADCSRB,        0x7B                            ;manually defined ADCSRB in SRAM     
  79               	.equ     SRADCSRA,        0x7A                            ;manually defined ADCSRA in SRAM     
  80               	.equ     SRTIMSK2,        0x70                            ;manually defined TIMSK2 in SRAM     
  81               	.equ     SRTIMSK1,        0x6F                            ;manually defined TIMSK1 in SRAM     
  82               	.equ     SRTIMSK0,        0x6E                            ;manually defined TIMSK0 in SRAM     
  83               	.equ     SRCLKPR ,        0x61                            ;manually defined CLKPR in SRAM     
  84               	.equ     SRWDTCSR,        0x60                            ;manually defined WDTCSR in SRAM     
  85               	.equ     SRSREG  ,        0x5F                            ;manually defined SREG in SRAM       
  86               	.equ     SRSPH   ,        0x5E                            ;manually defined SPH in SRAM        
  87               	.equ     SRSPL   ,        0x5D                            ;manually defined SPL in SRAM        
  88               	.equ     SRMCUCR ,        0x55                            ;manually defined MCUCR in SRAM      
  89               	.equ     SRMCUSR ,        0x54                            ;manually defined MCUSR in SRAM      
  90               	.equ     SRSMCR  ,        0x53                            ;manually defined SMCR in SRAM       
  91               	.equ     SRACSR  ,        0x50                            ;manually defined ACSR in SRAM       
  92               	.equ     SROCR0B ,        0x48                            ;manually defined OCR0B in SRAM      
  93               	.equ     SROCR0A ,        0x47                            ;manually defined OCR0A in SRAM      
  94               	.equ     SRTCNT0 ,        0x46                            ;manually defined TCNT0 in SRAM      
  95               	.equ     SRTCCR0B,        0x45                            ;manually defined TCCR0B in SRAM     
  96               	.equ     SRTCCR0A,        0x44                            ;manually defined TCCR0A in SRAM     
  97               	.equ     SRTIFR2 ,        0x37                            ;manually defined TIFR2 in SRAM      
  98               	.equ     SRTIFR1 ,        0x36                            ;manually defined TIFR1 in SRAM      
  99               	.equ     SRTIFR0 ,        0x35                            ;manually defined TIFR0 in SRAM      
 100               	;IO Mapped Addresses, IN/OUT commands can be used                                              
 101               	.equ     IOSREG  ,        0x3F                            ;manually defined SREG in IO         
 102               	.equ     IOSPH   ,        0x3E                            ;manually defined SPH in IO          
 103               	.equ     IOSPL   ,        0x3D                            ;manually defined SPL in IO          
 104               	.equ     IOMCUCR ,        0x35                            ;manually defined MCUCR in IO        
 105               	.equ     IOMCUSR ,        0x34                            ;manually defined MCUSR in IO        
 106               	.equ     IOSMCR  ,        0x33                            ;manually defined SMCR in IO         
 107               	.equ     IOOCR0B ,        0x28                            ;manually defined OCR0B in IO        
 108               	.equ     IOOCR0A ,        0x27                            ;manually defined OCR0A in IO        
 109               	.equ     IOTCNT0 ,        0x26                            ;manually defined TCNT0 in IO        
 110               	.equ     IOTCCR0B,        0x25                            ;manually defined TCCR0B in IO       
 111               	.equ     IOTCCR0A,        0x24                            ;manually defined TCCR0A in IO       
 112               	.equ     IOTIFR2 ,        0x17                            ;manually defined TIFR2 in IO        
 113               	.equ     IOTIFR1 ,        0x16                            ;manually defined TIFR1 in IO        
 114               	.equ     IOTIFR0 ,        0x15                            ;manually defined TIFR0 in IO        
 115               	;;==============================define hardware reg address end=============================;; 
 116               	
 117               	
 118               	
 119               	
 120               	
 121               	;;===============================define vector section starting=============================;; 
 122               	.section .vectors, "ax", @progbits                                                             
 123               	                                                                                               
 124               	;.org    0x000C                                            ;isr location for wdt                
 125               	;        JMP   __vector_6                                                                       
 126               	;.org    0x000E                                            ;isr location for timer2compa async  
 127               	;        JMP   __vector_7                                                                       
 128               	;.org    0x0010                                            ;isr location for timer2compb async  
 129               	;        JMP   __vector_8                                                                       
 130               	;.org    0x0012                                            ;isr location for timer2ovf async    
 131               	;        JMP   __vector_9                                                                       
 132               	;.org    0x0020                                            ;isr location for timer0ovf          
 133               	;        JMP   __vector_16                                                                      
 134               	;;=================================define vector section end================================;; 
 135               	
 136               	
 137               	
 138               	
 139               	
 140               	;;=============================define global variables starting=============================;; 
 141               	.section   .bss                                                                                
 142               	                                                                                               
 143               	.global    KerBase                                        ;declare global space for kernel     
 144 0000 0000 0000 	KerBase:   .skip 16                                       ;see offset section                  
 144      0000 0000 
 144      0000 0000 
 144      0000 0000 
 145               	                                                                                               
 146               	.global    KerPSP                                         ;space for process stack pointers    
 147 0010 0000 0000 	KerPSP:    .skip KER_MX_NTSK*2                            ;2 bytes for each task               
 147      0000 0000 
 147      0000 0000 
 147      0000 0000 
 147      0000 0000 
 148               	                                                                                               
 149               	.global    KerSSZ                                         ;stack for main stack pointers       
 150 0024 0000 0000 	KerSSZ:    .skip 14                                       ;stack_ptr(2), MSPZPn(4)             
 150      0000 0000 
 150      0000 0000 
 150      0000 
 151               	                                                                                               
 152               	.global    KerSchSts                                      ;space for scheduler status          
 153 0032 0000 0000 	KerSchSts: .skip KER_MX_NTSK*1                            ;status(1)                           
 153      0000 0000 
 153      0000 
 154               	                                                                                               
 155               	.global    KerSchPr                                       ;space for scheduler priority        
 156 003c 0000 0000 	KerSchPr:  .skip KER_MX_NTSK*1                            ;priority(1)                         
 156      0000 0000 
 156      0000 
 157               	                                                                                               
 158               	.global    KerSchSlp                                      ;space for task sleep                
 159 0046 0000 0000 	KerSchSlp: .skip KER_MX_NTSK*2                            ;timing(2)                           
 159      0000 0000 
 159      0000 0000 
 159      0000 0000 
 159      0000 0000 
 160               	                                                                                               
 161               	.global    KerStack                                       ;space for stack                     
 162 005a 0000 0000 	KerStack:  .skip KER_STK_SZ*KER_MX_NTSK                   ;KER_STK_SZ bytes for each task      
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 162      0000 0000 
 163               	;;==============================define global variables end=================================;; 
 164               	
 165               	
 166               	
 167               	
 168               	
 169               	;;===============================define text section starting===============================;; 
 170               	.section .text                                                                                 
 171               	;;==================================define text section end=================================;; 
 172               	
 173               	
 174               	
 175               	
 176               	
 177               	;;==============================define global functions starting============================;; 
 178               	.global  Kernel_Tick_Init                                                                      
 179               	.global  Kernel_Task_Create                                                                    
 180               	.global  Kernel_Start_Tasks                                                                    
 181               	.global  Kernel_Init                                                                           
 182               	.global  Kernel_Task_Idle                                                                      
 183               	.global  Kernel_Task_Sleep                                                                     
 184               	.global  Kernel_Task_Constant_Latency                                                          
 185               	.global  Kernel_Task_Constant_Latency_Sleep                                                    
 186               	.global  Kernel_PreSleep_Hook                                                                  
 187               	.global  Kernel_Clock_Prescale                                                                 
 188               	.global  Kernel_Task_Sleep_Time_Get                                                            
 189               	.global  Kernel_Task_Status_Get                                                                
 190               	.global  Kernel_NTask_Get                                                                      
 191               	.global  Kernel_Task_Prio_Get                                                                  
 192               	.global  Kernel_Lowest_Prio_Get                                                                
 193               	.global  Kernel_High_Prio_Task_ID_Get                                                          
 194               	.global  Kernel_Abs_High_Prio_Task_ID_Get                                                      
 195               	.global  Kernel_CPU_Usage_Get                                                                  
 196               	.global  Kernel_Tick_Val_Get                                                                
 197               	.global  Kernel_Tick_Val_Safely_Get                                                         
 198               	;;================================define global functions end===============================;; 
 199               	
 200               	
 201               	
 202               	
 203               	
 204               	;;============================debug pin operation init starting=============================;; 
 205               	;used registers          : R18, R19                                                            
 206               	;arg registers           : None                                                                
 207               	;return registers        : None                                                                
 208               	;unsafe access registers : R18, R19                                                            
 209               	.macro  KER_TIMER_INIT                                    ;1.25/1.50uS @8MHz    (10/12 clocks) 
 210               	        #ifdef KER_TIMER0_AS_TICK_SRC                                                          
 211               			;Timer0 overflow vect is used as tick source      ;total 1.5uS @8MHz      ( 12 clocks) 
 212               	        LDS   R18		         , KerBase+OFB_PRS        ;load prescaler         (  2 clocks) 
 213               			LDS   R19		         , KerBase+OFB_RLD        ;load reload val        (  2 clocks) 
 214               			STS   SRTCCR0B           , R18                    ;prescaler-> TCCR0B     (  2 clocks) 
 215               			STS   SRTCNT0            , R19                    ;reload val-> TCNT0     (  2 clocks) 
 216               			LDI   R18                , 0x01                   ;bit mask TOIE0         (  1 clock ) 
 217               			STS   SRTIMSK0           , R18                    ;set to TIMSK0          (  2 clocks) 
 218               			SEI                                               ;force enable interrupt (  1 clock ) 
 219               			#endif                                                                                 
 220               			                                                                                       
 221               			#ifdef KER_WDT_AS_TICK_SRC                                                             
 222               			;watchdog timer timeout is used as tick source    ;total 1.5uS @8MHz      ( 10 clocks) 
 223               	        WDR                                               ;reset wdt              (  1 clock ) 
 224               			LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
 225               			ORI   R18                , 0x18                   ;set WDCE,WDE           (  1 clock ) 
 226               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 227               			                                                                                       
 228               			#ifdef KER_WDT_TICK_16MS                                                               
 229               			LDI   R18                , 0x40                   ;WDIE                   (  1 clock ) 
 230               			#endif                                                                                 
 231               			                                                                                       
 232               	        #ifdef KER_WDT_TICK_32MS                                                               
 233               			LDI   R18                , 0x41                   ;WDIE, WDPS0            (  1 clock ) 
 234               			#endif                                                                                 
 235               			                                                                                       
 236               			#ifdef KER_WDT_TICK_64MS                                                               
 237               			LDI   R18                , 0x42                   ;WDIE, WDPS1            (  1 clock ) 
 238               			#endif                                                                                 
 239               			                                                                                       
 240               			#ifdef KER_WDT_TICK_125MS                                                              
 241               			LDI   R18                , 0x43                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 242               			#endif                                                                                 
 243               			                                                                                       
 244               			#ifdef KER_WDT_TICK_250MS                                                              
 245               			LDI   R18                , 0x44                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 246               			#endif                                                                                 
 247               			                                                                                       
 248               			#ifdef KER_WDT_TICK_500MS                                                              
 249               			LDI   R18                , 0x45                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 250               			#endif                                                                                 
 251               			                                                                                       
 252               			#ifdef KER_WDT_TICK_1000MS                                                             
 253               			LDI   R18                , 0x46                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 254               			#endif                                                                                 
 255               			                                                                                       
 256               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 257               			SEI                                               ;force enable interrupt (  1 clock ) 
 258               			#endif                                                                                 
 259               	                                                                                               
 260               			#ifdef KER_TOSC_AS_TICK_SRC                                                            
 261               			;timer2 asynchornus mode is used as tick source   ;total 1.5uS @8MHz      ( 57 clocks) 
 262               			LDI   R18                , 0x00                   ;clear interrupts       (  1 clock ) 
 263               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 264               			LDI   R18                , 0x20                   ;set AS2 bit            (  1 clock ) 
 265               			STS   SRASSR             , R18                    ;set val to ASSR        (  2 clocks) 
 266               			#ifdef KER_TOSC_TICK_1MS                                                               
 267               			LDI   R18                , 0x20                   ;1000Hz->clk/1/32       (  1 clock ) 
 268               			#endif                                                                                 
 269               			#ifdef KER_TOSC_TICK_10MS                                                              
 270               			LDI   R18                , 0x29                   ;100Hz->clk/8/41        (  1 clock ) 
 271               			#endif                                                                                 
 272               			#ifdef KER_TOSC_TICK_50MS                                                              
 273               			LDI   R18                , 0xCC                   ;20Hz->clk/8/204        (  1 clock ) 
 274               			#endif                                                                                 
 275               			#ifdef KER_TOSC_TICK_100MS                                                             
 276               			LDI   R18                , 0x66                   ;10Hz->clk/32/102       (  1 clock ) 
 277               			#endif                                                                                 
 278               			#ifdef KER_TOSC_TICK_250MS                                                             
 279               			LDI   R18                , 0x80                   ;4Hz->clk/64/128        (  1 clock ) 
 280               			#endif                                                                                 
 281               			#ifdef KER_TOSC_TICK_500MS                                                             
 282               			LDI   R18                , 0x80                   ;2Hz->clk/128/128       (  1 clock ) 
 283               			#endif                                                                                 
 284               			#ifdef KER_TOSC_TICK_1000MS                                                            
 285               			LDI   R18                , 0x80                   ;1Hz->clk/256/128       (  1 clock ) 
 286               			#endif                                                                                 
 287               			STS   SROCR2A            , R18                    ;set val to OCR2A       (  2 clocks) 
 288               			LDI   R18                , 0x00                   ;set val to reg         (  1 clock ) 
 289               			STS   SROCR2B            , R18                    ;set val to OCR2B       (  2 clocks) 
 290               			LDI   R18                , 0x02                   ;set WGM mode           (  1 clock ) 
 291               			STS   SRTCCR2A           , R18                    ;set val to TCCR2A      (  2 clocks) 
 292               			#ifdef KER_TOSC_TICK_1MS                                                               
 293               			LDI   R18                , 0x01                   ;1000Hz->clk/1/32       (  1 clock ) 
 294               			#endif                                                                                 
 295               			#ifdef KER_TOSC_TICK_10MS                                                              
 296               			LDI   R18                , 0x02                   ;100Hz->clk/8/41        (  1 clock ) 
 297               			#endif                                                                                 
 298               			#ifdef KER_TOSC_TICK_50MS                                                              
 299               			LDI   R18                , 0x02                   ;20Hz->clk/8/204        (  1 clock ) 
 300               			#endif                                                                                 
 301               			#ifdef KER_TOSC_TICK_100MS                                                             
 302               			LDI   R18                , 0x03                   ;10Hz->clk/32/102       (  1 clock ) 
 303               			#endif                                                                                 
 304               			#ifdef KER_TOSC_TICK_250MS                                                             
 305               			LDI   R18                , 0x04                   ;4Hz->clk/64/128        (  1 clock ) 
 306               			#endif                                                                                 
 307               			#ifdef KER_TOSC_TICK_500MS                                                             
 308               			LDI   R18                , 0x05                   ;2Hz->clk/128/128       (  1 clock ) 
 309               			#endif                                                                                 
 310               			#ifdef KER_TOSC_TICK_1000MS                                                            
 311               			LDI   R18                , 0x06                   ;1Hz->clk/256/128       (  1 clock ) 
 312               			#endif                                                                                 
 313               			STS   SRTCCR2B           , R18                    ;set val to TCCR2B      (  2 clocks) 
 314               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 315               			STS   SRTCNT2            , R18                    ;set val to TCNT2       (  2 clocks) 
 316               		_KER_TC2_AUB\@:                                                                            
 317               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 318               	        ANDI  R18                , 0x02                   ;check bit TCR2AUB      (  1 clock ) 
 319               			BRNE  _KER_TC2_AUB\@                              ;wait until AUB cleared (  2 clocks) 
 320               		_KER_TC2_BUB\@:                                                                            
 321               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 322               	        ANDI  R18                , 0x01                   ;check bit TCR2BUB      (  1 clock ) 
 323               			BRNE  _KER_TC2_BUB\@                              ;wait until BUB cleared (  2 clocks) 
 324               		_KER_OC2_AUB\@:                                                                            
 325               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 326               	        ANDI  R18                , 0x08                   ;check bit OR2AUB       (  1 clock ) 
 327               			BRNE  _KER_OC2_AUB\@                              ;wait until AUB cleared (  2 clocks) 
 328               		_KER_OC2_BUB\@:                                                                            
 329               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 330               	        ANDI  R18                , 0x04                   ;check bit OCR2BUB      (  1 clock ) 
 331               			BRNE  _KER_OC2_BUB\@                              ;wait until BUB cleared (  2 clocks) 
 332               		_KER_TC2_UB\@:                                                                             
 333               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 334               	        ANDI  R18                , 0x10                   ;check bit TCNT2UB      (  1 clock ) 
 335               			BRNE  _KER_TC2_UB\@                               ;wait until BUB cleared (  2 clocks) 
 336               		_KER_TC2_TOV2\@:                                                                           
 337               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 338               	        ANDI  R18                , 0x01                   ;check bit TOV2         (  1 clock ) 
 339               	        BREQ  _KER_TC2_OCF2A\@                            ;bit cleared, jump next (  2 clocks) 
 340               			LDI   R18                , 0x01                   ;set bit                (  1 clock ) 
 341               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 342               	    _KER_TC2_OCF2A\@:                                                                          
 343               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 344               	        ANDI  R18                , 0x02                   ;check bit OCF2A        (  1 clock ) 
 345               	        BREQ  _KER_TC2_OCF2B\@                            ;bit cleared, jump next (  2 clocks) 
 346               			LDI   R18                , 0x02                   ;set bit                (  1 clock ) 
 347               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 348               		_KER_TC2_OCF2B\@:                                                                          
 349               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 350               	        ANDI  R18                , 0x04                   ;check bit OCF2B        (  1 clock ) 
 351               	        BREQ  _KER_TC2_INTEN\@                            ;bit cleared, jump next (  2 clocks) 
 352               			LDI   R18                , 0x04                   ;set bit                (  1 clock ) 
 353               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 354               	    _KER_TC2_INTEN\@:                                                                          
 355               			LDI   R18                , 0x02                   ;set TOIE2 bit          (  1 clock ) 
 356               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 357               	        SEI                                               ;force enable interrupt (  1 clock ) 
 358               			#endif                                                                                 
 359               	.endm                                                                                          
 360               	;;==============================debug pin operation init end================================;; 
 361               	
 362               	
 363               	
 364               	
 365               	
 366               	;;============================debug pin operation init starting=============================;; 
 367               	;used registers          : None                                                                
 368               	;arg registers           : None                                                                
 369               	;return registers        : None                                                                
 370               	;unsafe access registers : None                                                                
 371               	.macro  KER_DEBUG_PIN_INIT                                ;total 0.5uS @8MHz      (  4 clocks) 
 372               	        #ifdef KER_DBG_ENABLE                                                                  
 373               			CBI   KER_DBG_PORT       , KER_DBG_PIN            ;clear port bit         (  2 clocks) 
 374               			SBI   KER_DBG_DDR        , KER_DBG_PIN            ;set bit in DDR         (  2 clocks) 
 375               			#endif                                                                                 
 376               	.endm                                                                                          
 377               	;;==============================debug pin operation init end================================;; 
 378               	
 379               	
 380               	
 381               	
 382               	
 383               	;;===========================debug pin operation set starting===============================;; 
 384               	;used registers          : None                                                                
 385               	;arg registers           : None                                                                
 386               	;return registers        : None                                                                
 387               	;unsafe access registers : None                                                                
 388               	.macro  KER_DEBUG_PIN_SET                                 ;total 0.25uS @8MHz     (  2 clocks) 
 389               	        #ifdef KER_DBG_ENABLE                                                                  
 390               	        SBI   KER_DBG_PORT       , KER_DBG_PIN            ;set gpio               (  2 clocks) 
 391               			#endif                                                                                 
 392               	.endm                                                                                          
 393               	;;==============================debug pin operation set end=================================;; 
 394               	
 395               	
 396               	
 397               	
 398               	
 399               	;;===========================debug pin operation clear starting=============================;; 
 400               	;used registers          : None                                                                
 401               	;arg registers           : None                                                                
 402               	;return registers        : None                                                                
 403               	;unsafe access registers : None                                                                
 404               	.macro  KER_DEBUG_PIN_CLEAR                               ;total 0.25uS @8MHz     (  2 clocks) 
 405               	        #ifdef KER_DBG_ENABLE                                                                  
 406               			CBI   KER_DBG_PORT       , KER_DBG_PIN            ;clear gpio             (  2 clocks) 
 407               			#endif                                                                                 
 408               	.endm                                                                                          
 409               	;;==============================debug pin operation clear end===============================;; 
 410               	
 411               	
 412               	
 413               	
 414               	
 415               	;;==============================reload counter value starting===============================;; 
 416               	;used registers          : R18                                                                 
 417               	;arg registers           : None                                                                
 418               	;return registers        : None                                                                
 419               	;unsafe access registers : R18                                                                 
 420               	.macro  KER_COUNTER_RELOAD                                ;total 0.5uS @8MHz      (  4 clocks) 
 421               	        #ifdef KER_TIMER0_AS_TICK_SRC                                                          
 422               	        LDS   R18                , KerBase+OFB_RLD        ;load reload value      (  2 clocks) 
 423               			STS   SRTCNT0            , R18                    ;Set value to TCNT0     (  2 clocks) 
 424               			#endif                                                                                 
 425               	.endm                                                                                          
 426               	;;=================================reload counter value end=================================;; 
 427               	
 428               	
 429               	
 430               	
 431               	
 432               	;;=================================save r0 & sreg starting==================================;; 
 433               	;used registers          : R0                                                                  
 434               	;arg registers           : None                                                                
 435               	;return registers        : None                                                                
 436               	;unsafe access registers : None                                                                
 437               	.macro  KER_SAVE_R0_SREG                                  ;total 0.63uS @8MHz     (  5 clocks) 
 438               	        PUSH  R0                                          ;save R0                (  2 clocks) 
 439               			IN    R0                 , IOSREG                 ;load SREG              (  1 clock ) 
 440               			PUSH  R0                                          ;save SREG              (  2 clocks) 
 441               	.endm                                                                                          
 442               	;;====================================save r0 & sreg end====================================;; 
 443               	
 444               	
 445               	
 446               	
 447               	
 448               	;;===============================save r0, sreg & cli starting===============================;; 
 449               	;used registers          : R0                                                                  
 450               	;arg registers           : None                                                                
 451               	;return registers        : None                                                                
 452               	;unsafe access registers : None                                                                
 453               	.macro  KER_SAVE_R0_CLI_SREG                              ;total 0.75uS @8MHz     (  6 clocks) 
 454               	        PUSH  R0                                          ;push R0                (  2 clocks) 
 455               			IN    R0                 , IOSREG                 ;save SREG              (  1 clock ) 
 456               			CLI                                               ;clear interrupt        (  1 clock ) 
 457               			PUSH  R0                                          ;save SREG              (  2 clocks) 
 458               	.endm                                                                                          
 459               	;;=================================save r0, sreg & cli end==================================;; 
 460               	
 461               	
 462               	
 463               	
 464               	
 465               	;;===================================save r1~r31 starting===================================;; 
 466               	;used registers          : R1~R31                                                              
 467               	;arg registers           : None                                                                
 468               	;return registers        : None                                                                
 469               	;unsafe access registers : None                                                                
 470               	.macro  KER_SAVE_R1_R31                                   ;total 7.88uS @8MHz     ( 63 clocks) 
 471               			PUSH  R1                                          ;save R1                (  2 clocks) 
 472               			CLR   R1                                          ;clear R1               (  1 clock ) 
 473               			PUSH  R2                                          ;save R2                (  2 clocks) 
 474               			PUSH  R3                                          ;save R3                (  2 clocks) 
 475               			PUSH  R4                                          ;save R4                (  2 clocks) 
 476               			PUSH  R5                                          ;save R5                (  2 clocks) 
 477               			PUSH  R6                                          ;save R6                (  2 clocks) 
 478               			PUSH  R7                                          ;save R7                (  2 clocks) 
 479               			PUSH  R8                                          ;save R8                (  2 clocks) 
 480               			PUSH  R9                                          ;save R9                (  2 clocks) 
 481               			PUSH  R10                                         ;save R10               (  2 clocks) 
 482               			PUSH  R11                                         ;save R11               (  2 clocks) 
 483               			PUSH  R12                                         ;save R12               (  2 clocks) 
 484               			PUSH  R13                                         ;save R13               (  2 clocks) 
 485               			PUSH  R14                                         ;save R14               (  2 clocks) 
 486               			PUSH  R15                                         ;save R15               (  2 clocks) 
 487               			PUSH  R16                                         ;save R16               (  2 clocks) 
 488               			PUSH  R17                                         ;save R17               (  2 clocks) 
 489               			PUSH  R18                                         ;save R18               (  2 clocks) 
 490               			PUSH  R19                                         ;save R19               (  2 clocks) 
 491               			PUSH  R20                                         ;save R20               (  2 clocks) 
 492               			PUSH  R21                                         ;save R21               (  2 clocks) 
 493               			PUSH  R22                                         ;save R22               (  2 clocks) 
 494               			PUSH  R23                                         ;save R23               (  2 clocks) 
 495               			PUSH  R24                                         ;save R24               (  2 clocks) 
 496               			PUSH  R25                                         ;save R25               (  2 clocks) 
 497               			PUSH  R26                                         ;save R26               (  2 clocks) 
 498               			PUSH  R27                                         ;save R27               (  2 clocks) 
 499               			PUSH  R28                                         ;save R28               (  2 clocks) 
 500               			PUSH  R29                                         ;save R29               (  2 clocks) 
 501               			PUSH  R30                                         ;save R30               (  2 clocks) 
 502               			PUSH  R31                                         ;save R31               (  2 clocks) 
 503               	.endm                                                                                          
 504               	;;======================================save r1~r31 end=====================================;; 
 505               	
 506               	
 507               	
 508               	
 509               	
 510               	;;==============================context save handler starting===============================;; 
 511               	;used registers          : R0~R31                                                              
 512               	;arg registers           : None                                                                
 513               	;return registers        : None                                                                
 514               	;unsafe access registers : None                                                                
 515               	.macro  KER_CONTEXT_SAVE_HANDLER                          ;total 8.5uS @8MHz      ( 68 clocks) 
 516               	        KER_SAVE_R0_SREG                                  ;save r0, sreg          (  5 clocks) 
 517               	        KER_SAVE_R1_R31                                   ;save r1~r31            ( 63 clocks) 
 518               	.endm                                                                                          
 519               	;;=================================context save handler end=================================;; 
 520               	
 521               	
 522               	
 523               	
 524               	
 525               	;;===============================context save thread starting===============================;; 
 526               	;used registers          : R0~R31                                                              
 527               	;arg registers           : None                                                                
 528               	;return registers        : None                                                                
 529               	;unsafe access registers : None                                                                
 530               	.macro  KER_CONTEXT_SAVE_THREAD                           ;total 8.63uS @8MHz     ( 69 clocks) 
 531               	        KER_SAVE_R0_CLI_SREG                              ;save r0, sreg          (  6 clocks) 
 532               	        KER_SAVE_R1_R31                                   ;save r1~r31            ( 63 clocks) 
 533               	.endm                                                                                          
 534               	;;==================================context save thread end=================================;; 
 535               	
 536               	
 537               	
 538               	
 539               	
 540               	
 541               	;;================================restore r0 & sreg starting================================;; 
 542               	;used registers          : R0                                                                  
 543               	;arg registers           : None                                                                
 544               	;return registers        : None                                                                
 545               	;unsafe access registers : None                                                                
 546               	.macro  KER_RESTORE_R0_SREG                               ;total 0.63uS @8MHz     (  5 clocks) 
 547               	        POP   R0                                          ;fetch SREG             (  2 clocks) 
 548               			OUT   IOSREG             , R0                     ;load SREG              (  1 clock ) 
 549               			POP   R0                                          ;restore R0             (  2 clocks) 
 550               	.endm                                                                                          
 551               	;;==================================restore r0 & sreg end===================================;; 
 552               	
 553               	
 554               	
 555               	
 556               	
 557               	;;==============================restore r0, sreg & sei starting=============================;; 
 558               	;used registers          : R0                                                                  
 559               	;arg registers           : None                                                                
 560               	;return registers        : None                                                                
 561               	;unsafe access registers : None                                                                
 562               	.macro  KER_RESTORE_R0_SREG_SEI                           ;total 0.75uS @8MHz     (  6 clocks) 
 563               	        POP   R0                                          ;fetch SREG             (  2 clocks) 
 564               			OUT   IOSREG             , R0                     ;load SREG              (  1 clock ) 
 565               			POP   R0                                          ;restore R0             (  2 clocks) 
 566               			SEI                                               ;enable interrupt       (  1 clock ) 
 567               	.endm                                                                                          
 568               	;;===============================restore r0, sreg & sei end=================================;; 
 569               	
 570               	
 571               	
 572               	
 573               	
 574               	;;=================================restore r1~r31 starting==================================;; 
 575               	;used registers          : R1~R31                                                              
 576               	;arg registers           : None                                                                
 577               	;return registers        : None                                                                
 578               	;unsafe access registers : None                                                                
 579               	.macro  KER_RESTORE_R1_R31                                ;total 8.38uS @8MHz     ( 62 clocks) 
 580               			POP   R31                                         ;restore R31            (  2 clocks) 
 581               			POP   R30                                         ;restore R30            (  2 clocks) 
 582               			POP   R29                                         ;restore R29            (  2 clocks) 
 583               			POP   R28                                         ;restore R28            (  2 clocks) 
 584               			POP   R27                                         ;restore R27            (  2 clocks) 
 585               			POP   R26                                         ;restore R26            (  2 clocks) 
 586               			POP   R25                                         ;restore R25            (  2 clocks) 
 587               			POP   R24                                         ;restore R24            (  2 clocks) 
 588               			POP   R23                                         ;restore R23            (  2 clocks) 
 589               			POP   R22                                         ;restore R22            (  2 clocks) 
 590               			POP   R21                                         ;restore R21            (  2 clocks) 
 591               			POP   R20                                         ;restore R20            (  2 clocks) 
 592               			POP   R19                                         ;restore R19            (  2 clocks) 
 593               			POP   R18                                         ;restore R18            (  2 clocks) 
 594               			POP   R17                                         ;restore R17            (  2 clocks) 
 595               			POP   R16                                         ;restore R16            (  2 clocks) 
 596               			POP   R15                                         ;restore R15            (  2 clocks) 
 597               			POP   R14                                         ;restore R14            (  2 clocks) 
 598               			POP   R13                                         ;restore R13            (  2 clocks) 
 599               			POP   R12                                         ;restore R12            (  2 clocks) 
 600               			POP   R11                                         ;restore R11            (  2 clocks) 
 601               			POP   R10                                         ;restore R10            (  2 clocks) 
 602               			POP   R9                                          ;restore R9             (  2 clocks) 
 603               			POP   R8                                          ;restore R8             (  2 clocks) 
 604               			POP   R7                                          ;restore R7             (  2 clocks) 
 605               			POP   R6                                          ;restore R6             (  2 clocks) 
 606               			POP   R5                                          ;restore R5             (  2 clocks) 
 607               			POP   R4                                          ;restore R4             (  2 clocks) 
 608               			POP   R3                                          ;restore R3             (  2 clocks) 
 609               			POP   R2                                          ;restore R2             (  2 clocks) 
 610               			POP   R1                                          ;restore R1             (  2 clocks) 
 611               	.endm                                                                                          
 612               	;;====================================restore r1~r31 end====================================;; 
 613               	
 614               	
 615               	
 616               	
 617               	
 618               	;;=============================context restore handler starting=============================;; 
 619               	;used registers          : R0~R31                                                              
 620               	;arg registers           : None                                                                
 621               	;return registers        : None                                                                
 622               	;unsafe access registers : None                                                                
 623               	.macro  KER_CONTEXT_RESTORE_HANDLER                       ;total 8.38uS @8MHz     ( 67 clocks) 
 624               	        KER_RESTORE_R1_R31                                ;restore r1~r31         ( 62 clocks) 
 625               			KER_RESTORE_R0_SREG                               ;restore r0, sreg       (  5 clocks) 
 626               	.endm                                                                                          
 627               	;;===============================context restore handler end================================;; 
 628               	
 629               	
 630               	
 631               	
 632               	
 633               	;;=============================context restore thread starting==============================;; 
 634               	;used registers          : R0~R31                                                              
 635               	;arg registers           : None                                                                
 636               	;return registers        : None                                                                
 637               	;unsafe access registers : None                                                                
 638               	.macro  KER_CONTEXT_RESTORE_THREAD                        ;total 8.75uS @8MHz     ( 68 clocks) 
 639               	        KER_RESTORE_R1_R31                                ;restore r1~r31         ( 62 clocks) 
 640               			KER_RESTORE_R0_SREG_SEI                           ;restore r0, sreg       (  6 clocks) 
 641               	.endm                                                                                          
 642               	;;================================context restore thread end================================;; 
 643               	
 644               	
 645               	
 646               	
 647               	
 648               	;;==============================fetch current task id starting==============================;; 
 649               	;used registers          : R20                                                                 
 650               	;arg registers           : None                                                                
 651               	;return registers        : R20 (Current task id)                                               
 652               	;unsafe access registers : R20                                                                 
 653               	.macro  KER_FETCH_CURR_TID                                ;total 0.25uS @8MHz     (  2 clocks) 
 654               	        LDS   R20                , KerBase+OFB_TID        ;fetch task_id          (  2 clocks) 
 655               	.endm                                                                                          
 656               	;;================================fetch current task id end=================================;; 
 657               	
 658               	
 659               	
 660               	
 661               	
 662               	;;==================================fetch ntask starting====================================;; 
 663               	;used registers          : R21                                                                 
 664               	;arg registers           : None                                                                
 665               	;return registers        : R21 (ntask)                                                         
 666               	;unsafe access registers : R21                                                                 
 667               	.macro  KER_FETCH_NTASK                                   ;total 0.25uS @8MHz     (  2 clocks) 
 668               	        LDS   R21                , KerBase+OFB_NTSK       ;fetch task_id          (  2 clocks) 
 669               	.endm                                                                                          
 670               	;;====================================fetch ntask end=======================================;; 
 671               	
 672               	
 673               	
 674               	
 675               	
 676               	;;=========================calculate offset addr in words starting==========================;; 
 677               	;used registers          : R18, R30(ZL), R31(ZH)                                               
 678               	;arg registers           : R30(ZL), R31(ZH)                                                    
 679               	;return registers        : R30(ZL), R31(ZH)                                                    
 680               	;unsafe access registers : R18, R30(ZL), R31(ZH)                                               
 681               	.macro  KER_CALC_ADDR_OFF_WORD                            ;total 0.75uS @8MHz     (  6 clocks) 
 682               	        LDS   R18                , KerBase+OFB_TID        ;fetch task_id          (  2 clocks) 
 683               			LSL   R18                                         ;left shift to multiply (  1 clock ) 
 684               			ADD   ZL                 , R18                    ;add offset to array    (  1 clock ) 
 685               			LDI   R18                , 0x00                   ;clear for carry prop   (  1 clock ) 
 686               			ADC   ZH                 , R18                    ;add carry if any       (  1 clock ) 
 687               	.endm                                                                                          
 688               	;;=============================calculate offset addr in words end===========================;; 
 689               	
 690               	
 691               	
 692               	
 693               	
 694               	;;=========================calculate offset addr in bytes starting==========================;; 
 695               	;used registers          : R18, R30(ZL), R31(ZH)                                               
 696               	;arg registers           : R30(ZL), R31(ZH)                                                    
 697               	;return registers        : R30(ZL), R31(ZH)                                                    
 698               	;unsafe access registers : R18, R30(ZL), R31(ZH)                                               
 699               	.macro  KER_CALC_ADDR_OFF_BYTES                           ;total 0.63uS @8MHz     (  5 clocks) 
 700               	        LDS   R18                , KerBase+OFB_TID        ;fetch task_id          (  2 clocks) 
 701               			ADD   ZL                 , R18                    ;add offset to array    (  1 clock ) 
 702               			LDI   R18                , 0x00                   ;clear for carry prop   (  1 clock ) 
 703               			ADC   ZH                 , R18                    ;add carry if any       (  1 clock ) 
 704               	.endm                                                                                          
 705               	;;=============================calculate offset addr in bytes end===========================;; 
 706               	
 707               	
 708               	
 709               	
 710               	
 711               	;;===============================save current task sp starting==============================;; 
 712               	;used registers          : R18, R19, R30(ZL), R31(ZH)                                          
 713               	;arg registers           : None                                                                
 714               	;return registers        : None                                                                
 715               	;unsafe access registers : R18, R19, R30(ZL), R31(ZH)                                          
 716               	.macro  KER_SAVE_CURR_TASK_SP                             ;total 1.75uS @8MHz     ( 14 clocks) 
 717               			LDI   ZL                 , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
 718               			LDI   ZH                 , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
 719               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 720               			IN    R18                , IOSPL                  ;fetch SPL0             (  1 clock ) 
 721               			IN    R19                , IOSPH                  ;fetch SPH0             (  1 clock ) 
 722               			STD   Z+0                , R18                    ;store SPL at ZP+0      (  2 clocks) 
 723               			STD   Z+1                , R19                    ;store SPH at ZP+1      (  2 clocks) 
 724               	.endm                                                                                          
 725               	;;================================save current task sp end==================================;; 
 726               	
 727               	
 728               	
 729               	
 730               	
 731               	;;==============================load next task id starting==================================;; 
 732               	;used registers          : R18, R19                                                            
 733               	;arg registers           : None                                                                
 734               	;return registers        : None                                                                
 735               	;unsafe access registers : R18, R19                                                            
 736               	.macro  KER_LOAD_NEXT_TASK_ID                             ;total 1.63uS @8MHz     ( 13 clocks) 
 737               			LDS   R18                , KerBase+OFB_TID        ;fetch task_id          (  2 clocks) 
 738               			INC   R18                                         ;increment task_id      (  1 clock ) 
 739               			LDS   R19                , KerBase+OFB_NTSK       ;load ntask             (  2 clocks) 
 740               		_MOD_CONT\@:                                          ;use local label                     
 741               		    CP    R18                , R19                    ;compare tid with ntask (  1 clock ) 
 742               			BRLO  _MOD_DONE\@                                 ;if tid<ntask, done     (  2 clocks) 
 743               			SUB   R18                , R19                    ;subtract ntask from tid(  1 clock ) 
 744               			RJMP  _MOD_CONT\@                                 ;go to loop start       (  2 clocks) 
 745               		_MOD_DONE\@:                                          ;use local label                     
 746               		    STS   KerBase+OFB_TID    , R18                    ;save task_id%ntask     (  2 clocks) 
 747               	.endm                                                                                          
 748               	;;=================================load next task id end====================================;; 
 749               	
 750               	
 751               	
 752               	
 753               	
 754               	;;==============================increment tick counter starting=============================;; 
 755               	;used registers          : R18, R19                                                            
 756               	;arg registers           : None                                                                
 757               	;return registers        : None                                                                
 758               	;unsafe access registers : R18, R19                                                            
 759               	.macro  KER_TICK_INCREMENT                                ;total 3.25uS @8MHz     ( 27 clocks) 
 760               	        LDI   R18                , 0x01                   ;load 1                 (  1 clock ) 
 761               			LDS   R19                , KerBase+OFB_TICK0      ;load Byte0             (  2 clocks) 
 762               			ADD   R19                , R18                    ;add 1 with current val (  1 clock ) 
 763               			STS   KerBase+OFB_TICK0  , R19                    ;set Byte0              (  2 clocks) 
 764               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 765               			LDS   R19                , KerBase+OFB_TICK1      ;load Byte1             (  2 clocks) 
 766               			ADC   R19                , R18                    ;add carry with Byte1   (  1 clock ) 
 767               			STS   KerBase+OFB_TICK1  , R19                    ;set Byte1              (  2 clocks) 
 768               			LDS   R19                , KerBase+OFB_TICK2      ;load Byte2             (  2 clocks) 
 769               			ADC   R19                , R18                    ;add carry with Byte2   (  1 clock ) 
 770               			STS   KerBase+OFB_TICK2  , R19                    ;set Byte2              (  2 clocks) 
 771               			LDS   R19                , KerBase+OFB_TICK3      ;load Byte3             (  2 clocks) 
 772               			ADC   R19                , R18                    ;add carry with Byte3   (  1 clock ) 
 773               			STS   KerBase+OFB_TICK3  , R19                    ;set Byte3              (  2 clocks) 
 774               			LDS   R19                , KerBase+OFB_TICK4      ;load Byte4             (  2 clocks) 
 775               			ADC   R19                , R18                    ;add carry with Byte4   (  1 clock ) 
 776               			STS   KerBase+OFB_TICK4  , R19                    ;set Byte4              (  2 clocks) 
 777               	.endm                                                                                          
 778               	;;=================================increment tick counter end===============================;; 
 779               	
 780               	
 781               	
 782               	
 783               	
 784               	;;==============================load task id & sp starting==================================;; 
 785               	;used registers          : R18, R19, R30(ZL), R31(ZH)                                          
 786               	;arg registers           : None                                                                
 787               	;return registers        : None                                                                
 788               	;unsafe access registers : R18, R19, R30(ZL), R31(ZH)                                          
 789               	.macro  KER_LOAD_TASK_ID_AND_SP                           ;total 1.75uS @8MHz     ( 14 clocks) 
 790               			LDI   ZL                 , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
 791               			LDI   ZH                 , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
 792               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 793               			LDD   R18                , Z+0                    ;load SPL at ZP         (  2 clocks) 
 794               			LDD   R19                , Z+1                    ;load SPH at ZP         (  2 clocks) 
 795               			OUT   IOSPL              , R18                    ;load SPL0              (  1 clock ) 
 796               			OUT   IOSPH              , R19                    ;load SPH0              (  1 clock ) 
 797               	.endm                                                                                          
 798               	;;=================================load task id & sp end====================================;; 
 799               	
 800               	
 801               	
 802               	
 803               	
 804               	;;================================push msp & zp starting====================================;; 
 805               	;used registers          : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 806               	;arg registers           : None                                                                
 807               	;return registers        : None                                                                
 808               	;unsafe access registers : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 809               	.macro  KER_PUSH_MSP_ZP                                   ;total 2.25uS @8MHz     ( 18 clocks) 
 810               	        LDS   XL                 , KerSSZ+OFM_MSPI+0      ;load val low           (  2 clocks) 
 811               			LDS   XH                 , KerSSZ+OFM_MSPI+1      ;load val high          (  2 clocks) 
 812               			IN    R18                , IOSPL                  ;copy                   (  1 clock ) 
 813               			IN    R19                , IOSPH                  ;copy                   (  1 clock ) 
 814               			ST    X+                 , R18                    ;store main SPL         (  2 clocks) 
 815               	        ST    X+                 , R19                    ;store main SPH         (  2 clocks) 
 816               			ST    X+                 , ZL                     ;store main ZL          (  2 clocks) 
 817               			ST    X+                 , ZH                     ;store main ZH          (  2 clocks) 
 818               			STS   KerSSZ+OFM_MSPI+0  , XL                     ;store new index        (  2 clocks) 
 819               			STS   KerSSZ+OFM_MSPI+1  , XH                     ;store new index        (  2 clocks) 
 820               	.endm                                                                                          
 821               	;;===================================push msp & zp end======================================;; 
 822               	
 823               	
 824               	
 825               	
 826               	
 827               	;;=================================pop msp & zp starting====================================;; 
 828               	;used registers          : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 829               	;arg registers           : None                                                                
 830               	;return registers        : None                                                                
 831               	;unsafe access registers : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 832               	.macro  KER_POP_MSP_ZP                                    ;total 2.25uS @8MHz     ( 18 clocks) 
 833               			LDS   XL                 , KerSSZ+OFM_MSPI+0      ;load val low           (  2 clocks) 
 834               			LDS   XH                 , KerSSZ+OFM_MSPI+1      ;load val high          (  2 clocks) 
 835               			LD    ZH                 , -X                     ;load ZH                (  2 clocks) 
 836               			LD    ZL                 , -X                     ;load ZL                (  2 clocks) 
 837               			LD    R19                , -X                     ;load main SPH          (  2 clocks) 
 838               			LD    R18                , -X                     ;load main SPL          (  2 clocks) 
 839               			OUT   IOSPL              , R18                    ;set SPL                (  1 clock ) 
 840               			OUT   IOSPH              , R19                    ;set SPH                (  1 clock ) 
 841               			STS   KerSSZ+OFM_MSPI+0  , XL                     ;store new index        (  2 clocks) 
 842               			STS   KerSSZ+OFM_MSPI+1  , XH                     ;store new index        (  2 clocks) 
 843               	.endm                                                                                          
 844               	;;====================================pop msp & zp end======================================;; 
 845               	
 846               	
 847               	
 848               	
 849               	
 850               	;;============================sleep timeout management starting=============================;; 
 851               	;used registers          : R18, R19, R20, R24, R30(ZL), R31(ZH)                                
 852               	;arg registers           : R24 (SCH_MODE_HANDLER/SCH_MODE_THREAD)                              
 853               	;return registers        : R24 (READY/BLOCKED/EXECUTING/SUSPENDED/CONS_LAT)                    
 854               	;unsafe access registers : R18, R19, R20, R24, R30(ZL), R31(ZH)                                
 855               	.macro  KER_SLP_TIME_MGNT                                 ;total 6.50uS @8MHz     ( 52 clocks) 
 856               			LDI   ZL                 , lo8(KerSchSlp)         ;fetch base pos low     (  1 clock ) 
 857               			LDI   ZH                 , hi8(KerSchSlp)         ;fetch base pos high    (  1 clock ) 
 858               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 859               			;fetch current value from ram, if val=0, skip decrement                                
 860               	        LDD   R18                , Z+0                    ;load val low byte      (  2 clocks) 
 861               			LDD   R19                , Z+1                    ;load val high byte     (  2 clocks) 
 862               			MOV   R20                , R18                    ;copy                   (  1 clock ) 
 863               			OR    R20                , R19                    ;or high & low bytes    (  1 clock ) 
 864               			BREQ  _VAL_NULL\@                                 ;val=0, save sts        (  2 clocks) 
 865               	        CPI   R24                , SCH_MODE_THREAD        ;if arg=1, thread mode  (  1 clock ) 
 866               			BREQ  _VAL_NOT_NULL\@                             ;no need to dec val     (  2 clocks) 
 867               			;R19:R18 contains 16 bit sleep timer val, decrease val by 1                            
 868               			LDI   R20                , 0x01                   ;set val 1              (  1 clock ) 
 869               	        SUB   R18                , R20                    ;subtract low byte      (  1 clock ) 
 870               			LDI   R20                , 0x00                   ;clear                  (  1 clock ) 
 871               			SBC   R19                , R20                    ;subtract carry if any  (  1 clock ) 
 872               			;store new value                                                                       
 873               			STD   Z+0                , R18                    ;store low byte         (  2 clocks) 
 874               			STD   Z+1                , R19                    ;store low byte         (  2 clocks) 
 875               			MOV   R20                , R18                    ;copy                   (  1 clock ) 
 876               			OR    R20                , R19                    ;or high & low bytes    (  1 clock ) 
 877               			BRNE  _VAL_NOT_NULL\@                             ;val!=0                 (  2 clocks) 
 878               		_VAL_NULL\@:                                                                               
 879               		    ;find ram address for status                                                           
 880               		    LDI   ZL                 , lo8(KerSchSts)         ;fetch base pos low     (  1 clock ) 
 881               			LDI   ZH                 , hi8(KerSchSts)         ;fetch base pos high    (  1 clock ) 
 882               	        KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
 883               			;update flag as task is ready                                                          
 884               			LDI   R24                , TASK_READY             ;set TASK_READY         (  1 clock ) 
 885               			ST    Z                  , R24                    ;update flag            (  2 clocks) 
 886               			RJMP  _EXIT_SLP_TIME\@                            ;jump to exit           (  2 clocks) 
 887               	    _VAL_NOT_NULL\@:                                                                           
 888               		    LDI   ZL                 , lo8(KerSchSts)         ;fetch base pos low     (  1 clock ) 
 889               			LDI   ZH                 , hi8(KerSchSts)         ;fetch base pos high    (  1 clock ) 
 890               	        KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
 891               		    LD    R24                , Z                      ;return sts             (  2 clocks) 
 892               	    _EXIT_SLP_TIME\@:                                                                          
 893               	.endm                                                                                          
 894               	;;============================sleep timeout management end==================================;; 
 895               	
 896               	
 897               	
 898               	
 899               	
 900               	;;============================current task priority starting================================;; 
 901               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 902               	;arg registers           : None                                                                
 903               	;return registers        : R24 (Current task priority)                                         
 904               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 905               	.macro  KER_CURR_TASK_PRIO                                ;total 1.13uS @8MHz     (  9 clocks) 
 906               			LDI    ZL                , lo8(KerSchPr)          ;load low addr          (  1 clock ) 
 907               			LDI    ZH                , hi8(KerSchPr)          ;load high addr         (  1 clock ) 
 908               			LDI    R18               , 0x00                   ;clear reg, for carry   (  1 clock ) 
 909               			LDS    R24               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 910               	        ADD    ZL                , R24                    ;add low addr           (  1 clock ) 
 911               			ADC    ZH                , R18                    ;add carry if any       (  1 clock ) 
 912               			LD     R24               , Z                      ;load current tid prio  (  2 clocks) 
 913               	.endm                                                                                          
 914               	;;==============================current task priority end===================================;; 
 915               	
 916               	
 917               	
 918               	
 919               	
 920               	;;================================run scheduler starting====================================;; 
 921               	;used registers          : R18, R19, R20, R21, R24, R25, R30(ZL), R31(ZH)                      
 922               	;arg registers           : R24 (SCH_MODE_HANDLER/SCH_MODE_THREAD)                              
 923               	;return registers        : None                                                                
 924               	;unsafe access registers : R18, R19, R20, R21, R24, R25, R30(ZL), R31(ZH)                      
 925               	.macro  KER_RUN_SCHEDULER                                 ;total 13.25uS @8MHz    (106 clocks) 
 926               			LDI    R18               , 0xFF                   ;set 0xff               (  1 clock ) 
 927               			STS    KerBase+OFB_LPR   , R18                    ;lowest priority        (  2 clocks) 
 928               			LDI    R18               , 0x00                   ;start from 0           (  1 clock ) 
 929               			STS    KerBase+OFB_PTID  , R18                    ;highest prio tid=0     (  2 clocks) 
 930               			MOV    R21               , R24                    ;copy sch mode          (  1 clock ) 
 931               		_KER_SCH_LOOP\@:                                                                           
 932               		    ;store task id to run from KER_DEC_SLP_TIMEOUT                                         
 933               			STS    KerBase+OFB_TID   , R18                    ;store task id          (  2 clocks) 
 934               	        ;sleep time decrement, update ready/blocked status                                     
 935               			MOV    R24               , R21                    ;restore sch mode       (  1 clock ) 
 936               			KER_SLP_TIME_MGNT                                 ;update return vars     ( 52 clocks) 
 937               	        CPI    R24               , TASK_READY             ;compare                (  1 clock ) 
 938               	        BREQ   _KER_CALC_PRIO\@                           ;calc priority if ready (  2 clocks) 
 939               			CPI    R24               , TASK_CONS_LAT          ;compare                (  1 clock ) 
 940               	        BREQ   _KER_CALC_PRIO\@                           ;calc priority if c_lat (  2 clocks) 
 941               	        RJMP   _KER_SCH_NEXT\@                            ;skip if !ready|c_lat   (  2 clocks) 
 942               		_KER_CALC_PRIO\@:                                                                          
 943               			KER_CURR_TASK_PRIO                                ;get task prio ->R24    (  9 clocks) 
 944               	        ;compare current task priority with lowest priority found so far                       
 945               			LDS    R18               , KerBase+OFB_LPR        ;load lowest priority   (  2 clocks) 
 946               			CP     R24               , R18                    ;compare                (  1 clock ) 
 947               			BRSH   _KER_SCH_NEXT\@                            ;if prio>=lowest prio   (  2 clocks) 
 948               			;found new lowest priority                                                             
 949               			STS    KerBase+OFB_LPR   , R24                    ;save lowest priority   (  2 clocks) 
 950               			LDS    R18               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 951               			STS    KerBase+OFB_PTID  , R18                    ;save lowest priority   (  2 clocks) 
 952               	                                                                                               
 953               	    _KER_SCH_NEXT\@:                                                                           
 954               		    LDS    R18               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 955               			INC    R18                                        ;increment by 1         (  1 clock ) 
 956               			LDS    R19               , KerBase+OFB_NTSK       ;load ntask             (  2 clocks) 
 957               			CP     R18               , R19                    ;compare with ntask     (  2 clocks) 
 958               			BRSH   _KER_SCH_EXIT\@                            ;if task_id>=ntask      (  2 clocks) 
 959               			RJMP   _KER_SCH_LOOP\@                            ;jump to entry          (  2 clocks) 
 960               		_KER_SCH_EXIT\@:                                                                           
 961               	        LDS    R18               , KerBase+OFB_PTID       ;load high prio task id (  2 clocks) 
 962               			STS    KerBase+OFB_TID   , R18                    ;for test only          (  2 clocks) 
 963               	.endm                                                                                          
 964               	;;===================================run scheduler end======================================;; 
 965               	
 966               	
 967               	
 968               	
 969               	
 970               	;;================================calc cpu usage starting===================================;; 
 971               	;used registers          : R18, R19                                                            
 972               	;arg registers           : None                                                                
 973               	;return registers        : None                                                                
 974               	;unsafe access registers : R18, R19                                                            
 975               	.macro  KER_CPU_USAGE                                     ;total 3.25uS @8MHz     ( 26 clocks) 
 976               	        ;check if current target task is idle task or not                                      
 977               	        LDS    R18               , KerBase+OFB_TID        ;load target task_id    (  2 clocks) 
 978               			TST    R18                                        ;check if idle task     (  1 clock ) 
 979               			BREQ   _KER_USG_TICK\@                            ;task_id=idle, skip     (  2 clocks) 
 980               			LDS    R18               , KerBase+OFB_UATC       ;load active tick cnt   (  2 clocks) 
 981               			INC    R18                                        ;inc active tick cnt    (  1 clock ) 
 982               			STS    KerBase+OFB_UATC  , R18                    ;store new val          (  2 clocks) 
 983               		_KER_USG_TICK\@:                                                                           
 984               			LDS    R18               , KerBase+OFB_UTC        ;load usage tick cnt    (  2 clocks) 
 985               			INC    R18                                        ;increment tick cnt     (  1 clock ) 
 986               			CPI    R18               , 100                    ;compare with 100       (  1 clock ) 
 987               			BRLO   _KER_USG_UTC_SV\@                          ;val<100, save new val  (  2 clocks) 
 988               			LDI    R18               , 0x00                   ;val>=100, roll back    (  1 clock ) 
 989               			LDS    R19               , KerBase+OFB_UATC       ;load active tick cnt   (  2 clocks) 
 990               			STS    KerBase+OFB_USAGE , R19                    ;store usage            (  2 clocks) 
 991               			LDI    R19               , 0x00                   ;clear reg              (  1 clock ) 
 992               			STS    KerBase+OFB_UATC  , R19                    ;clear active tick cnt  (  2 clocks) 
 993               		_KER_USG_UTC_SV\@:                                                                         
 994               			STS    KerBase+OFB_UTC   , R18                    ;store new val          (  2 clocks) 
 995               	.endm                                                                                          
 996               	;;===================================calc cpu usage end=====================================;; 
 997               	
 998               	
 999               	
 1000               	
 1001               	
 1002               	;;===========================kernel disable analog domain starting==========================;; 
 1003               	;used registers          : None                                                                
 1004               	;arg registers           : None                                                                
 1005               	;return registers        : None                                                                
 1006               	;unsafe access registers : None                                                                
 1007               	.macro KER_DISABLE_ANALOG_DOMAIN                          ;total 0.75uS @8MHz     ( 10 clocks) 
 1008               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 1009               			LDS   R18                , SRADCSRA               ;load ADCSRA            (  2 clocks) 
 1010               			ANDI  R18                , 0x7F                   ;clear ADEN             (  1 clock ) 
 1011               			STS   SRADCSRA           , R18                    ;set val                (  2 clocks) 
 1012               			LDS   R18                , SRACSR                 ;load ACSR              (  2 clocks) 
 1013               			ORI   R18                , 0x80                   ;set ACD                (  1 clock ) 
 1014               			STS   SRACSR             , R18                    ;set val                (  2 clocks) 
 1015               		#endif                                                                                     
 1016               	.endm                                                                                          
 1017               	;;=============================kernel disable analog domain end=============================;; 
 1018               	
 1019               	
 1020               	
 1021               	
 1022               	
 1023               	;;===============================kernel sleep config starting===============================;; 
 1024               	;used registers          : R18                                                                 
 1025               	;arg registers           : None                                                                
 1026               	;return registers        : None                                                                
 1027               	;unsafe access registers : R18                                                                 
 1028               	.macro KER_SLEEP_INIT                                     ;total 0.63uS @8MHz     (  5 clocks) 
 1029               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 1030               	        #ifdef KER_SLEEP_MODE_IDLE                                                             
 1031               			LDI   R18                , 0x00                   ;set SM[2:0] val        (  1 clock ) 
 1032               			#endif                                                                                 
 1033               	                                                                                               
 1034               			#ifdef KER_SLEEP_MODE_ADC_NR                                                           
 1035               			LDI   R18                , 0x02                   ;set SM[2:0] val        (  1 clock ) 
 1036               			#endif
 1037               	                                                                                               
 1038               			#ifdef KER_SLEEP_MODE_POWER_DOWN                                                       
 1039               			LDI   R18                , 0x04                   ;set SM[2:0] val        (  1 clock ) 
 1040               	        #endif                                                                                 
 1041               			                                                                                       
 1042               			#ifdef KER_SLEEP_MODE_POWER_SAVE                                                       
 1043               			LDI   R18                , 0x06                   ;set SM[2:0] val        (  1 clock ) 
 1044               			#endif                                                                                 
 1045               		                                                                                           
 1046               			STS   SRSMCR             , R18                    ;set sleep control val  (  2 clocks) 
 1047               			STS   KerBase+OFB_SLCFG  , R18                    ;save sleep control val (  2 clocks) 
 1048               		#endif                                                                                     
 1049               	.endm                                                                                          
 1050               	;;================================kernel sleep config end===================================;; 
 1051               	
 1052               	
 1053               	
 1054               	
 1055               	
 1056               	;;==============================kernel enter sleep mode starting============================;; 
 1057               	;used registers          : None                                                                
 1058               	;arg registers           : None                                                                
 1059               	;return registers        : None                                                                
 1060               	;unsafe access registers : None                                                                
 1061               	.macro KER_ENTER_SLEEP                                    ;total 0.75uS @8MHz     (  6 clocks) 
 1062               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 1063               			LDS   R18                , SRSMCR                 ;load SMCR              (  2 clocks) 
 1064               			ORI   R18                , 0x01                   ;set SE bit             (  1 clock ) 
 1065               			STS   SRSMCR             , R18                    ;set val                (  2 clocks) 
 1066               			SLEEP                                             ;sleep cpu              (  1 clock ) 
 1067               		#endif                                                                                     
 1068               	.endm                                                                                          
 1069               	;;================================kernel enter sleep mode end===============================;; 
 1070               	
 1071               	
 1072               	
 1073               	
 1074               	
 1075               	;;===============================kernel exit sleep mode starting============================;; 
 1076               	;used registers          : None                                                                
 1077               	;arg registers           : None                                                                
 1078               	;return registers        : None                                                                
 1079               	;unsafe access registers : None                                                                
 1080               	.macro KER_EXIT_SLEEP                                     ;total 0.63uS @8MHz     (  5 clocks) 
 1081               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 1082               	        LDS   R18                , SRSMCR                 ;load SMCR              (  2 clocks) 
 1083               			ANDI  R18                , 0xFE                   ;clear SE bit           (  1 clock ) 
 1084               			STS   SRSMCR             , R18                    ;set val                (  2 clocks) 
 1085               		#endif                                                                                     
 1086               	.endm                                                                                          
 1087               	;;=================================kernel exit sleep mode end===============================;; 
 1088               	
 1089               	
 1090               	
 1091               	
 1092               	
 1093               	;;=================================ISR execution starting===================================;; 
 1094               	#ifdef  KER_WDT_AS_TICK_SRC                                                                    
 1095               	.global  __vector_6                                                                            
 1096               	    __vector_6:                                           ;total 40.00uS @8MHz    (344 clocks) 
 1097               		    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
 1098               			KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
 1099               	        KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1100               			KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1101               			KER_COUNTER_RELOAD                                ;counter reload         (  4 clocks) 
 1102               			KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
 1103               			LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
 1104               			KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
 1105               			KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
 1106               			KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
 1107               			KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
 1108               		    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
 1109               			LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
 1110               			ORI   R18                , 0x40                   ;set WDIE               (  1 clock ) 
 1111               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 1112               			RETI                                              ;return from interrupt  (  4 clocks) 
 1113               	#endif                                                                                         
 1114               	
 1115               	#ifdef  KER_TOSC_AS_TICK_SRC                                                                   
 1116               	.global  __vector_7                                                                            
 1117               	    __vector_7:                                           ;total 40.00uS @8MHz    (344 clocks) 
1118:kernel.S      **** 	    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
1119:kernel.S      **** 		KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
1120:kernel.S      ****         KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
1121:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
1122:kernel.S      **** 		KER_COUNTER_RELOAD                                ;counter reload         (  4 clocks) 
1123:kernel.S      **** 		KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
1124:kernel.S      **** 		LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
1125:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1126:kernel.S      **** 		KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
1127:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1128:kernel.S      **** 		KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
1129:kernel.S      **** 	    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
1130:kernel.S      **** 		RETI                                              ;return from interrupt  (  4 clocks) 
 1131               	.global  __vector_9                                                                            
 1132               	    __vector_9:                                           ;total 40.00uS @8MHz    (344 clocks) 
1133:kernel.S      **** 	    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
1134:kernel.S      **** 		KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
1135:kernel.S      ****         KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
1136:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
1137:kernel.S      **** 		KER_COUNTER_RELOAD                                ;counter reload         (  4 clocks) 
1138:kernel.S      **** 		KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
1139:kernel.S      **** 		LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
1140:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1141:kernel.S      **** 		KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
1142:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1143:kernel.S      **** 		KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
1144:kernel.S      **** 	    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
1145:kernel.S      **** 		RETI                                              ;return from interrupt  (  4 clocks) 
 1146               	#endif                                                                                         
 1147               	
 1148               	#ifdef  KER_TIMER0_AS_TICK_SRC                                                                 
 1149               	.global  __vector_16                                                                           
 1150               	    __vector_16:                                          ;total 40.00uS @8MHz    (339 clocks) 
 1151               		    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
 1152               			KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
 1153               	        KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1154               			KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1155               			KER_COUNTER_RELOAD                                ;counter reload         (  4 clocks) 
 1156               			KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
 1157               			LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
 1158               			KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
 1159               			KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
 1160               			KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
 1161               			KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
 1162               		    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
 1163               			RETI                                              ;return from interrupt  (  4 clocks) 
 1164               	#endif                                                                                         
 1165               	;;====================================ISR execution end=====================================;; 
 1166               	
 1167               	
 1168               	
 1169               	
 1170               	
 1171               	;;================================SysTick reg init starting=================================;; 
 1172               	;used registers          : R18, R19, R22, R24, R26(XL), R27(XH), R30(ZL), R31(ZH)              
 1173               	;arg registers           : R24(Prescaler), R22(ReloadVal)                                      
 1174               	;return registers        : None                                                                
 1175               	;unsafe access registers : R18, R19, R22, R24, R26(XL), R27(XH), R30(ZL), R31(ZH)              
 1176               	Kernel_Tick_Init:                                         ;total 11.50uS @8MHz    ( 92 clocks) 
1177:kernel.S      ****         CLI                                               ;disable global int     (  1 clock ) 
1178:kernel.S      **** 		KER_DEBUG_PIN_INIT                                ;debug pin init         (  4 clocks) 
1179:kernel.S      ****         KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1180               			;clear reg                                                                             
1181:kernel.S      **** 		LDI   R18                , 0x00                   ;set 0x00 to R18        (  1 clock ) 
 1182               			;clear tick counter                                                                    
1183:kernel.S      **** 		STS   KerBase+OFB_TICK0  , R18                    ;clear  KerBase[0]      (  2 clocks) 
1184:kernel.S      **** 		STS   KerBase+OFB_TICK1  , R18                    ;clear  KerBase[1]      (  2 clocks) 
1185:kernel.S      **** 		STS   KerBase+OFB_TICK2  , R18                    ;clear  KerBase[2]      (  2 clocks) 
1186:kernel.S      **** 		STS   KerBase+OFB_TICK3  , R18                    ;clear  KerBase[3]      (  2 clocks) 
1187:kernel.S      **** 		STS   KerBase+OFB_TICK4  , R18                    ;clear  KerBase[4]      (  2 clocks) 
 1188               			;clear system registers                                                                
1189:kernel.S      **** 		STS   KerBase+OFB_PRS    , R18                    ;clear  KerBase[5]      (  2 clocks) 
1190:kernel.S      **** 		STS   KerBase+OFB_RLD    , R18                    ;clear  KerBase[6]      (  2 clocks) 
1191:kernel.S      **** 		STS   KerBase+OFB_TID    , R18                    ;clear  KerBase[7]      (  2 clocks) 
1192:kernel.S      **** 		STS   KerBase+OFB_NTSK   , R18                    ;clear  KerBase[8]      (  2 clocks) 
1193:kernel.S      **** 		STS   KerBase+OFB_LPR    , R18                    ;clear  KerBase[9]      (  2 clocks) 
1194:kernel.S      ****         STS   KerBase+OFB_PTID   , R18                    ;clear  KerBase[10]     (  2 clocks) 
1195:kernel.S      **** 		STS   KerBase+OFB_UTC    , R18                    ;clear  KerBase[11]     (  2 clocks) 
1196:kernel.S      **** 		STS   KerBase+OFB_UATC   , R18                    ;clear  KerBase[12]     (  2 clocks) 
1197:kernel.S      **** 		STS   KerBase+OFB_USAGE  , R18                    ;clear  KerBase[13]     (  2 clocks) 
 1198               			;clear all timer registers                                                             
 1199               			#ifdef KER_TIMER0_AS_TICK_SRC                                                          
1200:kernel.S      **** 		STS   SRTCCR0A           , R18                    ;clear TCCR0A           (  2 clocks) 
1201:kernel.S      **** 		STS   SRTCCR0B           , R18                    ;clear TCCR0B           (  2 clocks) 
1202:kernel.S      **** 		STS   SRTIMSK0           , R18                    ;clear TIMSK0           (  2 clocks) 
1203:kernel.S      **** 		STS   SRTIFR0            , R18                    ;clear TIFR0            (  2 clocks) 
1204:kernel.S      **** 		STS   SROCR0A            , R18                    ;clear OCR0A            (  2 clocks) 
1205:kernel.S      **** 		STS   SROCR0B            , R18                    ;clear OCR0B            (  2 clocks) 
1206:kernel.S      **** 		STS   SRTCNT0            , R18                    ;clear TCNT0            (  2 clocks) 
1207:kernel.S      **** 		#endif                                                                                 
1208:kernel.S      ****         #ifdef KER_WDT_AS_TICK_SRC                                                             
1209:kernel.S      **** 		WDR                                               ;reset wdt              (  1 clock ) 
1210:kernel.S      **** 		LDS   R18                , SRMCUSR                ;copy MCUSR             (  1 clock ) 
1211:kernel.S      **** 		ANDI  R18                , 0xFF & (0<<WDRF)       ;clear WDRF             (  1 clock ) 
1212:kernel.S      **** 		STS   SRMCUSR            , R18                    ;set val                (  1 clock ) 
1213:kernel.S      **** 		LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
1214:kernel.S      **** 		ORI   R18                , 0x18                   ;set WDCE,WDE           (  1 clock ) 
1215:kernel.S      **** 		STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
1216:kernel.S      **** 		LDI   R18                , 0x00                   ;clear WDE              (  1 clock ) 
1217:kernel.S      **** 		STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
1218:kernel.S      **** 		#endif                                                                                 
1219:kernel.S      **** 		#ifdef KER_TOSC_AS_TICK_SRC                                                            
1220:kernel.S      ****         LDI   R18                , 0x00                   ;clear interrupt enbits (  1 clock ) 
1221:kernel.S      **** 		STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
1222:kernel.S      **** 		LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
1223:kernel.S      **** 		STS   SRTCCR2B           , R18                    ;set val to TCCR2B      (  2 clocks) 
1224:kernel.S      **** 		LDI   R18                , 0x00                   ;clear AS2 bit          (  1 clock ) 
1225:kernel.S      **** 		STS   SRASSR             , R18                    ;set val to ASSR        (  2 clocks) 
 1226               			#endif                                                                                 
 1227               			;save values for future use                                                            
1228:kernel.S      **** 		STS   KerBase+OFB_PRS    , R24                    ;KerBase[5] prescaler   (  2 clocks) 
1229:kernel.S      **** 		STS   KerBase+OFB_RLD    , R22                    ;KerBase[6] reload val  (  2 clocks) 
1230:kernel.S      ****         KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
1231:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1232               	;;===================================SysTick reg init end===================================;; 
 1233               	
 1234               	
 1235               	
 1236               	
 1237               	
 1238               	;;===============================kernel task create starting================================;; 
 1239               	;used registers          : R18, R19, R20, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)    
 1240               	;arg registers           : R25:R24(FuncPtr), R22(TaskPriority)                                 
 1241               	;return registers        : None                                                                
 1242               	;unsafe access registers : R18, R19, R20, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)    
 1243               	Kernel_Task_Create:                                       ;total 21.50uS @8MHz    (172 clocks) 
1244:kernel.S      ****         KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1245               			;set priority to KerSchPr+task_id                                                      
1246:kernel.S      **** 		LDI   ZL                 , lo8(KerSchPr)          ;load low byte          (  1 clock ) 
1247:kernel.S      **** 		LDI   ZH                 , hi8(KerSchPr)          ;load high byte         (  1 clock ) 
1248:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
1249:kernel.S      **** 		ST    Z                  , R22                    ;save priority          (  2 clocks) 
 1250               			;set task status to KerSchSts+task_id                                                  
1251:kernel.S      **** 		LDI   ZL                 , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1252:kernel.S      **** 		LDI   ZH                 , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1253:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
1254:kernel.S      **** 		LDI   R18                , TASK_READY             ;set status as ready    (  1 clock ) 
1255:kernel.S      **** 		ST    Z                  , R18                    ;save status            (  2 clocks) 
 1256               			;stack pointer for current task (KerStack + KER_STK_SZ*(task_id+1) - 1) ->stack top    
1257:kernel.S      **** 		LDS   R18                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1258:kernel.S      **** 		INC   R18                                         ;increment task_id      (  1 clock ) 
1259:kernel.S      **** 		LDI   R19                , KER_STK_SZ             ;load stack size        (  1 clock ) 
1260:kernel.S      **** 		MUL   R18                , R19                    ;multiply to get offset (  2 clocks) 
1261:kernel.S      **** 		MOV   ZL                 , R0                     ;load multiplied low    (  1 clocks) 
1262:kernel.S      **** 		MOV   ZH                 , R1                     ;load multiplied high   (  1 clocks) 
1263:kernel.S      **** 		SBIW  ZL                 , 0x01                   ;dec multiplied val-1   (  2 clocks) 
1264:kernel.S      **** 		CLR   R1                                          ;gcc expects cleared    (  1 clock ) 
1265:kernel.S      **** 		LDI   R18                , lo8(KerStack)          ;load base addr low     (  1 clock ) 
1266:kernel.S      **** 		LDI   R19                , hi8(KerStack)          ;load base addr high    (  1 clock ) 
1267:kernel.S      **** 		ADD   ZL                 , R18                    ;add low bytes          (  1 clock ) 
1268:kernel.S      **** 		ADC   ZH                 , R19                    ;add high bytes+carry   (  1 clock ) 
1269:kernel.S      **** 		OUT   IOSPL              , ZL                     ;load SPL               (  1 clock ) 
1270:kernel.S      ****         OUT   IOSPH              , ZH                     ;load SPH               (  1 clock ) 
 1271               			;function argument directly returns word address                                       
1272:kernel.S      **** 	    PUSH  R24                                         ;push word addr low     (  2 clocks) 
1273:kernel.S      **** 		PUSH  R25                                         ;push word addr high    (  2 clocks) 
 1274               			;push context to stack of this task                                                    
1275:kernel.S      **** 		KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1276               			;read stack pointer of current task (necessary when restore)                           
1277:kernel.S      **** 		IN    R18                , IOSPL                  ;read SPL               (  1 clock ) 
1278:kernel.S      ****         IN    R19                , IOSPH                  ;read SPH               (  1 clock ) 
 1279               			;calculate the address where current task's SP will be stored and store SP             
1280:kernel.S      **** 		LDS   R20                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1281:kernel.S      **** 		LSL   R20                                         ;left shift to multiply (  1 clock ) 
1282:kernel.S      **** 		LDI   ZL                 , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
1283:kernel.S      **** 		LDI   ZH                 , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
1284:kernel.S      **** 		ADD   ZL                 , R20                    ;add offset to array    (  1 clock ) 
1285:kernel.S      **** 		LDI   R20                , 0x00                   ;clear reg              (  1 clock ) 
1286:kernel.S      **** 		ADC   ZH                 , R20                    ;add carry if any       (  1 clock ) 
1287:kernel.S      **** 		ST    Z+                 , R18                    ;SPL at KerPSp+offset   (  2 clocks) 
1288:kernel.S      **** 		ST    Z                  , R19                    ;SPH at KerPSp+offset   (  2 clocks) 
 1289               			;increment task_id                                                                     
1290:kernel.S      **** 		LDS   R18                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1291:kernel.S      **** 		INC   R18                                         ;increment task_id      (  1 clock ) 
1292:kernel.S      **** 		STS   KerBase+OFB_TID    , R18                    ;store task_id          (  2 clocks) 
 1293               			;increment ntask                                                                       
1294:kernel.S      **** 		LDS   R18                , KerBase+OFB_NTSK       ;load ntask             (  2 clocks) 
1295:kernel.S      **** 		INC   R18                                         ;increment ntask        (  1 clock ) 
1296:kernel.S      **** 		STS   KerBase+OFB_NTSK   , R18                    ;store ntask            (  2 clocks) 
1297:kernel.S      **** 		KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
1298:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1299               	;;==================================kernel task create end==================================;; 
 1300               	
 1301               	
 1302               	
 1303               	
 1304               	
 1305               	;;=================================kernel start tasks starting==============================;; 
 1306               	;used registers          : R0~R31                                                              
 1307               	;arg registers           : None                                                                
 1308               	;return registers        : None                                                                
 1309               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1310               	Kernel_Start_Tasks:                                       ;total 25.63uS @8MHz    (205 clocks) 
1311:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1312:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1313:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1314:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
 1315               			;config timer for system tick                                                          
1316:kernel.S      **** 		KER_TIMER_INIT                                    ;init timer, int enable ( 12 clocks) 
 1317               			;execute return to jump to highest priority task                                       
1318:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1319               	;;==================================kernel start tasks end==================================;; 
 1320               	
 1321               	
 1322               	
 1323               	
 1324               	
 1325               	;;===================================kernel init starting===================================;; 
 1326               	;used registers          : R1, R18, R19, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)     
 1327               	;arg registers           : None                                                                
 1328               	;return registers        : None                                                                
 1329               	;unsafe access registers : R1, R18, R19, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)     
 1330               	Kernel_Init:                                              ;total 39.75uS @8MHz    (318 clocks) 
1331:kernel.S      **** 		CLR   R1                                          ;gcc expects            (  1 clock ) 
 1332               	        ;store stack top (for MSP) addr to KerSSZ+OFM_MSPI0:1                                  
1333:kernel.S      **** 		LDI   R18                , lo8(KerSSZ+OFM_MSPS)   ;load low address       (  1 clock ) 
1334:kernel.S      **** 		LDI   R19                , hi8(KerSSZ+OFM_MSPS)   ;load high address      (  1 clock ) 
1335:kernel.S      ****         STS   KerSSZ+OFM_MSPI+0  , R18                    ;set mspi to stack top  (  2 clocks) 
1336:kernel.S      **** 		STS   KerSSZ+OFM_MSPI+1  , R19                    ;set mspi to stack top  (  2 clocks) 
1337:kernel.S      **** 		KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1338               			;init timer for kernel                                                                 
1339:kernel.S      **** 		LDI   R24                , 0x03                   ;set prescaler          (  1 clock ) 
1340:kernel.S      **** 		LDI   R22                , 0x82                   ;set reload val         (  1 clock ) 
1341:kernel.S      **** 		CALL  Kernel_Tick_Init                            ;init timer             ( 92 clocks) 
 1342               			;create idle task at task_id 0, priority 0xFF (lowest)                                 
1343:kernel.S      **** 		LDI   R24                , lo8(Kernel_Task_Idle)  ;load func addr low     (  1 clock ) 
1344:kernel.S      **** 		LDI   R25                , hi8(Kernel_Task_Idle)  ;load func addr high    (  1 clock ) 
1345:kernel.S      **** 		LSR   R25                                         ;right shift to divide  (  1 clock ) 
1346:kernel.S      **** 		ROR   R24                                         ;rotate right th carry  (  1 clock ) 
1347:kernel.S      **** 		LDI   R22                , 0xFF                   ;set max val            (  1 clock ) 
1348:kernel.S      **** 		CALL  Kernel_Task_Create                          ;init idle task         (172 clocks) 
1349:kernel.S      **** 		KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
 1350               			;execute return to jump to task0, pushed while task init                               
1351:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1352               	;;======================================kernel init end=====================================;; 
 1353               	
 1354               	
 1355               	
 1356               	
 1357               	
 1358               	;;=================================kernel idle task starting================================;; 
 1359               	;used registers          : None                                                                
 1360               	;arg registers           : None                                                                
 1361               	;return registers        : None                                                                
 1362               	;unsafe access registers : None                                                                
 1363               	Kernel_Task_Idle:                                                                              
1364:kernel.S      **** 	    KER_SLEEP_INIT                                    ;sleep init             (  5 clocks) 
 1365               	    _IDLE_LOOP:                                           ;forever loop                        
1366:kernel.S      **** 	    KER_DISABLE_ANALOG_DOMAIN                         ;disable adc, ac        ( 10 clocks) 
 1367               			#ifdef KER_CALL_FUNC_BEFORE_SLEEP                                                      
 1368               			CALL  Kernel_PreSleep_Hook                        ;call func before sleep (  8 clocks) 
 1369               			#endif                                                                                 
1370:kernel.S      **** 	    KER_ENTER_SLEEP                                   ;enter sleep mode       (  6 clocks) 
1371:kernel.S      **** 		JMP   _IDLE_LOOP                                  ;jump to loop start     (  2 clocks) 
 1372               	;;==================================kernel idle task end====================================;; 
 1373               	
 1374               	
 1375               	
 1376               	
 1377               	
 1378               	;;================================kernel task sleep starting================================;; 
 1379               	;used registers          : R0~R31                                                              
 1380               	;arg registers           : R25:R24(SleepTime)                                                  
 1381               	;return registers        : None                                                                
 1382               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1383               	Kernel_Task_Sleep:                                        ;total 37.25uS @8MHz    (298 clocks) 
 1384               	        ;save current context                                                                  
1385:kernel.S      ****         KER_CONTEXT_SAVE_THREAD                           ;save context           ( 69 clocks) 
1386:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1387               			;create next task wakeup time (args R25:R24)                                           
1388:kernel.S      **** 		LDI   ZL                 , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1389:kernel.S      **** 		LDI   ZH                 , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1390:kernel.S      **** 		KER_CALC_ADDR_OFF_WORD                            ;offset calc            (  6 clocks) 
1391:kernel.S      **** 		STD   Z+0                , R24                    ;save sleep time low    (  2 clocks) 
1392:kernel.S      **** 		STD   Z+1                , R25                    ;save sleep time high   (  2 clocks) 
 1393               			;update task scheduler status as blocked                                               
1394:kernel.S      **** 		LDI   ZL                 , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1395:kernel.S      **** 		LDI   ZH                 , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1396:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1397:kernel.S      ****         LDI   R18                , TASK_BLOCKED           ;block task until cnt=0 (  1 clock ) 
1398:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
 1399               			;run scheduler, load next task sp, restore context                                     
1400:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1401:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1402:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1403:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
1404:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1405               	;;=================================kernel task sleep end====================================;; 
 1406               	
 1407               	
 1408               	
 1409               	
 1410               	
 1411               	;;========================kernel task constant latency starting=============================;; 
 1412               	;used registers          : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1413               	;arg registers           : R25:R24(SleepTime)                                                  
 1414               	;return registers        : None                                                                
 1415               	;unsafe access registers : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1416               	Kernel_Task_Constant_Latency:                             ;total 3.50uS @8MHz     ( 28 clocks) 
 1417               			;create next task wakeup time (args R25:R24)                                           
1418:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock ) 
1419:kernel.S      **** 		LDI   ZL                 , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1420:kernel.S      **** 		LDI   ZH                 , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1421:kernel.S      **** 		KER_CALC_ADDR_OFF_WORD                            ;offset calc            (  6 clocks) 
1422:kernel.S      **** 		STD   Z+0                , R24                    ;save sleep time low    (  2 clocks) 
1423:kernel.S      **** 		STD   Z+1                , R25                    ;save sleep time high   (  2 clocks) 
 1424               			;update task scheduler status as constant latency                                      
1425:kernel.S      **** 		LDI   ZL                 , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1426:kernel.S      **** 		LDI   ZH                 , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1427:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1428:kernel.S      ****         LDI   R18                , TASK_CONS_LAT          ;save as cons_lat       (  1 clock ) 
1429:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
1430:kernel.S      **** 		SEI                                               ;enable interrupt       (  1 clock ) 
1431:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1432               	;;=============================kernel task constant latency end=============================;; 
 1433               	
 1434               	
 1435               	
 1436               	
 1437               	
 1438               	;;=======================kernel task constant latency sleep starting========================;; 
 1439               	;used registers          : R0~R31                                                              
 1440               	;arg registers           : R25:R24(SleepTime)                                                  
 1441               	;return registers        : None                                                                
 1442               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1443               	Kernel_Task_Constant_Latency_Sleep:                       ;total 35.75uS @8MHz    (286 clocks) 
 1444               			;save current context                                                                  
1445:kernel.S      ****         KER_CONTEXT_SAVE_THREAD                           ;save context           ( 69 clocks) 
1446:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1447               			;update task scheduler status as blocked                                               
1448:kernel.S      **** 		LDI   ZL                 , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1449:kernel.S      **** 		LDI   ZH                 , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1450:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1451:kernel.S      ****         LDI   R18                , TASK_BLOCKED           ;blocked until cnt=0    (  1 clock ) 
1452:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
 1453               			;run scheduler, load next task sp, restore context                                     
1454:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1455:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1456:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1457:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
1458:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1459               	;;=============================kernel task constant latency end=============================;; 
 1460               	
 1461               	
 1462               	
 1463               	
 1464               	
 1465               	;;=========================kernel call func before sleep starting===========================;; 
 1466               	;used registers          : R24, R25, R30(ZL), R31(ZH)                                          
 1467               	;arg registers           : R25:R24(FunctionPtr)                                                
 1468               	;return registers        : None                                                                
 1469               	;unsafe access registers : R24, R25, R30(ZL), R31(ZH)                                          
 1470               	Kernel_PreSleep_Hook:                                     ;total 1.00uS @8MHz     (  8 clocks) 
1471:kernel.S      ****         MOVW  R30                , R24                    ;move pointer to Z      (  1 clock ) 
1472:kernel.S      **** 		ICALL                                             ;indirect call          (  3 clocks) 
1473:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1474               	;;============================kernel call func before sleep end=============================;; 
 1475               	
 1476               	
 1477               	
 1478               	
 1479               	
 1480               	;;========================kernel main clock prescaler set starting==========================;; 
 1481               	;used registers          : R18, R24                                                            
 1482               	;arg registers           : R24(prescaler reg val)                                              
 1483               	;return registers        : None                                                                
 1484               	;unsafe access registers : R18, R24                                                            
 1485               	Kernel_Clock_Prescale:                                    ;total 1.75uS @8MHz     ( 14 clocks) 
1486:kernel.S      ****         LDS   R18                , SRSREG                 ;load sreg              (  2 clocks)
1487:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock )
1488:kernel.S      **** 		LDI   R19                , 0x80                   ;set CLKPCE             (  1 clock ) 
1489:kernel.S      **** 		STS   SRCLKPR            , R19                    ;store val              (  2 clocks) 
1490:kernel.S      **** 		STS   SRCLKPR            , R24                    ;store val              (  2 clocks)
1491:kernel.S      ****         STS   SRSREG             , R18                    ;store val              (  2 clocks) 
1492:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1493               	;;==========================kernel main clock prescaler set end=============================;; 
 1494               	
 1495               	
 1496               	
 1497               	
 1498               	
 1499               	;;===========================kernel task sleep time get starting============================;; 
 1500               	;used registers          : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1501               	;arg registers           : R24(TaskID)                                                         
 1502               	;return registers        : R25:R24(SleepTime)                                                  
 1503               	;unsafe access registers : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1504               	Kernel_Task_Sleep_Time_Get:                               ;total 1.88uS @8MHz     ( 15 clocks) 
1505:kernel.S      **** 		MOV   R18                , R24                    ;copy                   (  1 clock ) 
1506:kernel.S      **** 		LSL   R18                                         ;x2                     (  1 clock ) 
1507:kernel.S      **** 		LDI   ZL                 , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1508:kernel.S      **** 		LDI   ZH                 , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1509:kernel.S      **** 		ADD   ZL                 , R18                    ;add low bytes          (  1 clock ) 
1510:kernel.S      **** 		LDI   R18                , 0x00                   ;load 0                 (  1 clock ) 
1511:kernel.S      **** 		ADC   ZH                 , R18                    ;add high byte+carry    (  1 clock ) 
1512:kernel.S      **** 		LDD   R24                , Z+0                    ;load sleep time        (  2 clocks) 
1513:kernel.S      **** 		LDD   R25                , Z+1                    ;load sleep time        (  2 clocks) 
1514:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1515               	;;==============================kernel task sleep time get end==============================;; 
 1516               	
 1517               	
 1518               	
 1519               	
 1520               	
 1521               	;;==============================kernel task status get starting=============================;; 
 1522               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 1523               	;arg registers           : R24(TaskID)                                                         
 1524               	;return registers        : R24(TaskSts)                                                        
 1525               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 1526               	Kernel_Task_Status_Get:                                   ;total 1.50uS @8MHz     ( 12 clocks) 
1527:kernel.S      **** 		MOV   R18                , R24                    ;copy                   (  1 clock ) 
1528:kernel.S      **** 		LDI   ZL                 , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1529:kernel.S      **** 		LDI   ZH                 , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1530:kernel.S      **** 		ADD   ZL                 , R18                    ;add low bytes          (  1 clock ) 
1531:kernel.S      **** 		LDI   R18                , 0x00                   ;load 0                 (  1 clock ) 
1532:kernel.S      **** 		ADC   ZH                 , R18                    ;add high byte+carry    (  1 clock ) 
1533:kernel.S      **** 		LD    R24                , Z                      ;load task status       (  2 clocks) 
1534:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1535               	;;================================kernel task status get end================================;; 
 1536               	
 1537               	
 1538               	
 1539               	
 1540               	
 1541               	;;================================kernel ntask get starting=================================;; 
 1542               	;used registers          : R24                                                                 
 1543               	;arg registers           : None                                                                
 1544               	;return registers        : R24(NTask)                                                          
 1545               	;unsafe access registers : R24                                                                 
 1546               	Kernel_NTask_Get:                                         ;total 0.75uS @8MHz     (  6 clocks) 
1547:kernel.S      **** 		LDS   R24                 , KerBase+OFB_NTSK      ;load ntask             (  2 clock ) 
1548:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1549               	;;===================================kernel ntask get end===================================;; 
 1550               	
 1551               	
 1552               	
 1553               	
 1554               	
 1555               	;;=============================kernel task priority get starting============================;; 
 1556               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 1557               	;arg registers           : R24(TaskID)                                                         
 1558               	;return registers        : R24(TaskPriority)                                                   
 1559               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 1560               	Kernel_Task_Prio_Get:                                     ;total 1.50uS @8MHz     ( 12 clocks) 
 1561               			;get priority of the task id, arg (task_id->R24), return R24                           
1562:kernel.S      **** 		MOV   R18                , R24                    ;copy task_id           (  1 clock ) 
1563:kernel.S      **** 		LDI   ZL                 , lo8(KerSchPr)          ;load low byte          (  1 clock ) 
1564:kernel.S      **** 		LDI   ZH                 , hi8(KerSchPr)          ;load high byte         (  1 clock ) 
1565:kernel.S      **** 		ADD   ZL                 , R18                    ;add low bytes          (  1 clock ) 
1566:kernel.S      **** 		LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
1567:kernel.S      **** 		ADC   ZH                 , R18                    ;add high byte+carry    (  1 clock ) 
1568:kernel.S      **** 		LD    R24                , Z                      ;load priority          (  2 clocks) 
1569:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1570               	;;================================kernel task priority get end==============================;; 
 1571               	
 1572               	
 1573               	
 1574               	
 1575               	
 1576               	;;============================kernel lowest priority get starting===========================;; 
 1577               	;used registers          : R24                                                                 
 1578               	;arg registers           : None                                                                
 1579               	;return registers        : R24(LowestPriorityVal)                                              
 1580               	;unsafe access registers : R24                                                                 
 1581               	Kernel_Lowest_Prio_Get:                                   ;total 0.75uS @8MHz     (  6 clocks) 
1582:kernel.S      **** 		LDS   R24                , KerBase+OFB_LPR        ;load lowest priority   (  2 clocks) 
1583:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1584               	;;===============================kernel lowest priority get end=============================;; 
 1585               	
 1586               	
 1587               	
 1588               	
 1589               	
 1590               	;;===========================kernel high priority task id starting==========================;; 
 1591               	;used registers          : R24                                                                 
 1592               	;arg registers           : None                                                                
 1593               	;return registers        : R24(HighstPriorityTaskID)->UserTaskID (Excluding Idle Task)         
 1594               	;unsafe access registers : R24                                                                 
 1595               	Kernel_High_Prio_Task_ID_Get:                             ;total 0.88uS @8MHz     (  7 clocks) 
1596:kernel.S      **** 		LDS   R24                , KerBase+OFB_PTID       ;load priority tak_id   (  2 clocks) 
1597:kernel.S      **** 		DEC   R24                                         ;decrement by 1         (  1 clock ) 
1598:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1599               	;;==============================kernel high priority task id end============================;; 
 1600               	
 1601               	
 1602               	
 1603               	
 1604               	
 1605               	;;=========================kernel abs high priority task id starting========================;; 
 1606               	;used registers          : R24                                                                 
 1607               	;arg registers           : None                                                                
 1608               	;return registers        : R24(HighstPriorityTaskID)->AbsoluteTaskID (Including Idle Task)     
 1609               	;unsafe access registers : R24                                                                 
 1610               	Kernel_Abs_High_Prio_Task_ID_Get:                         ;total 0.75uS @8MHz     (  6 clocks) 
1611:kernel.S      **** 		LDS   R24                , KerBase+OFB_PTID       ;load priority tak_id   (  2 clocks) 
1612:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1613               	;;============================kernel abs high priority task id end==========================;; 
 1614               	
 1615               	
 1616               	
 1617               	
 1618               	
 1619               	;;================================kernel cpu usage get starting=============================;; 
 1620               	;used registers          : R24                                                                 
 1621               	;arg registers           : None                                                                
 1622               	;return registers        : R24(CurrentCpuUsage)->In percentage                                 
 1623               	;unsafe access registers : R24                                                                 
 1624               	Kernel_CPU_Usage_Get:                                     ;total 0.75uS @8MHz     (  6 clocks) 
 1625               			;get cpu usage, return R24                                                             
1626:kernel.S      **** 		LDS   R24                , KerBase+OFB_USAGE      ;load cpu usage         (  2 clocks) 
1627:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1628               	;;==================================kernel cpu usage get end================================;; 
 1629               	
 1630               	
 1631               	
 1632               	
 1633               	
 1634               	;;=================================kernel tick val get starting=============================;; 
 1635               	;used registers          : R22, R23, R24, R25                                                  
 1636               	;arg registers           : None                                                                
 1637               	;return registers        : R25:R22(TickVal)                                                    
 1638               	;unsafe access registers : R22, R23, R24, R25                                                  
 1639               	Kernel_Tick_Val_Get:                                      ;total 0.75uS @8MHz     (  6 clocks) 
1640:kernel.S      ****         IN    R18                , IOSREG                 ;save SREG              (  1 clock ) 
1641:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock ) 
1642:kernel.S      **** 		LDS   R22                , KerBase+OFB_TICK0      ;load tick count        (  2 clocks) 
1643:kernel.S      **** 		LDS   R23                , KerBase+OFB_TICK1      ;load tick count        (  2 clocks) 
1644:kernel.S      **** 		LDS   R24                , KerBase+OFB_TICK2      ;load tick count        (  2 clocks) 
1645:kernel.S      **** 		LDS   R25                , KerBase+OFB_TICK3      ;load tick count        (  2 clocks) 
1646:kernel.S      **** 		OUT   IOSREG             , R18                    ;restore SREG           (  1 clock ) 
1647:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1648               	;;===================================kernel tick val get end================================;; 
DEFINED SYMBOLS
            kernel.S:20     *ABS*:000003e8 KER_TR
            kernel.S:21     *ABS*:00000003 KER_PRS
            kernel.S:22     *ABS*:00000082 KER_RLD
            kernel.S:23     *ABS*:00000080 KER_STK_SZ
            kernel.S:24     *ABS*:0000000a KER_MX_NTSK
            kernel.S:32     *ABS*:00000000 OFB_TICK0
            kernel.S:33     *ABS*:00000001 OFB_TICK1
            kernel.S:34     *ABS*:00000002 OFB_TICK2
            kernel.S:35     *ABS*:00000003 OFB_TICK3
            kernel.S:36     *ABS*:00000004 OFB_TICK4
            kernel.S:37     *ABS*:00000005 OFB_PRS
            kernel.S:38     *ABS*:00000006 OFB_RLD
            kernel.S:39     *ABS*:00000007 OFB_TID
            kernel.S:40     *ABS*:00000008 OFB_NTSK
            kernel.S:41     *ABS*:00000009 OFB_LPR
            kernel.S:42     *ABS*:0000000a OFB_PTID
            kernel.S:43     *ABS*:0000000b OFB_UTC
            kernel.S:44     *ABS*:0000000c OFB_UATC
            kernel.S:45     *ABS*:0000000d OFB_USAGE
            kernel.S:46     *ABS*:0000000e OFB_SLCFG
            kernel.S:47     *ABS*:00000000 OFM_MSPI
            kernel.S:48     *ABS*:00000002 OFM_MSPS
            kernel.S:56     *ABS*:00000000 TASK_BLOCKED
            kernel.S:57     *ABS*:00000001 TASK_READY
            kernel.S:58     *ABS*:00000002 TASK_EXECUTING
            kernel.S:59     *ABS*:00000003 TASK_SUSPENDED
            kernel.S:60     *ABS*:00000004 TASK_CONS_LAT
            kernel.S:61     *ABS*:00000000 SCH_MODE_HANDLER
            kernel.S:62     *ABS*:00000001 SCH_MODE_THREAD
            kernel.S:71     *ABS*:000000b6 SRASSR
            kernel.S:72     *ABS*:000000b4 SROCR2B
            kernel.S:73     *ABS*:000000b3 SROCR2A
            kernel.S:74     *ABS*:000000b2 SRTCNT2
            kernel.S:75     *ABS*:000000b1 SRTCCR2B
            kernel.S:76     *ABS*:000000b0 SRTCCR2A
            kernel.S:77     *ABS*:0000007c SRADMUX
            kernel.S:78     *ABS*:0000007b SRADCSRB
            kernel.S:79     *ABS*:0000007a SRADCSRA
            kernel.S:80     *ABS*:00000070 SRTIMSK2
            kernel.S:81     *ABS*:0000006f SRTIMSK1
            kernel.S:82     *ABS*:0000006e SRTIMSK0
            kernel.S:83     *ABS*:00000061 SRCLKPR
            kernel.S:84     *ABS*:00000060 SRWDTCSR
            kernel.S:85     *ABS*:0000005f SRSREG
            kernel.S:86     *ABS*:0000005e SRSPH
            kernel.S:87     *ABS*:0000005d SRSPL
            kernel.S:88     *ABS*:00000055 SRMCUCR
            kernel.S:89     *ABS*:00000054 SRMCUSR
            kernel.S:90     *ABS*:00000053 SRSMCR
            kernel.S:91     *ABS*:00000050 SRACSR
            kernel.S:92     *ABS*:00000048 SROCR0B
            kernel.S:93     *ABS*:00000047 SROCR0A
            kernel.S:94     *ABS*:00000046 SRTCNT0
            kernel.S:95     *ABS*:00000045 SRTCCR0B
            kernel.S:96     *ABS*:00000044 SRTCCR0A
            kernel.S:97     *ABS*:00000037 SRTIFR2
            kernel.S:98     *ABS*:00000036 SRTIFR1
            kernel.S:99     *ABS*:00000035 SRTIFR0
            kernel.S:101    *ABS*:0000003f IOSREG
            kernel.S:102    *ABS*:0000003e IOSPH
            kernel.S:103    *ABS*:0000003d IOSPL
            kernel.S:104    *ABS*:00000035 IOMCUCR
            kernel.S:105    *ABS*:00000034 IOMCUSR
            kernel.S:106    *ABS*:00000033 IOSMCR
            kernel.S:107    *ABS*:00000028 IOOCR0B
            kernel.S:108    *ABS*:00000027 IOOCR0A
            kernel.S:109    *ABS*:00000026 IOTCNT0
            kernel.S:110    *ABS*:00000025 IOTCCR0B
            kernel.S:111    *ABS*:00000024 IOTCCR0A
            kernel.S:112    *ABS*:00000017 IOTIFR2
            kernel.S:113    *ABS*:00000016 IOTIFR1
            kernel.S:114    *ABS*:00000015 IOTIFR0
            kernel.S:144    .bss:00000000 KerBase
            kernel.S:147    .bss:00000010 KerPSP
            kernel.S:150    .bss:00000024 KerSSZ
            kernel.S:153    .bss:00000032 KerSchSts
            kernel.S:156    .bss:0000003c KerSchPr
            kernel.S:159    .bss:00000046 KerSchSlp
            kernel.S:162    .bss:0000005a KerStack
            kernel.S:1176   .text:000003b8 Kernel_Tick_Init
            kernel.S:1243   .text:00000448 Kernel_Task_Create
            kernel.S:1310   .text:00000538 Kernel_Start_Tasks
            kernel.S:1330   .text:000006cc Kernel_Init
            kernel.S:1363   .text:0000072a Kernel_Task_Idle
            kernel.S:1383   .text:00000758 Kernel_Task_Sleep
            kernel.S:1416   .text:000008ee Kernel_Task_Constant_Latency
            kernel.S:1443   .text:0000091a Kernel_Task_Constant_Latency_Sleep
            kernel.S:1470   .text:00000a9c Kernel_PreSleep_Hook
            kernel.S:1485   .text:00000aa2 Kernel_Clock_Prescale
            kernel.S:1504   .text:00000ab8 Kernel_Task_Sleep_Time_Get
            kernel.S:1526   .text:00000acc Kernel_Task_Status_Get
            kernel.S:1546   .text:00000adc Kernel_NTask_Get
            kernel.S:1560   .text:00000ae2 Kernel_Task_Prio_Get
            kernel.S:1581   .text:00000af2 Kernel_Lowest_Prio_Get
            kernel.S:1595   .text:00000af8 Kernel_High_Prio_Task_ID_Get
            kernel.S:1610   .text:00000b00 Kernel_Abs_High_Prio_Task_ID_Get
            kernel.S:1624   .text:00000b06 Kernel_CPU_Usage_Get
            kernel.S:1639   .text:00000b0c Kernel_Tick_Val_Get
            kernel.S:1117   .text:00000000 __vector_7
            kernel.S:1125   .text:000000ae _KER_SCH_LOOP9
            kernel.S:1125   .text:000000e4 _VAL_NULL10
            kernel.S:1125   .text:000000f8 _VAL_NOT_NULL10
            kernel.S:1125   .text:00000108 _EXIT_SLP_TIME10
            kernel.S:1125   .text:00000112 _KER_CALC_PRIO9
            kernel.S:1125   .text:00000136 _KER_SCH_NEXT9
            kernel.S:1125   .text:00000146 _KER_SCH_EXIT9
            kernel.S:1126   .text:00000160 _KER_USG_TICK15
            kernel.S:1126   .text:0000017a _KER_USG_UTC_SV15
            kernel.S:1132   .text:000001dc __vector_9
            kernel.S:1140   .text:0000028a _KER_SCH_LOOP31
            kernel.S:1140   .text:000002c0 _VAL_NULL32
            kernel.S:1140   .text:000002d4 _VAL_NOT_NULL32
            kernel.S:1140   .text:000002e4 _EXIT_SLP_TIME32
            kernel.S:1140   .text:000002ee _KER_CALC_PRIO31
            kernel.S:1140   .text:00000312 _KER_SCH_NEXT31
            kernel.S:1140   .text:00000322 _KER_SCH_EXIT31
            kernel.S:1141   .text:0000033c _KER_USG_TICK37
            kernel.S:1141   .text:00000356 _KER_USG_UTC_SV37
            kernel.S:1312   .text:00000548 _KER_SCH_LOOP54
            kernel.S:1312   .text:0000057e _VAL_NULL55
            kernel.S:1312   .text:00000592 _VAL_NOT_NULL55
            kernel.S:1312   .text:000005a2 _EXIT_SLP_TIME55
            kernel.S:1312   .text:000005ac _KER_CALC_PRIO54
            kernel.S:1312   .text:000005d0 _KER_SCH_NEXT54
            kernel.S:1312   .text:000005e0 _KER_SCH_EXIT54
            kernel.S:310    .text:00000670 _KER_TC2_AUB65
            kernel.S:310    .text:00000678 _KER_TC2_BUB65
            kernel.S:310    .text:00000680 _KER_OC2_AUB65
            kernel.S:310    .text:00000688 _KER_OC2_BUB65
            kernel.S:310    .text:00000690 _KER_TC2_UB65
            kernel.S:310    .text:00000698 _KER_TC2_TOV265
            kernel.S:310    .text:000006a6 _KER_TC2_OCF2A65
            kernel.S:310    .text:000006b4 _KER_TC2_OCF2B65
            kernel.S:310    .text:000006c2 _KER_TC2_INTEN65
            kernel.S:1365   .text:00000734 _IDLE_LOOP
            kernel.S:1401   .text:000007ee _KER_SCH_LOOP78
            kernel.S:1401   .text:00000824 _VAL_NULL79
            kernel.S:1401   .text:00000838 _VAL_NOT_NULL79
            kernel.S:1401   .text:00000848 _EXIT_SLP_TIME79
            kernel.S:1401   .text:00000852 _KER_CALC_PRIO78
            kernel.S:1401   .text:00000876 _KER_SCH_NEXT78
            kernel.S:1401   .text:00000886 _KER_SCH_EXIT78
            kernel.S:1455   .text:0000099c _KER_SCH_LOOP97
            kernel.S:1455   .text:000009d2 _VAL_NULL98
            kernel.S:1455   .text:000009e6 _VAL_NOT_NULL98
            kernel.S:1455   .text:000009f6 _EXIT_SLP_TIME98
            kernel.S:1455   .text:00000a00 _KER_CALC_PRIO97
            kernel.S:1455   .text:00000a24 _KER_SCH_NEXT97
            kernel.S:1455   .text:00000a34 _KER_SCH_EXIT97

UNDEFINED SYMBOLS
Kernel_Tick_Val_Safely_Get
