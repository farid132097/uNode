   1               	# 1 "kernel.S"
   1               	
   0               	
   0               	
   2               	
   3               	 ; File          : kernel.S
   4               	 ; Author        : MD. Faridul Islam (faridmdislam@gmail.com)
   5               	 ; Description   : AVR kernel for bare-metal RTOS
   6               	 ; Created       : Jul 27, 2025, 09:30 PM
   7               	 ; Last Modified : Dec 08, 2025, 12:19 AM
   8               	
   9               	
  10               	
  11               	
  12               	#include <avr/io.h>
   1               	/* Copyright (c) 2002,2003,2005,2006,2007 Marek Michalkiewicz, Joerg Wunsch
   2               	   Copyright (c) 2007 Eric B. Weddington
   3               	   All rights reserved.
   4               	
   5               	   Redistribution and use in source and binary forms, with or without
   6               	   modification, are permitted provided that the following conditions are met:
   7               	
   8               	   * Redistributions of source code must retain the above copyright
   9               	     notice, this list of conditions and the following disclaimer.
  10               	
  11               	   * Redistributions in binary form must reproduce the above copyright
  12               	     notice, this list of conditions and the following disclaimer in
  13               	     the documentation and/or other materials provided with the
  14               	     distribution.
  15               	
  16               	   * Neither the name of the copyright holders nor the names of
  17               	     contributors may be used to endorse or promote products derived
  18               	     from this software without specific prior written permission.
  19               	
  20               	  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
  21               	  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  22               	  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  23               	  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
  24               	  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  25               	  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  26               	  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  27               	  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  28               	  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  29               	  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
  30               	  POSSIBILITY OF SUCH DAMAGE. */
  31               	
  32               	/* $Id: io.h,v 1.52.2.28 2009/12/20 17:02:53 arcanum Exp $ */
  33               	
  34               	/** \file */
  35               	/** \defgroup avr_io <avr/io.h>: AVR device-specific IO definitions
  36               	    \code #include <avr/io.h> \endcode
  37               	
  38               	    This header file includes the apropriate IO definitions for the
  39               	    device that has been specified by the <tt>-mmcu=</tt> compiler
  40               	    command-line switch.  This is done by diverting to the appropriate
  41               	    file <tt>&lt;avr/io</tt><em>XXXX</em><tt>.h&gt;</tt> which should
  42               	    never be included directly.  Some register names common to all
  43               	    AVR devices are defined directly within <tt>&lt;avr/common.h&gt;</tt>,
  44               	    which is included in <tt>&lt;avr/io.h&gt;</tt>,
  45               	    but most of the details come from the respective include file.
  46               	
  47               	    Note that this file always includes the following files:
  48               	    \code 
  49               	    #include <avr/sfr_defs.h>
  50               	    #include <avr/portpins.h>
  51               	    #include <avr/common.h>
  52               	    #include <avr/version.h>
  53               	    \endcode
  54               	    See \ref avr_sfr for more details about that header file.
  55               	
  56               	    Included are definitions of the IO register set and their
  57               	    respective bit values as specified in the Atmel documentation.
  58               	    Note that inconsistencies in naming conventions,
  59               	    so even identical functions sometimes get different names on
  60               	    different devices.
  61               	
  62               	    Also included are the specific names useable for interrupt
  63               	    function definitions as documented
  64               	    \ref avr_signames "here".
  65               	
  66               	    Finally, the following macros are defined:
  67               	
  68               	    - \b RAMEND
  69               	    <br>
  70               	    The last on-chip RAM address.
  71               	    <br>
  72               	    - \b XRAMEND
  73               	    <br>
  74               	    The last possible RAM location that is addressable. This is equal to 
  75               	    RAMEND for devices that do not allow for external RAM. For devices 
  76               	    that allow external RAM, this will be larger than RAMEND.
  77               	    <br>
  78               	    - \b E2END
  79               	    <br>
  80               	    The last EEPROM address.
  81               	    <br>
  82               	    - \b FLASHEND
  83               	    <br>
  84               	    The last byte address in the Flash program space.
  85               	    <br>
  86               	    - \b SPM_PAGESIZE
  87               	    <br>
  88               	    For devices with bootloader support, the flash pagesize
  89               	    (in bytes) to be used for the \c SPM instruction. 
  90               	    - \b E2PAGESIZE
  91               	    <br>
  92               	    The size of the EEPROM page.
  93               	    
  94               	*/
  95               	
  96               	#ifndef _AVR_IO_H_
  97               	#define _AVR_IO_H_
  98               	
  99               	#include <avr/sfr_defs.h>
   1               	/* Copyright (c) 2002, Marek Michalkiewicz <marekm@amelek.gda.pl>
 100               	
 101               	#if defined (__AVR_AT94K__)
 102               	#  include <avr/ioat94k.h>
 103               	#elif defined (__AVR_AT43USB320__)
 104               	#  include <avr/io43u32x.h>
 105               	#elif defined (__AVR_AT43USB355__)
 106               	#  include <avr/io43u35x.h>
 107               	#elif defined (__AVR_AT76C711__)
 108               	#  include <avr/io76c711.h>
 109               	#elif defined (__AVR_AT86RF401__)
 110               	#  include <avr/io86r401.h>
 111               	#elif defined (__AVR_AT90PWM1__)
 112               	#  include <avr/io90pwm1.h>
 113               	#elif defined (__AVR_AT90PWM2__)
 114               	#  include <avr/io90pwmx.h>
 115               	#elif defined (__AVR_AT90PWM2B__)
 116               	#  include <avr/io90pwm2b.h>
 117               	#elif defined (__AVR_AT90PWM3__)
 118               	#  include <avr/io90pwmx.h>
 119               	#elif defined (__AVR_AT90PWM3B__)
 120               	#  include <avr/io90pwm3b.h>
 121               	#elif defined (__AVR_AT90PWM216__)
 122               	#  include <avr/io90pwm216.h>
 123               	#elif defined (__AVR_AT90PWM316__)
 124               	#  include <avr/io90pwm316.h>
 125               	#elif defined (__AVR_AT90PWM81__)
 126               	#  include <avr/io90pwm81.h>
 127               	#elif defined (__AVR_ATmega8U2__)
 128               	#  include <avr/iom8u2.h>
 129               	#elif defined (__AVR_ATmega16M1__)
 130               	#  include <avr/iom16m1.h>
 131               	#elif defined (__AVR_ATmega16U2__)
 132               	#  include <avr/iom16u2.h>
 133               	#elif defined (__AVR_ATmega16U4__)
 134               	#  include <avr/iom16u4.h>
 135               	#elif defined (__AVR_ATmega32C1__)
 136               	#  include <avr/iom32c1.h>
 137               	#elif defined (__AVR_ATmega32M1__)
 138               	#  include <avr/iom32m1.h>
 139               	#elif defined (__AVR_ATmega32U2__)
 140               	#  include <avr/iom32u2.h>
 141               	#elif defined (__AVR_ATmega32U4__)
 142               	#  include <avr/iom32u4.h>
 143               	#elif defined (__AVR_ATmega32U6__)
 144               	#  include <avr/iom32u6.h>
 145               	#elif defined (__AVR_ATmega64C1__)
 146               	#  include <avr/iom64c1.h>
 147               	#elif defined (__AVR_ATmega64M1__)
 148               	#  include <avr/iom64m1.h>
 149               	#elif defined (__AVR_ATmega128__)
 150               	#  include <avr/iom128.h>
 151               	#elif defined (__AVR_ATmega1280__)
 152               	#  include <avr/iom1280.h>
 153               	#elif defined (__AVR_ATmega1281__)
 154               	#  include <avr/iom1281.h>
 155               	#elif defined (__AVR_ATmega1284P__)
 156               	#  include <avr/iom1284p.h>
 157               	#elif defined (__AVR_ATmega128RFA1__)
 158               	#  include <avr/iom128rfa1.h>
 159               	#elif defined (__AVR_ATmega2560__)
 160               	#  include <avr/iom2560.h>
 161               	#elif defined (__AVR_ATmega2561__)
 162               	#  include <avr/iom2561.h>
 163               	#elif defined (__AVR_AT90CAN32__)
 164               	#  include <avr/iocan32.h>
 165               	#elif defined (__AVR_AT90CAN64__)
 166               	#  include <avr/iocan64.h>
 167               	#elif defined (__AVR_AT90CAN128__)
 168               	#  include <avr/iocan128.h>
 169               	#elif defined (__AVR_AT90USB82__)
 170               	#  include <avr/iousb82.h>
 171               	#elif defined (__AVR_AT90USB162__)
 172               	#  include <avr/iousb162.h>
 173               	#elif defined (__AVR_AT90USB646__)
 174               	#  include <avr/iousb646.h>
 175               	#elif defined (__AVR_AT90USB647__)
 176               	#  include <avr/iousb647.h>
 177               	#elif defined (__AVR_AT90USB1286__)
 178               	#  include <avr/iousb1286.h>
 179               	#elif defined (__AVR_AT90USB1287__)
 180               	#  include <avr/iousb1287.h>
 181               	#elif defined (__AVR_ATmega64__)
 182               	#  include <avr/iom64.h>
 183               	#elif defined (__AVR_ATmega640__)
 184               	#  include <avr/iom640.h>
 185               	#elif defined (__AVR_ATmega644__) || defined (__AVR_ATmega644A__)
 186               	#  include <avr/iom644.h>
 187               	#elif defined (__AVR_ATmega644P__)
 188               	#  include <avr/iom644p.h>
 189               	#elif defined (__AVR_ATmega644PA__)
 190               	#  include <avr/iom644pa.h>
 191               	#elif defined (__AVR_ATmega645__) || defined (__AVR_ATmega645A__) || defined (__AVR_ATmega645P__)
 192               	#  include <avr/iom645.h>
 193               	#elif defined (__AVR_ATmega6450__) || defined (__AVR_ATmega6450A__) || defined (__AVR_ATmega6450P__
 194               	#  include <avr/iom6450.h>
 195               	#elif defined (__AVR_ATmega649__) || defined (__AVR_ATmega649A__)
 196               	#  include <avr/iom649.h>
 197               	#elif defined (__AVR_ATmega6490__) || defined (__AVR_ATmega6490A__) || defined (__AVR_ATmega6490P__
 198               	#  include <avr/iom6490.h>
 199               	#elif defined (__AVR_ATmega649P__)
 200               	#  include <avr/iom649p.h>
 201               	#elif defined (__AVR_ATmega64HVE__)
 202               	#  include <avr/iom64hve.h>
 203               	#elif defined (__AVR_ATmega103__)
 204               	#  include <avr/iom103.h>
 205               	#elif defined (__AVR_ATmega32__)
 206               	#  include <avr/iom32.h>
 207               	#elif defined (__AVR_ATmega323__)
 208               	#  include <avr/iom323.h>
 209               	#elif defined (__AVR_ATmega324P__) || defined (__AVR_ATmega324A__)
 210               	#  include <avr/iom324.h>
 211               	#elif defined (__AVR_ATmega324PA__)
 212               	#  include <avr/iom324pa.h>
 213               	#elif defined (__AVR_ATmega325__)
 214               	#  include <avr/iom325.h>
 215               	#elif defined (__AVR_ATmega325P__)
 216               	#  include <avr/iom325.h>
 217               	#elif defined (__AVR_ATmega3250__)
 218               	#  include <avr/iom3250.h>
 219               	#elif defined (__AVR_ATmega3250P__)
 220               	#  include <avr/iom3250.h>
 221               	#elif defined (__AVR_ATmega328P__) || defined (__AVR_ATmega328__)
 222               	#  include <avr/iom328p.h>
   1               	/* Copyright (c) 2007 Atmel Corporation
 223               	#elif defined (__AVR_ATmega329__)
 224               	#  include <avr/iom329.h>
 225               	#elif defined (__AVR_ATmega329P__) || defined (__AVR_ATmega329PA__)
 226               	#  include <avr/iom329.h>
 227               	#elif defined (__AVR_ATmega3290__)
 228               	#  include <avr/iom3290.h>
 229               	#elif defined (__AVR_ATmega3290P__)
 230               	#  include <avr/iom3290.h>
 231               	#elif defined (__AVR_ATmega32HVB__)
 232               	#  include <avr/iom32hvb.h>
 233               	#elif defined (__AVR_ATmega406__)
 234               	#  include <avr/iom406.h>
 235               	#elif defined (__AVR_ATmega16__)
 236               	#  include <avr/iom16.h>
 237               	#elif defined (__AVR_ATmega16A__)
 238               	#  include <avr/iom16a.h>
 239               	#elif defined (__AVR_ATmega161__)
 240               	#  include <avr/iom161.h>
 241               	#elif defined (__AVR_ATmega162__)
 242               	#  include <avr/iom162.h>
 243               	#elif defined (__AVR_ATmega163__)
 244               	#  include <avr/iom163.h>
 245               	#elif defined (__AVR_ATmega164P__) || defined (__AVR_ATmega164A__)
 246               	#  include <avr/iom164.h>
 247               	#elif defined (__AVR_ATmega165__) || defined (__AVR_ATmega165A__)
 248               	#  include <avr/iom165.h>
 249               	#elif defined (__AVR_ATmega165P__)
 250               	#  include <avr/iom165p.h>
 251               	#elif defined (__AVR_ATmega168__) || defined (__AVR_ATmega168A__)
 252               	#  include <avr/iom168.h>
 253               	#elif defined (__AVR_ATmega168P__)
 254               	#  include <avr/iom168p.h>
 255               	#elif defined (__AVR_ATmega169__) || defined (__AVR_ATmega169A__)
 256               	#  include <avr/iom169.h>
 257               	#elif defined (__AVR_ATmega169P__)
 258               	#  include <avr/iom169p.h>
 259               	#elif defined (__AVR_ATmega169PA__)
 260               	#  include <avr/iom169pa.h>
 261               	#elif defined (__AVR_ATmega8HVA__)
 262               	#  include <avr/iom8hva.h>
 263               	#elif defined (__AVR_ATmega16HVA__)
 264               	#  include <avr/iom16hva.h>
 265               	#elif defined (__AVR_ATmega16HVA2__)
 266               	#  include <avr/iom16hva2.h>
 267               	#elif defined (__AVR_ATmega16HVB__)
 268               	#  include <avr/iom16hvb.h>
 269               	#elif defined (__AVR_ATmega8__)
 270               	#  include <avr/iom8.h>
 271               	#elif defined (__AVR_ATmega48__) || defined (__AVR_ATmega48A__)
 272               	#  include <avr/iom48.h>
 273               	#elif defined (__AVR_ATmega48P__)
 274               	#  include <avr/iom48p.h>
 275               	#elif defined (__AVR_ATmega88__) || defined (__AVR_ATmega88A__)
 276               	#  include <avr/iom88.h>
 277               	#elif defined (__AVR_ATmega88P__)
 278               	#  include <avr/iom88p.h>
 279               	#elif defined (__AVR_ATmega88PA__)
 280               	#  include <avr/iom88pa.h>
 281               	#elif defined (__AVR_ATmega8515__)
 282               	#  include <avr/iom8515.h>
 283               	#elif defined (__AVR_ATmega8535__)
 284               	#  include <avr/iom8535.h>
 285               	#elif defined (__AVR_AT90S8535__)
 286               	#  include <avr/io8535.h>
 287               	#elif defined (__AVR_AT90C8534__)
 288               	#  include <avr/io8534.h>
 289               	#elif defined (__AVR_AT90S8515__)
 290               	#  include <avr/io8515.h>
 291               	#elif defined (__AVR_AT90S4434__)
 292               	#  include <avr/io4434.h>
 293               	#elif defined (__AVR_AT90S4433__)
 294               	#  include <avr/io4433.h>
 295               	#elif defined (__AVR_AT90S4414__)
 296               	#  include <avr/io4414.h>
 297               	#elif defined (__AVR_ATtiny22__)
 298               	#  include <avr/iotn22.h>
 299               	#elif defined (__AVR_ATtiny26__)
 300               	#  include <avr/iotn26.h>
 301               	#elif defined (__AVR_AT90S2343__)
 302               	#  include <avr/io2343.h>
 303               	#elif defined (__AVR_AT90S2333__)
 304               	#  include <avr/io2333.h>
 305               	#elif defined (__AVR_AT90S2323__)
 306               	#  include <avr/io2323.h>
 307               	#elif defined (__AVR_AT90S2313__)
 308               	#  include <avr/io2313.h>
 309               	#elif defined (__AVR_ATtiny2313__)
 310               	#  include <avr/iotn2313.h>
 311               	#elif defined (__AVR_ATtiny2313A__)
 312               	#  include <avr/iotn2313a.h>
 313               	#elif defined (__AVR_ATtiny13__)
 314               	#  include <avr/iotn13.h>
 315               	#elif defined (__AVR_ATtiny13A__)
 316               	#  include <avr/iotn13a.h>
 317               	#elif defined (__AVR_ATtiny25__)
 318               	#  include <avr/iotn25.h>
 319               	#elif defined (__AVR_ATtiny4313__)
 320               	#  include <avr/iotn4313.h>
 321               	#elif defined (__AVR_ATtiny45__)
 322               	#  include <avr/iotn45.h>
 323               	#elif defined (__AVR_ATtiny85__)
 324               	#  include <avr/iotn85.h>
 325               	#elif defined (__AVR_ATtiny24__)
 326               	#  include <avr/iotn24.h>
 327               	#elif defined (__AVR_ATtiny24A__)
 328               	#  include <avr/iotn24a.h>
 329               	#elif defined (__AVR_ATtiny44__)
 330               	#  include <avr/iotn44.h>
 331               	#elif defined (__AVR_ATtiny44A__)
 332               	#  include <avr/iotn44a.h>
 333               	#elif defined (__AVR_ATtiny84__)
 334               	#  include <avr/iotn84.h>
 335               	#elif defined (__AVR_ATtiny261__)
 336               	#  include <avr/iotn261.h>
 337               	#elif defined (__AVR_ATtiny261A__)
 338               	#  include <avr/iotn261a.h>
 339               	#elif defined (__AVR_ATtiny461__)
 340               	#  include <avr/iotn461.h>
 341               	#elif defined (__AVR_ATtiny461A__)
 342               	#  include <avr/iotn461a.h>
 343               	#elif defined (__AVR_ATtiny861__)
 344               	#  include <avr/iotn861.h>
 345               	#elif defined (__AVR_ATtiny861A__)
 346               	#  include <avr/iotn861a.h>
 347               	#elif defined (__AVR_ATtiny43U__)
 348               	#  include <avr/iotn43u.h>
 349               	#elif defined (__AVR_ATtiny48__)
 350               	#  include <avr/iotn48.h>
 351               	#elif defined (__AVR_ATtiny88__)
 352               	#  include <avr/iotn88.h>
 353               	#elif defined (__AVR_ATtiny87__)
 354               	#  include <avr/iotn87.h>
 355               	#elif defined (__AVR_ATtiny167__)
 356               	#  include <avr/iotn167.h>
 357               	#elif defined (__AVR_AT90SCR100__)
 358               	#  include <avr/io90scr100.h>
 359               	#elif defined (__AVR_ATxmega16A4__)
 360               	#  include <avr/iox16a4.h>
 361               	#elif defined (__AVR_ATxmega16D4__)
 362               	#  include <avr/iox16d4.h>
 363               	#elif defined (__AVR_ATxmega32A4__)
 364               	#  include <avr/iox32a4.h>
 365               	#elif defined (__AVR_ATxmega32D4__)
 366               	#  include <avr/iox32d4.h>
 367               	#elif defined (__AVR_ATxmega64A1__)
 368               	#  include <avr/iox64a1.h>
 369               	#elif defined (__AVR_ATxmega64A3__)
 370               	#  include <avr/iox64a3.h>
 371               	#elif defined (__AVR_ATxmega64D3__)
 372               	#  include <avr/iox64d3.h>
 373               	#elif defined (__AVR_ATxmega128A1__)
 374               	#  include <avr/iox128a1.h>
 375               	#elif defined (__AVR_ATxmega128A3__)
 376               	#  include <avr/iox128a3.h>
 377               	#elif defined (__AVR_ATxmega128D3__)
 378               	#  include <avr/iox128d3.h>
 379               	#elif defined (__AVR_ATxmega192A3__)
 380               	#  include <avr/iox192a3.h>
 381               	#elif defined (__AVR_ATxmega192D3__)
 382               	#  include <avr/iox192d3.h>
 383               	#elif defined (__AVR_ATxmega256A3__)
 384               	#  include <avr/iox256a3.h>
 385               	#elif defined (__AVR_ATxmega256A3B__)
 386               	#  include <avr/iox256a3b.h>
 387               	#elif defined (__AVR_ATxmega256D3__)
 388               	#  include <avr/iox256d3.h>
 389               	#elif defined (__AVR_ATA6289__)
 390               	#  include <avr/ioa6289.h>
 391               	/* avr1: the following only supported for assembler programs */
 392               	#elif defined (__AVR_ATtiny28__)
 393               	#  include <avr/iotn28.h>
 394               	#elif defined (__AVR_AT90S1200__)
 395               	#  include <avr/io1200.h>
 396               	#elif defined (__AVR_ATtiny15__)
 397               	#  include <avr/iotn15.h>
 398               	#elif defined (__AVR_ATtiny12__)
 399               	#  include <avr/iotn12.h>
 400               	#elif defined (__AVR_ATtiny11__)
 401               	#  include <avr/iotn11.h>
 402               	#else
 403               	#  if !defined(__COMPILING_AVR_LIBC__)
 404               	#    warning "device type not defined"
 405               	#  endif
 406               	#endif
 407               	
 408               	#include <avr/portpins.h>
   1               	/* Copyright (c) 2003  Theodore A. Roth
 409               	
 410               	#include <avr/common.h>
   1               	/* Copyright (c) 2007 Eric B. Weddington
 411               	
 412               	#include <avr/version.h>
   1               	/* Copyright (c) 2005, Joerg Wunsch                               -*- c -*-
 413               	
 414               	/* Include fuse.h after individual IO header files. */
 415               	#include <avr/fuse.h>
   1               	/* Copyright (c) 2007, Atmel Corporation
 416               	
 417               	/* Include lock.h after individual IO header files. */
 418               	#include <avr/lock.h>
   1               	/* Copyright (c) 2007, Atmel Corporation
 419               	
  13               	#include "kernel.h"
   1               	
  14               	
  15               	
  16               	
  17               	
  18               	;;===============================define vector section starting=============================;; 
  19               	;.section .vectors, "ax", @progbits                                                            
  20               	;.org    0x000C                                            ;isr location for wdt               
  21               	;        JMP   __vector_6                                                                      
  22               	;.org    0x000E                                            ;isr location for timer2compa async 
  23               	;        JMP   __vector_7                                                                      
  24               	;;=================================define vector section end================================;; 
  25               	
  26               	
  27               	
  28               	
  29               	;;============================define user address or macro starting=========================;; 
  30               	.equ     KER_TR ,         1000                            ;TickRate in Hz, not calculated      
  31               	.equ     KER_PRS,         0x03                            ;For prescaler 64, manually select   
  32               	.equ     KER_RLD,         0x82                            ;KER_RLD=0xFF-(F_CPU/KER_PRS/KER_TR) 
  33               	.equ     KER_STK_SZ,      128                             ;stack size in bytes for each task   
  34               	.equ     KER_MX_NTSK,     10                              ;max number of tasks                 
  35               	;;==============================define user address or macro end============================;; 
  36               	
  37               	
  38               	
  39               	
  40               	
  41               	;;===============================define data offsets starting===============================;; 
  42               	.equ     OFB_TICK0,       0x00                            ;offset from KerBase tick count byte0
  43               	.equ     OFB_TICK1,       0x01                            ;offset from KerBase tick count byte1
  44               	.equ     OFB_TICK2,       0x02                            ;offset from KerBase tick count byte2
  45               	.equ     OFB_TICK3,       0x03                            ;offset from KerBase tick count byte3
  46               	.equ     OFB_TICK4,       0x04                            ;offset from KerBase tick count byte4
  47               	.equ     OFB_PRS  ,       0x05                            ;offset from KerBase prescaler       
  48               	.equ     OFB_RLD  ,       0x06                            ;offset from KerBase counter reload  
  49               	.equ     OFB_TID  ,       0x07                            ;offset from KerBase task id         
  50               	.equ     OFB_NTSK ,       0x08                            ;offset from KerBase ntask           
  51               	.equ     OFB_LPR  ,       0x09                            ;offset from KerBase lowest priority 
  52               	.equ     OFB_PTID ,       0x0A                            ;offset from KerBase prio task_id    
  53               	.equ     OFB_UTC  ,       0x0B                            ;offset from KerBase usage tick cnt  
  54               	.equ     OFB_UATC ,       0x0C                            ;offset from KerBase active tick cnt 
  55               	.equ     OFB_USAGE,       0x0D                            ;offset from KerBase cpu usage       
  56               	.equ     OFB_SLCFG,       0x0E                            ;offset from KerBase sleep config    
  57               	.equ     OFM_MSPI ,       0x00                            ;offset from MSPZP msp index field   
  58               	.equ     OFM_MSPS ,       0x02                            ;offset from MSPZP msp starting      
  59               	;;==================================define data offsets end=================================;; 
  60               	
  61               	
  62               	
  63               	
  64               	
  65               	;;===============================define system macro starting===============================;; 
  66               	.equ     TASK_BLOCKED,    0x00                            ;KerSchSts val=0                     
  67               	.equ     TASK_READY,      0x01                            ;KerSchSts val=1                     
  68               	.equ     TASK_EXECUTING,  0x02                            ;KerSchSts val=2                     
  69               	.equ     TASK_SUSPENDED,  0x03                            ;KerSchSts val=3                     
  70               	.equ     TASK_CONS_LAT,   0x04                            ;KerSchSts val=3, constant latency   
  71               	.equ     SCH_MODE_HANDLER,0x00                            ;handler mode in KER_SLP_TIME_MGNT   
  72               	.equ     SCH_MODE_THREAD, 0x01                            ;thread mode in KER_SLP_TIME_MGNT    
  73               	;;==================================define system macro end=================================;; 
  74               	
  75               	
  76               	
  77               	
  78               	
  79               	;;===========================define hardware reg address starting===========================;; 
  80               	;SRAM Mapped Addresses, LDS/STS can be used                                                    
  81               	.equ     SRASSR  ,        0xB6                            ;manually defined ASSR in SRAM       
  82               	.equ     SROCR2B ,        0xB4                            ;manually defined OCR2B in SRAM      
  83               	.equ     SROCR2A ,        0xB3                            ;manually defined OCR2A in SRAM      
  84               	.equ     SRTCNT2 ,        0xB2                            ;manually defined TNCT2 in SRAM      
  85               	.equ     SRTCCR2B,        0xB1                            ;manually defined TCCR2B in SRAM     
  86               	.equ     SRTCCR2A,        0xB0                            ;manually defined TCCR2A in SRAM     
  87               	.equ     SRADMUX ,        0x7C                            ;manually defined ADMUX in SRAM      
  88               	.equ     SRADCSRB,        0x7B                            ;manually defined ADCSRB in SRAM     
  89               	.equ     SRADCSRA,        0x7A                            ;manually defined ADCSRA in SRAM     
  90               	.equ     SRTIMSK2,        0x70                            ;manually defined TIMSK2 in SRAM     
  91               	.equ     SRTIMSK1,        0x6F                            ;manually defined TIMSK1 in SRAM     
  92               	.equ     SRTIMSK0,        0x6E                            ;manually defined TIMSK0 in SRAM     
  93               	.equ     SRCLKPR ,        0x61                            ;manually defined CLKPR in SRAM      
  94               	.equ     SRWDTCSR,        0x60                            ;manually defined WDTCSR in SRAM     
  95               	.equ     SRSREG  ,        0x5F                            ;manually defined SREG in SRAM       
  96               	.equ     SRSPH   ,        0x5E                            ;manually defined SPH in SRAM        
  97               	.equ     SRSPL   ,        0x5D                            ;manually defined SPL in SRAM        
  98               	.equ     SRMCUCR ,        0x55                            ;manually defined MCUCR in SRAM      
  99               	.equ     SRMCUSR ,        0x54                            ;manually defined MCUSR in SRAM      
 100               	.equ     SRSMCR  ,        0x53                            ;manually defined SMCR in SRAM       
 101               	.equ     SRACSR  ,        0x50                            ;manually defined ACSR in SRAM       
 102               	.equ     SRTIFR2 ,        0x37                            ;manually defined TIFR2 in SRAM      
 103               	.equ     SRTIFR1 ,        0x36                            ;manually defined TIFR1 in SRAM      
 104               	.equ     SRTIFR0 ,        0x35                            ;manually defined TIFR0 in SRAM      
 105               	;IO Mapped Addresses, IN/OUT commands can be used                                              
 106               	.equ     IOSREG  ,        0x3F                            ;manually defined SREG in IO         
 107               	.equ     IOSPH   ,        0x3E                            ;manually defined SPH in IO          
 108               	.equ     IOSPL   ,        0x3D                            ;manually defined SPL in IO          
 109               	.equ     IOMCUCR ,        0x35                            ;manually defined MCUCR in IO        
 110               	.equ     IOMCUSR ,        0x34                            ;manually defined MCUSR in IO        
 111               	.equ     IOSMCR  ,        0x33                            ;manually defined SMCR in IO         
 112               	.equ     IOTIFR2 ,        0x17                            ;manually defined TIFR2 in IO        
 113               	.equ     IOTIFR1 ,        0x16                            ;manually defined TIFR1 in IO        
 114               	.equ     IOTIFR0 ,        0x15                            ;manually defined TIFR0 in IO        
 115               	;;==============================define hardware reg address end=============================;; 
 116               	
 117               	
 118               	
 119               	
 120               	
 121               	;;=============================define global variables starting=============================;; 
 122               	.section   .bss                                                                                
 123               	                                                                                               
 124               	.global    KerBase                                        ;declare global space for kernel     
 125 0000 0000 0000 	KerBase:   .skip 16                                       ;see offset section                  
 125      0000 0000 
 125      0000 0000 
 125      0000 0000 
 126               	                                                                                               
 127               	.global    KerPSP                                         ;space for process stack pointers    
 128 0010 0000 0000 	KerPSP:    .skip KER_MX_NTSK*2                            ;2 bytes for each task               
 128      0000 0000 
 128      0000 0000 
 128      0000 0000 
 128      0000 0000 
 129               	                                                                                               
 130               	.global    KerSSZ                                         ;stack for main stack pointers       
 131 0024 0000 0000 	KerSSZ:    .skip 14                                       ;stack_ptr(2), MSPZPn(4)             
 131      0000 0000 
 131      0000 0000 
 131      0000 
 132               	                                                                                               
 133               	.global    KerSchSts                                      ;space for scheduler status          
 134 0032 0000 0000 	KerSchSts: .skip KER_MX_NTSK*1                            ;status(1)                           
 134      0000 0000 
 134      0000 
 135               	                                                                                               
 136               	.global    KerSchPr                                       ;space for scheduler priority        
 137 003c 0000 0000 	KerSchPr:  .skip KER_MX_NTSK*1                            ;priority(1)                         
 137      0000 0000 
 137      0000 
 138               	                                                                                               
 139               	.global    KerSchSlp                                      ;space for task sleep                
 140 0046 0000 0000 	KerSchSlp: .skip KER_MX_NTSK*2                            ;timing(2)                           
 140      0000 0000 
 140      0000 0000 
 140      0000 0000 
 140      0000 0000 
 141               	                                                                                               
 142               	.global    KerStack                                       ;space for stack                     
 143 005a 0000 0000 	KerStack:  .skip KER_STK_SZ*KER_MX_NTSK                   ;KER_STK_SZ bytes for each task      
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 143      0000 0000 
 144               	;;==============================define global variables end=================================;; 
 145               	
 146               	
 147               	
 148               	
 149               	
 150               	;;===============================define text section starting===============================;; 
 151               	.section .text                                                                                 
 152               	;;==================================define text section end=================================;; 
 153               	
 154               	
 155               	
 156               	
 157               	
 158               	;;==============================define global functions starting============================;; 
 159               	.global  Kernel_Tick_Init                                                                      
 160               	.global  Kernel_Task_Create                                                                    
 161               	.global  Kernel_Start_Tasks                                                                    
 162               	.global  Kernel_Init                                                                           
 163               	.global  Kernel_Task_Idle                                                                      
 164               	.global  Kernel_Task_Sleep                                                                     
 165               	.global  Kernel_Task_Constant_Latency                                                          
 166               	.global  Kernel_Task_Constant_Latency_Sleep                                                    
 167               	.global  Kernel_PreSleep_Hook                                                                  
 168               	.global  Kernel_Clock_Prescale                                                                 
 169               	.global  Kernel_Task_Sleep_Time_Get                                                            
 170               	.global  Kernel_Task_Status_Get                                                                
 171               	.global  Kernel_NTask_Get                                                                      
 172               	.global  Kernel_Task_Prio_Get                                                                  
 173               	.global  Kernel_Lowest_Prio_Get                                                                
 174               	.global  Kernel_High_Prio_Task_ID_Get                                                          
 175               	.global  Kernel_Abs_High_Prio_Task_ID_Get                                                      
 176               	.global  Kernel_CPU_Usage_Get                                                                  
 177               	.global  Kernel_Tick_Val_Get                                                                   
 178               	.global  Kernel_Tick_Val_Safely_Get                                                            
 179               	;;================================define global functions end===============================;; 
 180               	
 181               	
 182               	
 183               	
 184               	
 185               	;;===================================wdt disable starting===================================;; 
 186               	;used registers          : R18                                                                 
 187               	;arg registers           : None                                                                
 188               	;return registers        : None                                                                
 189               	;unsafe access registers : R18                                                                 
 190               	.macro  KER_WDT_DISABLE                                   ;1.5uS @8MHz            ( 12 clocks) 
 191               	        WDR                                               ;reset wdt              (  1 clock ) 
 192               			LDS   R18                , SRMCUSR                ;copy MCUSR             (  1 clock ) 
 193               			ANDI  R18                , 0xFF & (0<<WDRF)       ;clear WDRF             (  1 clock ) 
 194               			STS   SRMCUSR            , R18                    ;set val                (  1 clock ) 
 195               			LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
 196               			ORI   R18                , 0x18                   ;set WDCE,WDE           (  1 clock ) 
 197               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 198               			LDI   R18                , 0x00                   ;clear WDE              (  1 clock ) 
 199               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 200               	.endm                                                                                          
 201               	;;=====================================wdt disable endd=====================================;; 
 202               	
 203               	
 204               	
 205               	
 206               	
 207               	;;=================================timer2 disable starting==================================;; 
 208               	;used registers          : R18                                                                 
 209               	;arg registers           : None                                                                
 210               	;return registers        : None                                                                
 211               	;unsafe access registers : R18                                                                 
 212               	.macro  KER_TIMER2_DISABLE                                ;1.75uS @8MHz           ( 14 clocks) 
 213               			LDI   R18                , 0x00                   ;clear interrupt enbits (  1 clock ) 
 214               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 215               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 216               			STS   SRTCCR2B           , R18                    ;set val to TCCR2B      (  2 clocks) 
 217               			LDI   R18                , 0x00                   ;clear AS2 bit          (  1 clock ) 
 218               			STS   SRASSR             , R18                    ;set val to ASSR        (  2 clocks) 
 219               			LDI   R18                , 0x00                   ;set val to reg         (  1 clock ) 
 220               			STS   SROCR2B            , R18                    ;clear OCR2B            (  2 clocks) 
 221               			STS   SRTCNT2            , R18                    ;clear TCNT2            (  2 clocks) 
 222               	.endm                                                                                          
 223               	;;==================================timer2 disable end======================================;; 
 224               	
 225               	
 226               	
 227               	
 228               	
 229               	;;=====================================wdt init starting=====================================;; 
 230               	;used registers          : R18                                                                 
 231               	;arg registers           : None                                                                
 232               	;return registers        : None                                                                
 233               	;unsafe access registers : R18                                                                 
 234               	.macro  KER_WDT_INIT                                      ;1.13uS @8MHz           (  9 clocks) 
 235               	        WDR                                               ;reset wdt              (  1 clock ) 
 236               			LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
 237               			ORI   R18                , 0x18                   ;set WDCE,WDE           (  1 clock ) 
 238               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 239               			#ifdef KER_WDT_TICK_16MS                                                               
 240               			LDI   R18                , 0x40                   ;WDIE                   (  1 clock ) 
 241               			#elif defined(KER_WDT_TICK_32MS)                                                       
 242               			LDI   R18                , 0x41                   ;WDIE, WDPS0            (  1 clock ) 
 243               			#elif defined(KER_WDT_TICK_64MS)                                                       
 244               			LDI   R18                , 0x42                   ;WDIE, WDPS1            (  1 clock ) 
 245               			#elif defined(KER_WDT_TICK_125MS)                                                      
 246               			LDI   R18                , 0x43                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 247               			#elif defined(KER_WDT_TICK_250MS)                                                      
 248               			LDI   R18                , 0x44                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 249               			#elif defined(KER_WDT_TICK_500MS)                                                      
 250               			LDI   R18                , 0x45                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 251               			#elif defined(KER_WDT_TICK_1000MS)                                                     
 252               			LDI   R18                , 0x46                   ;WDIE, WDPS1, WDPS2     (  1 clock ) 
 253               			#else                                                                                  
 254               	        LDI   R18                , 0x40                   ;WDIE                   (  1 clock ) 
 255               			#endif                                                                                 
 256               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 257               	.endm                                                                                          
 258               	;;=====================================wdt init end=========================================;; 
 259               	
 260               	
 261               	
 262               	
 263               	
 264               	;;=================================timer2 init starting=====================================;; 
 265               	;used registers          : R18                                                                 
 266               	;arg registers           : None                                                                
 267               	;return registers        : None                                                                
 268               	;unsafe access registers : R18                                                                 
 269               	.macro  KER_TIMER2_INIT                                   ;2.50uS @8MHz           ( 20 clocks) 
 270               			LDI   R18                , 0x00                   ;clear interrupts       (  1 clock ) 
 271               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 272               			LDS   R18		         , KerBase+OFB_RLD        ;load reload val        (  2 clocks) 
 273               			STS   SROCR2A            , R18                    ;set compare match val  (  2 clocks) 
 274               			LDI   R18                , 0x02                   ;set CTC mode           (  1 clock ) 
 275               	        STS   SRTCCR2A           , R18                    ;set val to TCCR2A      (  2 clocks) 
 276               			LDS   R18		         , KerBase+OFB_PRS        ;load prescaler         (  2 clocks) 
 277               			STS   SRTCCR2B           , R18                    ;set prescaler          (  2 clocks) 
 278               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 279               			STS   SRTCNT2            , R18                    ;clear TCNT2            (  2 clocks) 
 280               	        LDI   R18                , 0x02                   ;set TOIE2 bit          (  1 clock ) 
 281               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 282               	.endm                                                                                          
 283               	;;====================================timer2 init end=======================================;; 
 284               	
 285               	
 286               	
 287               	
 288               	
 289               	;;===============================timer2 async init starting=================================;; 
 290               	;used registers          : R18, R19                                                            
 291               	;arg registers           : None                                                                
 292               	;return registers        : None                                                                
 293               	;unsafe access registers : R18, R19                                                            
 294               	.macro  KER_TIMER2_ASYNC_INIT                             ;~9.13uS @8MHz          (~73 clocks) 
 295               			LDI   R18                , 0x00                   ;clear interrupts       (  1 clock ) 
 296               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 297               			LDI   R18                , 0x20                   ;set AS2 bit            (  1 clock ) 
 298               			STS   SRASSR             , R18                    ;set val to ASSR        (  2 clocks) 
 299               			#ifdef KER_TOSC_TICK_1MS                                                               
 300               			LDI   R18                , 0x20                   ;1000Hz->clk/1/32       (  1 clock ) 
 301               			LDI   R19                , 0x01                   ;1000Hz->clk/1/32       (  1 clock ) 
 302               			#elif defined(KER_TOSC_TICK_10MS)                                                      
 303               			LDI   R18                , 0x29                   ;100Hz->clk/8/41        (  1 clock ) 
 304               			LDI   R19                , 0x02                   ;100Hz->clk/8/41        (  1 clock ) 
 305               			#elif defined(KER_TOSC_TICK_50MS)                                                      
 306               			LDI   R18                , 0xCC                   ;20Hz->clk/8/204        (  1 clock ) 
 307               			LDI   R19                , 0x02                   ;20Hz->clk/8/204        (  1 clock ) 
 308               			#elif defined(KER_TOSC_TICK_100MS)                                                     
 309               			LDI   R18                , 0x66                   ;10Hz->clk/32/102       (  1 clock ) 
 310               			LDI   R19                , 0x03                   ;10Hz->clk/32/102       (  1 clock ) 
 311               			#elif defined(KER_TOSC_TICK_250MS)                                                     
 312               			LDI   R18                , 0x80                   ;4Hz->clk/64/128        (  1 clock ) 
 313               			LDI   R19                , 0x04                   ;4Hz->clk/64/128        (  1 clock ) 
 314               			#elif defined(KER_TOSC_TICK_500MS)                                                     
 315               			LDI   R18                , 0x80                   ;2Hz->clk/128/128       (  1 clock ) 
 316               			LDI   R19                , 0x05                   ;2Hz->clk/128/128       (  1 clock ) 
 317               			#elif defined(KER_TOSC_TICK_1000MS)                                                    
 318               			LDI   R18                , 0x80                   ;1Hz->clk/256/128       (  1 clock ) 
 319               			LDI   R19                , 0x06                   ;1Hz->clk/256/128       (  1 clock ) 
 320               			#else                                                                                  
 321               			LDI   R18                , 0x20                   ;1000Hz->clk/1/32       (  1 clock ) 
 322               			LDI   R19                , 0x01                   ;1000Hz->clk/1/32       (  1 clock ) 
 323               			#endif                                                                                 
 324               			STS   SROCR2A            , R18                    ;set compare match val  (  2 clocks) 
 325               			LDI   R18                , 0x00                   ;set val to reg         (  1 clock ) 
 326               			STS   SROCR2B            , R18                    ;clear OCR2B            (  2 clocks) 
 327               			LDI   R18                , 0x02                   ;set CTC mode           (  1 clock ) 
 328               			STS   SRTCCR2A           , R18                    ;set val to TCCR2A      (  2 clocks) 
 329               			STS   SRTCCR2B           , R19                    ;set prescaler          (  2 clocks) 
 330               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 331               			STS   SRTCNT2            , R18                    ;clear TCNT2            (  2 clocks) 
 332               		_KER_TC2_AUB\@:                                                                            
 333               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 334               	        ANDI  R18                , 0x02                   ;check bit TCR2AUB      (  1 clock ) 
 335               			BRNE  _KER_TC2_AUB\@                              ;wait until AUB cleared (  2 clocks) 
 336               		_KER_TC2_BUB\@:                                                                            
 337               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 338               	        ANDI  R18                , 0x01                   ;check bit TCR2BUB      (  1 clock ) 
 339               			BRNE  _KER_TC2_BUB\@                              ;wait until BUB cleared (  2 clocks) 
 340               		_KER_OC2_AUB\@:                                                                            
 341               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 342               	        ANDI  R18                , 0x08                   ;check bit OR2AUB       (  1 clock ) 
 343               			BRNE  _KER_OC2_AUB\@                              ;wait until AUB cleared (  2 clocks) 
 344               		_KER_OC2_BUB\@:                                                                            
 345               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 346               	        ANDI  R18                , 0x04                   ;check bit OCR2BUB      (  1 clock ) 
 347               			BRNE  _KER_OC2_BUB\@                              ;wait until BUB cleared (  2 clocks) 
 348               		_KER_TC2_UB\@:                                                                             
 349               		    LDS   R18                , SRASSR                 ;load ASSR              (  2 clocks) 
 350               	        ANDI  R18                , 0x10                   ;check bit TCNT2UB      (  1 clock ) 
 351               			BRNE  _KER_TC2_UB\@                               ;wait until BUB cleared (  2 clocks) 
 352               		_KER_TC2_TOV2\@:                                                                           
 353               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 354               	        ANDI  R18                , 0x01                   ;check bit TOV2         (  1 clock ) 
 355               	        BREQ  _KER_TC2_OCF2A\@                            ;bit cleared, jump next (  2 clocks) 
 356               			LDI   R18                , 0x01                   ;set bit                (  1 clock ) 
 357               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 358               	    _KER_TC2_OCF2A\@:                                                                          
 359               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 360               	        ANDI  R18                , 0x02                   ;check bit OCF2A        (  1 clock ) 
 361               	        BREQ  _KER_TC2_OCF2B\@                            ;bit cleared, jump next (  2 clocks) 
 362               			LDI   R18                , 0x02                   ;set bit                (  1 clock ) 
 363               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 364               		_KER_TC2_OCF2B\@:                                                                          
 365               		    LDS   R18                , SRTIFR2                ;load TIFR2             (  2 clocks) 
 366               	        ANDI  R18                , 0x04                   ;check bit OCF2B        (  1 clock ) 
 367               	        BREQ  _KER_TC2_INTEN\@                            ;bit cleared, jump next (  2 clocks) 
 368               			LDI   R18                , 0x04                   ;set bit                (  1 clock ) 
 369               			STS   SRTIFR2            , R18                    ;set val                (  2 clocks) 
 370               	    _KER_TC2_INTEN\@:                                                                          
 371               			LDI   R18                , 0x02                   ;set TOIE2 bit          (  1 clock ) 
 372               			STS   SRTIMSK2           , R18                    ;set val to TIMSK2      (  2 clocks) 
 373               	.endm                                                                                          
 374               	;;=================================timer2 async init end====================================;; 
 375               	
 376               	
 377               	
 378               	
 379               	
 380               	;;====================================timer init starting===================================;; 
 381               	;used registers          : R18, R19                                                            
 382               	;arg registers           : None                                                                
 383               	;return registers        : None                                                                
 384               	;unsafe access registers : R18, R19                                                            
 385               	.macro  KER_TIMER_INIT                                    ;~9.13uS max @8MHz      (~73 clocks) 
 386               	        #ifdef KER_WDT_AS_TICK_SRC                                                             
 387               			KER_WDT_INIT                                      ;WDT tick src           (  9 clocks) 
 388               	        #elif defined(KER_TIMER2_AS_TICK_SRC)                                                  
 389               			KER_TIMER2_INIT                                   ;TIM2COMPA tick src     ( 20 clocks) 
 390               			#elif defined(KER_TIMER2_ASYNC_AS_TICK_SRC)                                            
 391               			KER_TIMER2_ASYNC_INIT                             ;total 1.5uS @8MHz      (~73 clocks) 
 392               			#else                                                                                  
 393               	        KER_TIMER2_INIT                                   ;Default: TIM2COMPA     ( 20 clocks) 
 394               			#endif                                                                                 
 395               	.endm                                                                                          
 396               	;;======================================timer init end======================================;; 
 397               	
 398               	
 399               	
 400               	
 401               	
 402               	;;============================debug pin operation init starting=============================;; 
 403               	;used registers          : None                                                                
 404               	;arg registers           : None                                                                
 405               	;return registers        : None                                                                
 406               	;unsafe access registers : None                                                                
 407               	.macro  KER_DEBUG_PIN_INIT                                ;total 0.5uS @8MHz      (  4 clocks) 
 408               	        #ifdef KER_DBG_ENABLE                                                                  
 409               			CBI   KER_DBG_PORT       , KER_DBG_PIN            ;clear port bit         (  2 clocks) 
 410               			SBI   KER_DBG_DDR        , KER_DBG_PIN            ;set bit in DDR         (  2 clocks) 
 411               			#endif                                                                                 
 412               	.endm                                                                                          
 413               	;;==============================debug pin operation init end================================;; 
 414               	
 415               	
 416               	
 417               	
 418               	
 419               	;;===========================debug pin operation set starting===============================;; 
 420               	;used registers          : None                                                                
 421               	;arg registers           : None                                                                
 422               	;return registers        : None                                                                
 423               	;unsafe access registers : None                                                                
 424               	.macro  KER_DEBUG_PIN_SET                                 ;total 0.25uS @8MHz     (  2 clocks) 
 425               	        #ifdef KER_DBG_ENABLE                                                                  
 426               	        SBI   KER_DBG_PORT       , KER_DBG_PIN            ;set gpio               (  2 clocks) 
 427               			#endif                                                                                 
 428               	.endm                                                                                          
 429               	;;==============================debug pin operation set end=================================;; 
 430               	
 431               	
 432               	
 433               	
 434               	
 435               	;;===========================debug pin operation clear starting=============================;; 
 436               	;used registers          : None                                                                
 437               	;arg registers           : None                                                                
 438               	;return registers        : None                                                                
 439               	;unsafe access registers : None                                                                
 440               	.macro  KER_DEBUG_PIN_CLEAR                               ;total 0.25uS @8MHz     (  2 clocks) 
 441               	        #ifdef KER_DBG_ENABLE                                                                  
 442               			CBI   KER_DBG_PORT       , KER_DBG_PIN            ;clear gpio             (  2 clocks) 
 443               			#endif                                                                                 
 444               	.endm                                                                                          
 445               	;;==============================debug pin operation clear end===============================;; 
 446               	
 447               	
 448               	
 449               	
 450               	
 451               	;;=================================save r0 & sreg starting==================================;; 
 452               	;used registers          : R0                                                                  
 453               	;arg registers           : None                                                                
 454               	;return registers        : None                                                                
 455               	;unsafe access registers : None                                                                
 456               	.macro  KER_SAVE_R0_SREG                                  ;total 0.63uS @8MHz     (  5 clocks) 
 457               	        PUSH  R0                                          ;save R0                (  2 clocks) 
 458               			IN    R0                 , IOSREG                 ;load SREG              (  1 clock ) 
 459               			PUSH  R0                                          ;save SREG              (  2 clocks) 
 460               	.endm                                                                                          
 461               	;;====================================save r0 & sreg end====================================;; 
 462               	
 463               	
 464               	
 465               	
 466               	
 467               	;;===============================save r0, sreg & cli starting===============================;; 
 468               	;used registers          : R0                                                                  
 469               	;arg registers           : None                                                                
 470               	;return registers        : None                                                                
 471               	;unsafe access registers : None                                                                
 472               	.macro  KER_SAVE_R0_CLI_SREG                              ;total 0.75uS @8MHz     (  6 clocks) 
 473               	        PUSH  R0                                          ;push R0                (  2 clocks) 
 474               			IN    R0                 , IOSREG                 ;save SREG              (  1 clock ) 
 475               			CLI                                               ;clear interrupt        (  1 clock ) 
 476               			PUSH  R0                                          ;save SREG              (  2 clocks) 
 477               	.endm                                                                                          
 478               	;;=================================save r0, sreg & cli end==================================;; 
 479               	
 480               	
 481               	
 482               	
 483               	
 484               	;;===================================save r1~r31 starting===================================;; 
 485               	;used registers          : R1~R31                                                              
 486               	;arg registers           : None                                                                
 487               	;return registers        : None                                                                
 488               	;unsafe access registers : None                                                                
 489               	.macro  KER_SAVE_R1_R31                                   ;total 7.88uS @8MHz     ( 63 clocks) 
 490               			PUSH  R1                                          ;save R1                (  2 clocks) 
 491               			CLR   R1                                          ;clear R1               (  1 clock ) 
 492               			PUSH  R2                                          ;save R2                (  2 clocks) 
 493               			PUSH  R3                                          ;save R3                (  2 clocks) 
 494               			PUSH  R4                                          ;save R4                (  2 clocks) 
 495               			PUSH  R5                                          ;save R5                (  2 clocks) 
 496               			PUSH  R6                                          ;save R6                (  2 clocks) 
 497               			PUSH  R7                                          ;save R7                (  2 clocks) 
 498               			PUSH  R8                                          ;save R8                (  2 clocks) 
 499               			PUSH  R9                                          ;save R9                (  2 clocks) 
 500               			PUSH  R10                                         ;save R10               (  2 clocks) 
 501               			PUSH  R11                                         ;save R11               (  2 clocks) 
 502               			PUSH  R12                                         ;save R12               (  2 clocks) 
 503               			PUSH  R13                                         ;save R13               (  2 clocks) 
 504               			PUSH  R14                                         ;save R14               (  2 clocks) 
 505               			PUSH  R15                                         ;save R15               (  2 clocks) 
 506               			PUSH  R16                                         ;save R16               (  2 clocks) 
 507               			PUSH  R17                                         ;save R17               (  2 clocks) 
 508               			PUSH  R18                                         ;save R18               (  2 clocks) 
 509               			PUSH  R19                                         ;save R19               (  2 clocks) 
 510               			PUSH  R20                                         ;save R20               (  2 clocks) 
 511               			PUSH  R21                                         ;save R21               (  2 clocks) 
 512               			PUSH  R22                                         ;save R22               (  2 clocks) 
 513               			PUSH  R23                                         ;save R23               (  2 clocks) 
 514               			PUSH  R24                                         ;save R24               (  2 clocks) 
 515               			PUSH  R25                                         ;save R25               (  2 clocks) 
 516               			PUSH  R26                                         ;save R26               (  2 clocks) 
 517               			PUSH  R27                                         ;save R27               (  2 clocks) 
 518               			PUSH  R28                                         ;save R28               (  2 clocks) 
 519               			PUSH  R29                                         ;save R29               (  2 clocks) 
 520               			PUSH  R30                                         ;save R30               (  2 clocks) 
 521               			PUSH  R31                                         ;save R31               (  2 clocks) 
 522               	.endm                                                                                          
 523               	;;======================================save r1~r31 end=====================================;; 
 524               	
 525               	
 526               	
 527               	
 528               	
 529               	;;==============================context save handler starting===============================;; 
 530               	;used registers          : R0~R31                                                              
 531               	;arg registers           : None                                                                
 532               	;return registers        : None                                                                
 533               	;unsafe access registers : None                                                                
 534               	.macro  KER_CONTEXT_SAVE_HANDLER                          ;total 8.5uS @8MHz      ( 68 clocks) 
 535               	        KER_SAVE_R0_SREG                                  ;save r0, sreg          (  5 clocks) 
 536               	        KER_SAVE_R1_R31                                   ;save r1~r31            ( 63 clocks) 
 537               	.endm                                                                                          
 538               	;;=================================context save handler end=================================;; 
 539               	
 540               	
 541               	
 542               	
 543               	
 544               	;;===============================context save thread starting===============================;; 
 545               	;used registers          : R0~R31                                                              
 546               	;arg registers           : None                                                                
 547               	;return registers        : None                                                                
 548               	;unsafe access registers : None                                                                
 549               	.macro  KER_CONTEXT_SAVE_THREAD                           ;total 8.63uS @8MHz     ( 69 clocks) 
 550               	        KER_SAVE_R0_CLI_SREG                              ;save r0, sreg          (  6 clocks) 
 551               	        KER_SAVE_R1_R31                                   ;save r1~r31            ( 63 clocks) 
 552               	.endm                                                                                          
 553               	;;==================================context save thread end=================================;; 
 554               	
 555               	
 556               	
 557               	
 558               	
 559               	
 560               	;;================================restore r0 & sreg starting================================;; 
 561               	;used registers          : R0                                                                  
 562               	;arg registers           : None                                                                
 563               	;return registers        : None                                                                
 564               	;unsafe access registers : None                                                                
 565               	.macro  KER_RESTORE_R0_SREG                               ;total 0.63uS @8MHz     (  5 clocks) 
 566               	        POP   R0                                          ;fetch SREG             (  2 clocks) 
 567               			OUT   IOSREG             , R0                     ;load SREG              (  1 clock ) 
 568               			POP   R0                                          ;restore R0             (  2 clocks) 
 569               	.endm                                                                                          
 570               	;;==================================restore r0 & sreg end===================================;; 
 571               	
 572               	
 573               	
 574               	
 575               	
 576               	;;==============================restore r0, sreg & sei starting=============================;; 
 577               	;used registers          : R0                                                                  
 578               	;arg registers           : None                                                                
 579               	;return registers        : None                                                                
 580               	;unsafe access registers : None                                                                
 581               	.macro  KER_RESTORE_R0_SREG_SEI                           ;total 0.75uS @8MHz     (  6 clocks) 
 582               	        POP   R0                                          ;fetch SREG             (  2 clocks) 
 583               			OUT   IOSREG             , R0                     ;load SREG              (  1 clock ) 
 584               			POP   R0                                          ;restore R0             (  2 clocks) 
 585               			SEI                                               ;enable interrupt       (  1 clock ) 
 586               	.endm                                                                                          
 587               	;;===============================restore r0, sreg & sei end=================================;; 
 588               	
 589               	
 590               	
 591               	
 592               	
 593               	;;=================================restore r1~r31 starting==================================;; 
 594               	;used registers          : R1~R31                                                              
 595               	;arg registers           : None                                                                
 596               	;return registers        : None                                                                
 597               	;unsafe access registers : None                                                                
 598               	.macro  KER_RESTORE_R1_R31                                ;total 8.38uS @8MHz     ( 62 clocks) 
 599               			POP   R31                                         ;restore R31            (  2 clocks) 
 600               			POP   R30                                         ;restore R30            (  2 clocks) 
 601               			POP   R29                                         ;restore R29            (  2 clocks) 
 602               			POP   R28                                         ;restore R28            (  2 clocks) 
 603               			POP   R27                                         ;restore R27            (  2 clocks) 
 604               			POP   R26                                         ;restore R26            (  2 clocks) 
 605               			POP   R25                                         ;restore R25            (  2 clocks) 
 606               			POP   R24                                         ;restore R24            (  2 clocks) 
 607               			POP   R23                                         ;restore R23            (  2 clocks) 
 608               			POP   R22                                         ;restore R22            (  2 clocks) 
 609               			POP   R21                                         ;restore R21            (  2 clocks) 
 610               			POP   R20                                         ;restore R20            (  2 clocks) 
 611               			POP   R19                                         ;restore R19            (  2 clocks) 
 612               			POP   R18                                         ;restore R18            (  2 clocks) 
 613               			POP   R17                                         ;restore R17            (  2 clocks) 
 614               			POP   R16                                         ;restore R16            (  2 clocks) 
 615               			POP   R15                                         ;restore R15            (  2 clocks) 
 616               			POP   R14                                         ;restore R14            (  2 clocks) 
 617               			POP   R13                                         ;restore R13            (  2 clocks) 
 618               			POP   R12                                         ;restore R12            (  2 clocks) 
 619               			POP   R11                                         ;restore R11            (  2 clocks) 
 620               			POP   R10                                         ;restore R10            (  2 clocks) 
 621               			POP   R9                                          ;restore R9             (  2 clocks) 
 622               			POP   R8                                          ;restore R8             (  2 clocks) 
 623               			POP   R7                                          ;restore R7             (  2 clocks) 
 624               			POP   R6                                          ;restore R6             (  2 clocks) 
 625               			POP   R5                                          ;restore R5             (  2 clocks) 
 626               			POP   R4                                          ;restore R4             (  2 clocks) 
 627               			POP   R3                                          ;restore R3             (  2 clocks) 
 628               			POP   R2                                          ;restore R2             (  2 clocks) 
 629               			POP   R1                                          ;restore R1             (  2 clocks) 
 630               	.endm                                                                                          
 631               	;;====================================restore r1~r31 end====================================;; 
 632               	
 633               	
 634               	
 635               	
 636               	
 637               	;;=============================context restore handler starting=============================;; 
 638               	;used registers          : R0~R31                                                              
 639               	;arg registers           : None                                                                
 640               	;return registers        : None                                                                
 641               	;unsafe access registers : None                                                                
 642               	.macro  KER_CONTEXT_RESTORE_HANDLER                       ;total 8.38uS @8MHz     ( 67 clocks) 
 643               	        KER_RESTORE_R1_R31                                ;restore r1~r31         ( 62 clocks) 
 644               			KER_RESTORE_R0_SREG                               ;restore r0, sreg       (  5 clocks) 
 645               	.endm                                                                                          
 646               	;;===============================context restore handler end================================;; 
 647               	
 648               	
 649               	
 650               	
 651               	
 652               	;;=============================context restore thread starting==============================;; 
 653               	;used registers          : R0~R31                                                              
 654               	;arg registers           : None                                                                
 655               	;return registers        : None                                                                
 656               	;unsafe access registers : None                                                                
 657               	.macro  KER_CONTEXT_RESTORE_THREAD                        ;total 8.75uS @8MHz     ( 68 clocks) 
 658               	        KER_RESTORE_R1_R31                                ;restore r1~r31         ( 62 clocks) 
 659               			KER_RESTORE_R0_SREG_SEI                           ;restore r0, sreg       (  6 clocks) 
 660               	.endm                                                                                          
 661               	;;================================context restore thread end================================;; 
 662               	
 663               	
 664               	
 665               	
 666               	
 667               	;;=========================calculate offset addr in words starting==========================;; 
 668               	;used registers          : R18, R30(ZL), R31(ZH)                                               
 669               	;arg registers           : R30(ZL), R31(ZH)                                                    
 670               	;return registers        : R30(ZL), R31(ZH)                                                    
 671               	;unsafe access registers : R18, R30(ZL), R31(ZH)                                               
 672               	.macro  KER_CALC_ADDR_OFF_WORD                            ;total 0.75uS @8MHz     (  6 clocks) 
 673               	        LDS   R18                , KerBase+OFB_TID        ;fetch task_id          (  2 clocks) 
 674               			LSL   R18                                         ;left shift to multiply (  1 clock ) 
 675               			ADD   R30                , R18                    ;add offset to array    (  1 clock ) 
 676               			LDI   R18                , 0x00                   ;clear for carry prop   (  1 clock ) 
 677               			ADC   R31                , R18                    ;add carry if any       (  1 clock ) 
 678               	.endm                                                                                          
 679               	;;=============================calculate offset addr in words end===========================;; 
 680               	
 681               	
 682               	
 683               	
 684               	
 685               	;;=========================calculate offset addr in bytes starting==========================;; 
 686               	;used registers          : R18, R30(ZL), R31(ZH)                                               
 687               	;arg registers           : R30(ZL), R31(ZH)                                                    
 688               	;return registers        : R30(ZL), R31(ZH)                                                    
 689               	;unsafe access registers : R18, R30(ZL), R31(ZH)                                               
 690               	.macro  KER_CALC_ADDR_OFF_BYTES                           ;total 0.63uS @8MHz     (  5 clocks) 
 691               	        LDS   R18                , KerBase+OFB_TID        ;fetch task_id          (  2 clocks) 
 692               			ADD   R30                , R18                    ;add offset to array    (  1 clock ) 
 693               			LDI   R18                , 0x00                   ;clear for carry prop   (  1 clock ) 
 694               			ADC   R31                , R18                    ;add carry if any       (  1 clock ) 
 695               	.endm                                                                                          
 696               	;;=============================calculate offset addr in bytes end===========================;; 
 697               	
 698               	
 699               	
 700               	
 701               	
 702               	;;===============================save current task sp starting==============================;; 
 703               	;used registers          : R18, R19, R30(ZL), R31(ZH)                                          
 704               	;arg registers           : None                                                                
 705               	;return registers        : None                                                                
 706               	;unsafe access registers : R18, R19, R30(ZL), R31(ZH)                                          
 707               	.macro  KER_SAVE_CURR_TASK_SP                             ;total 1.75uS @8MHz     ( 14 clocks) 
 708               			LDI   R30                , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
 709               			LDI   R31                , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
 710               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 711               			IN    R18                , IOSPL                  ;fetch SPL0             (  1 clock ) 
 712               			IN    R19                , IOSPH                  ;fetch SPH0             (  1 clock ) 
 713               			STD   Z+0                , R18                    ;store SPL at ZP+0      (  2 clocks) 
 714               			STD   Z+1                , R19                    ;store SPH at ZP+1      (  2 clocks) 
 715               	.endm                                                                                          
 716               	;;================================save current task sp end==================================;; 
 717               	
 718               	
 719               	
 720               	
 721               	
 722               	;;==============================increment tick counter starting=============================;; 
 723               	;used registers          : R18, R19                                                            
 724               	;arg registers           : None                                                                
 725               	;return registers        : None                                                                
 726               	;unsafe access registers : R18, R19                                                            
 727               	.macro  KER_TICK_INCREMENT                                ;total 3.25uS @8MHz     ( 27 clocks) 
 728               	        LDI   R18                , 0x01                   ;load 1                 (  1 clock ) 
 729               			LDS   R19                , KerBase+OFB_TICK0      ;load Byte0             (  2 clocks) 
 730               			ADD   R19                , R18                    ;add 1 with current val (  1 clock ) 
 731               			STS   KerBase+OFB_TICK0  , R19                    ;set Byte0              (  2 clocks) 
 732               			LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
 733               			LDS   R19                , KerBase+OFB_TICK1      ;load Byte1             (  2 clocks) 
 734               			ADC   R19                , R18                    ;add carry with Byte1   (  1 clock ) 
 735               			STS   KerBase+OFB_TICK1  , R19                    ;set Byte1              (  2 clocks) 
 736               			LDS   R19                , KerBase+OFB_TICK2      ;load Byte2             (  2 clocks) 
 737               			ADC   R19                , R18                    ;add carry with Byte2   (  1 clock ) 
 738               			STS   KerBase+OFB_TICK2  , R19                    ;set Byte2              (  2 clocks) 
 739               			LDS   R19                , KerBase+OFB_TICK3      ;load Byte3             (  2 clocks) 
 740               			ADC   R19                , R18                    ;add carry with Byte3   (  1 clock ) 
 741               			STS   KerBase+OFB_TICK3  , R19                    ;set Byte3              (  2 clocks) 
 742               			LDS   R19                , KerBase+OFB_TICK4      ;load Byte4             (  2 clocks) 
 743               			ADC   R19                , R18                    ;add carry with Byte4   (  1 clock ) 
 744               			STS   KerBase+OFB_TICK4  , R19                    ;set Byte4              (  2 clocks) 
 745               	.endm                                                                                          
 746               	;;=================================increment tick counter end===============================;; 
 747               	
 748               	
 749               	
 750               	
 751               	
 752               	;;==============================load task id & sp starting==================================;; 
 753               	;used registers          : R18, R19, R30(ZL), R31(ZH)                                          
 754               	;arg registers           : None                                                                
 755               	;return registers        : None                                                                
 756               	;unsafe access registers : R18, R19, R30(ZL), R31(ZH)                                          
 757               	.macro  KER_LOAD_TASK_ID_AND_SP                           ;total 1.75uS @8MHz     ( 14 clocks) 
 758               			LDI   R30                , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
 759               			LDI   R31                , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
 760               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 761               			LDD   R18                , Z+0                    ;load SPL at ZP         (  2 clocks) 
 762               			LDD   R19                , Z+1                    ;load SPH at ZP         (  2 clocks) 
 763               			OUT   IOSPL              , R18                    ;load SPL0              (  1 clock ) 
 764               			OUT   IOSPH              , R19                    ;load SPH0              (  1 clock ) 
 765               	.endm                                                                                          
 766               	;;=================================load task id & sp end====================================;; 
 767               	
 768               	
 769               	
 770               	
 771               	
 772               	;;================================push msp & zp starting====================================;; 
 773               	;used registers          : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 774               	;arg registers           : None                                                                
 775               	;return registers        : None                                                                
 776               	;unsafe access registers : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 777               	.macro  KER_PUSH_MSP_ZP                                   ;total 2.25uS @8MHz     ( 18 clocks) 
 778               	        LDS   R26                , KerSSZ+OFM_MSPI+0      ;load val low           (  2 clocks) 
 779               			LDS   R27                , KerSSZ+OFM_MSPI+1      ;load val high          (  2 clocks) 
 780               			IN    R18                , IOSPL                  ;copy                   (  1 clock ) 
 781               			IN    R19                , IOSPH                  ;copy                   (  1 clock ) 
 782               			ST    X+                 , R18                    ;store main SPL         (  2 clocks) 
 783               	        ST    X+                 , R19                    ;store main SPH         (  2 clocks) 
 784               			ST    X+                 , R30                    ;store main ZL          (  2 clocks) 
 785               			ST    X+                 , R31                    ;store main ZH          (  2 clocks) 
 786               			STS   KerSSZ+OFM_MSPI+0  , R26                    ;store new index        (  2 clocks) 
 787               			STS   KerSSZ+OFM_MSPI+1  , R27                    ;store new index        (  2 clocks) 
 788               	.endm                                                                                          
 789               	;;===================================push msp & zp end======================================;; 
 790               	
 791               	
 792               	
 793               	
 794               	
 795               	;;=================================pop msp & zp starting====================================;; 
 796               	;used registers          : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 797               	;arg registers           : None                                                                
 798               	;return registers        : None                                                                
 799               	;unsafe access registers : R18, R19, R26(XL), R27(XH), R30(ZL), R31(ZH)                        
 800               	.macro  KER_POP_MSP_ZP                                    ;total 2.25uS @8MHz     ( 18 clocks) 
 801               			LDS   R26                , KerSSZ+OFM_MSPI+0      ;load val low           (  2 clocks) 
 802               			LDS   R27                , KerSSZ+OFM_MSPI+1      ;load val high          (  2 clocks) 
 803               			LD    R31                , -X                     ;load ZH                (  2 clocks) 
 804               			LD    R30                , -X                     ;load ZL                (  2 clocks) 
 805               			LD    R19                , -X                     ;load main SPH          (  2 clocks) 
 806               			LD    R18                , -X                     ;load main SPL          (  2 clocks) 
 807               			OUT   IOSPL              , R18                    ;set SPL                (  1 clock ) 
 808               			OUT   IOSPH              , R19                    ;set SPH                (  1 clock ) 
 809               			STS   KerSSZ+OFM_MSPI+0  , R26                    ;store new index        (  2 clocks) 
 810               			STS   KerSSZ+OFM_MSPI+1  , R27                    ;store new index        (  2 clocks) 
 811               	.endm                                                                                          
 812               	;;====================================pop msp & zp end======================================;; 
 813               	
 814               	
 815               	
 816               	
 817               	
 818               	;;============================sleep timeout management starting=============================;; 
 819               	;used registers          : R18, R19, R20, R24, R30(ZL), R31(ZH)                                
 820               	;arg registers           : R24 (SCH_MODE_HANDLER/SCH_MODE_THREAD)                              
 821               	;return registers        : R24 (READY/BLOCKED/EXECUTING/SUSPENDED/CONS_LAT)                    
 822               	;unsafe access registers : R18, R19, R20, R24, R30(ZL), R31(ZH)                                
 823               	.macro  KER_SLP_TIME_MGNT                                 ;total 6.50uS @8MHz     ( 52 clocks) 
 824               			LDI   R30                , lo8(KerSchSlp)         ;fetch base pos low     (  1 clock ) 
 825               			LDI   R31                , hi8(KerSchSlp)         ;fetch base pos high    (  1 clock ) 
 826               			KER_CALC_ADDR_OFF_WORD                            ;calc offset            (  6 clocks) 
 827               			;fetch current value from ram, if val=0, skip decrement                                
 828               	        LDD   R18                , Z+0                    ;load val low byte      (  2 clocks) 
 829               			LDD   R19                , Z+1                    ;load val high byte     (  2 clocks) 
 830               			MOV   R20                , R18                    ;copy                   (  1 clock ) 
 831               			OR    R20                , R19                    ;or high & low bytes    (  1 clock ) 
 832               			BREQ  _VAL_NULL\@                                 ;val=0, save sts        (  2 clocks) 
 833               	        CPI   R24                , SCH_MODE_THREAD        ;if arg=1, thread mode  (  1 clock ) 
 834               			BREQ  _VAL_NOT_NULL\@                             ;no need to dec val     (  2 clocks) 
 835               			;R19:R18 contains 16 bit sleep timer val, decrease val by 1                            
 836               			LDI   R20                , 0x01                   ;set val 1              (  1 clock ) 
 837               	        SUB   R18                , R20                    ;subtract low byte      (  1 clock ) 
 838               			LDI   R20                , 0x00                   ;clear                  (  1 clock ) 
 839               			SBC   R19                , R20                    ;subtract carry if any  (  1 clock ) 
 840               			;store new value                                                                       
 841               			STD   Z+0                , R18                    ;store low byte         (  2 clocks) 
 842               			STD   Z+1                , R19                    ;store low byte         (  2 clocks) 
 843               			MOV   R20                , R18                    ;copy                   (  1 clock ) 
 844               			OR    R20                , R19                    ;or high & low bytes    (  1 clock ) 
 845               			BRNE  _VAL_NOT_NULL\@                             ;val!=0                 (  2 clocks) 
 846               		_VAL_NULL\@:                                                                               
 847               		    ;find ram address for status                                                           
 848               		    LDI   R30                , lo8(KerSchSts)         ;fetch base pos low     (  1 clock ) 
 849               			LDI   R31                , hi8(KerSchSts)         ;fetch base pos high    (  1 clock ) 
 850               	        KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
 851               			;update flag as task is ready                                                          
 852               			LDI   R24                , TASK_READY             ;set TASK_READY         (  1 clock ) 
 853               			ST    Z                  , R24                    ;update flag            (  2 clocks) 
 854               			RJMP  _EXIT_SLP_TIME\@                            ;jump to exit           (  2 clocks) 
 855               	    _VAL_NOT_NULL\@:                                                                           
 856               		    LDI   R30                , lo8(KerSchSts)         ;fetch base pos low     (  1 clock ) 
 857               			LDI   R31                , hi8(KerSchSts)         ;fetch base pos high    (  1 clock ) 
 858               	        KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
 859               		    LD    R24                , Z                      ;return sts             (  2 clocks) 
 860               	    _EXIT_SLP_TIME\@:                                                                          
 861               	.endm                                                                                          
 862               	;;============================sleep timeout management end==================================;; 
 863               	
 864               	
 865               	
 866               	
 867               	
 868               	;;============================current task priority starting================================;; 
 869               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 870               	;arg registers           : None                                                                
 871               	;return registers        : R24 (Current task priority)                                         
 872               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 873               	.macro  KER_CURR_TASK_PRIO                                ;total 1.13uS @8MHz     (  9 clocks) 
 874               			LDI    R30               , lo8(KerSchPr)          ;load low addr          (  1 clock ) 
 875               			LDI    R31               , hi8(KerSchPr)          ;load high addr         (  1 clock ) 
 876               			LDI    R18               , 0x00                   ;clear reg, for carry   (  1 clock ) 
 877               			LDS    R24               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 878               	        ADD    R30               , R24                    ;add low addr           (  1 clock ) 
 879               			ADC    R31               , R18                    ;add carry if any       (  1 clock ) 
 880               			LD     R24               , Z                      ;load current tid prio  (  2 clocks) 
 881               	.endm                                                                                          
 882               	;;==============================current task priority end===================================;; 
 883               	
 884               	
 885               	
 886               	
 887               	
 888               	;;================================run scheduler starting====================================;; 
 889               	;used registers          : R18, R19, R20, R21, R24, R25, R30(ZL), R31(ZH)                      
 890               	;arg registers           : R24 (SCH_MODE_HANDLER/SCH_MODE_THREAD)                              
 891               	;return registers        : None                                                                
 892               	;unsafe access registers : R18, R19, R20, R21, R24, R25, R30(ZL), R31(ZH)                      
 893               	.macro  KER_RUN_SCHEDULER                                 ;total 13.25uS @8MHz    (106 clocks) 
 894               			LDI    R18               , 0xFF                   ;set 0xff               (  1 clock ) 
 895               			STS    KerBase+OFB_LPR   , R18                    ;lowest priority        (  2 clocks) 
 896               			LDI    R18               , 0x00                   ;start from 0           (  1 clock ) 
 897               			STS    KerBase+OFB_PTID  , R18                    ;highest prio tid=0     (  2 clocks) 
 898               			MOV    R21               , R24                    ;copy sch mode          (  1 clock ) 
 899               		_KER_SCH_LOOP\@:                                                                           
 900               		    ;store task id to run from KER_DEC_SLP_TIMEOUT                                         
 901               			STS    KerBase+OFB_TID   , R18                    ;store task id          (  2 clocks) 
 902               	        ;sleep time decrement, update ready/blocked status                                     
 903               			MOV    R24               , R21                    ;restore sch mode       (  1 clock ) 
 904               			KER_SLP_TIME_MGNT                                 ;update return vars     ( 52 clocks) 
 905               	        CPI    R24               , TASK_READY             ;compare                (  1 clock ) 
 906               	        BREQ   _KER_CALC_PRIO\@                           ;calc priority if ready (  2 clocks) 
 907               			CPI    R24               , TASK_CONS_LAT          ;compare                (  1 clock ) 
 908               	        BREQ   _KER_CALC_PRIO\@                           ;calc priority if c_lat (  2 clocks) 
 909               	        RJMP   _KER_SCH_NEXT\@                            ;skip if !ready|c_lat   (  2 clocks) 
 910               		_KER_CALC_PRIO\@:                                                                          
 911               			KER_CURR_TASK_PRIO                                ;get task prio ->R24    (  9 clocks) 
 912               	        ;compare current task priority with lowest priority found so far                       
 913               			LDS    R18               , KerBase+OFB_LPR        ;load lowest priority   (  2 clocks) 
 914               			CP     R24               , R18                    ;compare                (  1 clock ) 
 915               			BRSH   _KER_SCH_NEXT\@                            ;if prio>=lowest prio   (  2 clocks) 
 916               			;found new lowest priority                                                             
 917               			STS    KerBase+OFB_LPR   , R24                    ;save lowest priority   (  2 clocks) 
 918               			LDS    R18               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 919               			STS    KerBase+OFB_PTID  , R18                    ;save lowest priority   (  2 clocks) 
 920               	                                                                                               
 921               	    _KER_SCH_NEXT\@:                                                                           
 922               		    LDS    R18               , KerBase+OFB_TID        ;load task id           (  2 clocks) 
 923               			INC    R18                                        ;increment by 1         (  1 clock ) 
 924               			LDS    R19               , KerBase+OFB_NTSK       ;load ntask             (  2 clocks) 
 925               			CP     R18               , R19                    ;compare with ntask     (  2 clocks) 
 926               			BRSH   _KER_SCH_EXIT\@                            ;if task_id>=ntask      (  2 clocks) 
 927               			RJMP   _KER_SCH_LOOP\@                            ;jump to entry          (  2 clocks) 
 928               		_KER_SCH_EXIT\@:                                                                           
 929               	        LDS    R18               , KerBase+OFB_PTID       ;load high prio task id (  2 clocks) 
 930               			STS    KerBase+OFB_TID   , R18                    ;for test only          (  2 clocks) 
 931               	.endm                                                                                          
 932               	;;===================================run scheduler end======================================;; 
 933               	
 934               	
 935               	
 936               	
 937               	
 938               	;;================================calc cpu usage starting===================================;; 
 939               	;used registers          : R18, R19                                                            
 940               	;arg registers           : None                                                                
 941               	;return registers        : None                                                                
 942               	;unsafe access registers : R18, R19                                                            
 943               	.macro  KER_CPU_USAGE                                     ;total 3.25uS @8MHz     ( 26 clocks) 
 944               	        ;check if current target task is idle task or not                                      
 945               	        LDS    R18               , KerBase+OFB_TID        ;load target task_id    (  2 clocks) 
 946               			TST    R18                                        ;check if idle task     (  1 clock ) 
 947               			BREQ   _KER_USG_TICK\@                            ;task_id=idle, skip     (  2 clocks) 
 948               			LDS    R18               , KerBase+OFB_UATC       ;load active tick cnt   (  2 clocks) 
 949               			INC    R18                                        ;inc active tick cnt    (  1 clock ) 
 950               			STS    KerBase+OFB_UATC  , R18                    ;store new val          (  2 clocks) 
 951               		_KER_USG_TICK\@:                                                                           
 952               			LDS    R18               , KerBase+OFB_UTC        ;load usage tick cnt    (  2 clocks) 
 953               			INC    R18                                        ;increment tick cnt     (  1 clock ) 
 954               			CPI    R18               , 100                    ;compare with 100       (  1 clock ) 
 955               			BRLO   _KER_USG_UTC_SV\@                          ;val<100, save new val  (  2 clocks) 
 956               			LDI    R18               , 0x00                   ;val>=100, roll back    (  1 clock ) 
 957               			LDS    R19               , KerBase+OFB_UATC       ;load active tick cnt   (  2 clocks) 
 958               			STS    KerBase+OFB_USAGE , R19                    ;store usage            (  2 clocks) 
 959               			LDI    R19               , 0x00                   ;clear reg              (  1 clock ) 
 960               			STS    KerBase+OFB_UATC  , R19                    ;clear active tick cnt  (  2 clocks) 
 961               		_KER_USG_UTC_SV\@:                                                                         
 962               			STS    KerBase+OFB_UTC   , R18                    ;store new val          (  2 clocks) 
 963               	.endm                                                                                          
 964               	;;===================================calc cpu usage end=====================================;; 
 965               	
 966               	
 967               	
 968               	
 969               	
 970               	;;===========================kernel disable analog domain starting==========================;; 
 971               	;used registers          : None                                                                
 972               	;arg registers           : None                                                                
 973               	;return registers        : None                                                                
 974               	;unsafe access registers : None                                                                
 975               	.macro KER_DISABLE_ANALOG_DOMAIN                          ;total 0.75uS @8MHz     ( 10 clocks) 
 976               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 977               			LDS   R18                , SRADCSRA               ;load ADCSRA            (  2 clocks) 
 978               			ANDI  R18                , 0x7F                   ;clear ADEN             (  1 clock ) 
 979               			STS   SRADCSRA           , R18                    ;set val                (  2 clocks) 
 980               			LDS   R18                , SRACSR                 ;load ACSR              (  2 clocks) 
 981               			ORI   R18                , 0x80                   ;set ACD                (  1 clock ) 
 982               			STS   SRACSR             , R18                    ;set val                (  2 clocks) 
 983               		#endif                                                                                     
 984               	.endm                                                                                          
 985               	;;=============================kernel disable analog domain end=============================;; 
 986               	
 987               	
 988               	
 989               	
 990               	
 991               	;;===============================kernel sleep config starting===============================;; 
 992               	;used registers          : R18                                                                 
 993               	;arg registers           : None                                                                
 994               	;return registers        : None                                                                
 995               	;unsafe access registers : R18                                                                 
 996               	.macro KER_SLEEP_INIT                                     ;total 0.63uS @8MHz     (  5 clocks) 
 997               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 998               	        #ifdef KER_SLEEP_MODE_IDLE                                                             
 999               			LDI   R18                , 0x00                   ;set SM[2:0] val        (  1 clock ) 
 1000               			#elif defined(KER_SLEEP_MODE_ADC_NR)                                                   
 1001               			LDI   R18                , 0x02                   ;set SM[2:0] val        (  1 clock ) 
 1002               			#elif defined(KER_SLEEP_MODE_POWER_DOWN)                                               
 1003               			LDI   R18                , 0x04                   ;set SM[2:0] val        (  1 clock ) 
 1004               	        #elif defined(KER_SLEEP_MODE_POWER_SAVE)                                               
 1005               			LDI   R18                , 0x06                   ;set SM[2:0] val        (  1 clock ) 
 1006               			#else                                                                                  
 1007               			LDI   R18                , 0x00                   ;set SM[2:0] val        (  1 clock ) 
 1008               			#endif                                                                                 
 1009               			STS   SRSMCR             , R18                    ;set sleep control val  (  2 clocks) 
 1010               			STS   KerBase+OFB_SLCFG  , R18                    ;save sleep control val (  2 clocks) 
 1011               		#endif                                                                                     
 1012               	.endm                                                                                          
 1013               	;;================================kernel sleep config end===================================;; 
 1014               	
 1015               	
 1016               	
 1017               	
 1018               	
 1019               	;;==============================kernel enter sleep mode starting============================;; 
 1020               	;used registers          : None                                                                
 1021               	;arg registers           : None                                                                
 1022               	;return registers        : None                                                                
 1023               	;unsafe access registers : None                                                                
 1024               	.macro KER_ENTER_SLEEP                                    ;total 0.75uS @8MHz     (  6 clocks) 
 1025               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 1026               			LDS   R18                , SRSMCR                 ;load SMCR              (  2 clocks) 
 1027               			ORI   R18                , 0x01                   ;set SE bit             (  1 clock ) 
 1028               			STS   SRSMCR             , R18                    ;set val                (  2 clocks) 
 1029               			SLEEP                                             ;sleep cpu              (  1 clock ) 
 1030               		#endif                                                                                     
 1031               	.endm                                                                                          
 1032               	;;================================kernel enter sleep mode end===============================;; 
 1033               	
 1034               	
 1035               	
 1036               	
 1037               	
 1038               	;;===============================kernel exit sleep mode starting============================;; 
 1039               	;used registers          : None                                                                
 1040               	;arg registers           : None                                                                
 1041               	;return registers        : None                                                                
 1042               	;unsafe access registers : None                                                                
 1043               	.macro KER_EXIT_SLEEP                                     ;total 0.63uS @8MHz     (  5 clocks) 
 1044               	    #ifdef KER_IDLE_AS_SLEEP                                                                   
 1045               	        LDS   R18                , SRSMCR                 ;load SMCR              (  2 clocks) 
 1046               			ANDI  R18                , 0xFE                   ;clear SE bit           (  1 clock ) 
 1047               			STS   SRSMCR             , R18                    ;set val                (  2 clocks) 
 1048               		#endif                                                                                     
 1049               	.endm                                                                                          
 1050               	;;=================================kernel exit sleep mode end===============================;; 
 1051               	
 1052               	
 1053               	
 1054               	
 1055               	
 1056               	;;=================================ISR execution starting===================================;; 
 1057               	#ifdef  KER_WDT_AS_TICK_SRC                                                                    
 1058               	.global  __vector_6                                                                            
 1059               	    __vector_6:                                           ;total 40.00uS @8MHz    (344 clocks) 
 1060               		    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
 1061               			KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
 1062               	        KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1063               			KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1064               			KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
 1065               			LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
 1066               			KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
 1067               			KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
 1068               			KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
 1069               			KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
 1070               		    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
 1071               			LDS   R18                , SRWDTCSR               ;copy WDTCSR            (  2 clocks) 
 1072               			ORI   R18                , 0x40                   ;set WDIE               (  1 clock ) 
 1073               			STS   SRWDTCSR           , R18                    ;set val                (  2 clocks) 
 1074               			RETI                                              ;return from interrupt  (  4 clocks) 
 1075               	#elif defined(KER_TIMER2_AS_TICK_SRC) || defined(KER_TIMER2_ASYNC_AS_TICK_SRC)                 
 1076               	.global  __vector_7                                                                            
 1077               	    __vector_7:                                           ;total 40.00uS @8MHz    (344 clocks) 
1078:kernel.S      **** 	    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
1079:kernel.S      **** 		KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
1080:kernel.S      ****         KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
1081:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
1082:kernel.S      **** 		KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
1083:kernel.S      **** 		LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
1084:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1085:kernel.S      **** 		KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
1086:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1087:kernel.S      **** 		KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
1088:kernel.S      **** 	    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
1089:kernel.S      **** 		RETI                                              ;return from interrupt  (  4 clocks) 
 1090               	#else                                                                                          
 1091               	.global  __vector_7                                                                            
 1092               	    __vector_7:                                           ;total 40.00uS @8MHz    (344 clocks) 
 1093               		    KER_DEBUG_PIN_SET                                 ;debug pin set          (  2 clocks) 
 1094               			KER_EXIT_SLEEP                                    ;exit sleep if enabled  (  5 clocks) 
 1095               	        KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1096               			KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1097               			KER_TICK_INCREMENT                                ;increment tick counter ( 26 clocks) 
 1098               			LDI    R24               , SCH_MODE_HANDLER       ;set sch mode           (  1 clock ) 
 1099               			KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
 1100               			KER_CPU_USAGE                                     ;calc cpu usage         ( 26 clocks) 
 1101               			KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
 1102               			KER_CONTEXT_RESTORE_HANDLER                       ;restore context        ( 67 clocks) 
 1103               		    KER_DEBUG_PIN_CLEAR                               ;debug pin clear        (  2 clocks) 
 1104               			RETI                                              ;return from interrupt  (  4 clocks) 
 1105               	#endif                                                                                         
 1106               	;;====================================ISR execution end=====================================;; 
 1107               	
 1108               	
 1109               	
 1110               	
 1111               	
 1112               	;;================================SysTick reg init starting=================================;; 
 1113               	;used registers          : R18, R19, R22, R24, R26(XL), R27(XH), R30(ZL), R31(ZH)              
 1114               	;arg registers           : R24(Prescaler), R22(ReloadVal)                                      
 1115               	;return registers        : None                                                                
 1116               	;unsafe access registers : R18, R19, R22, R24, R26(XL), R27(XH), R30(ZL), R31(ZH)              
 1117               	Kernel_Tick_Init:                                         ;total 11.50uS @8MHz    ( 92 clocks) 
1118:kernel.S      ****         CLI                                               ;disable global int     (  1 clock ) 
1119:kernel.S      **** 		KER_DEBUG_PIN_INIT                                ;debug pin init         (  4 clocks) 
1120:kernel.S      ****         KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1121               			;clear reg                                                                             
1122:kernel.S      **** 		LDI   R18                , 0x00                   ;set 0x00 to R18        (  1 clock ) 
 1123               			;clear tick counter                                                                    
1124:kernel.S      **** 		STS   KerBase+OFB_TICK0  , R18                    ;clear  KerBase[0]      (  2 clocks) 
1125:kernel.S      **** 		STS   KerBase+OFB_TICK1  , R18                    ;clear  KerBase[1]      (  2 clocks) 
1126:kernel.S      **** 		STS   KerBase+OFB_TICK2  , R18                    ;clear  KerBase[2]      (  2 clocks) 
1127:kernel.S      **** 		STS   KerBase+OFB_TICK3  , R18                    ;clear  KerBase[3]      (  2 clocks) 
1128:kernel.S      **** 		STS   KerBase+OFB_TICK4  , R18                    ;clear  KerBase[4]      (  2 clocks) 
 1129               			;clear system registers                                                                
1130:kernel.S      **** 		STS   KerBase+OFB_PRS    , R18                    ;clear  KerBase[5]      (  2 clocks) 
1131:kernel.S      **** 		STS   KerBase+OFB_RLD    , R18                    ;clear  KerBase[6]      (  2 clocks) 
1132:kernel.S      **** 		STS   KerBase+OFB_TID    , R18                    ;clear  KerBase[7]      (  2 clocks) 
1133:kernel.S      **** 		STS   KerBase+OFB_NTSK   , R18                    ;clear  KerBase[8]      (  2 clocks) 
1134:kernel.S      **** 		STS   KerBase+OFB_LPR    , R18                    ;clear  KerBase[9]      (  2 clocks) 
1135:kernel.S      ****         STS   KerBase+OFB_PTID   , R18                    ;clear  KerBase[10]     (  2 clocks) 
1136:kernel.S      **** 		STS   KerBase+OFB_UTC    , R18                    ;clear  KerBase[11]     (  2 clocks) 
1137:kernel.S      **** 		STS   KerBase+OFB_UATC   , R18                    ;clear  KerBase[12]     (  2 clocks) 
1138:kernel.S      **** 		STS   KerBase+OFB_USAGE  , R18                    ;clear  KerBase[13]     (  2 clocks) 
 1139               			;clear all timer registers                                                             
 1140               	        #ifdef KER_WDT_AS_TICK_SRC                                                             
 1141               			KER_WDT_DISABLE                                                                        
 1142               			#elif defined(KER_TIMER2_AS_TICK_SRC) || defined(KER_TIMER2_ASYNC_AS_TICK_SRC)         
1143:kernel.S      ****         KER_TIMER2_DISABLE                                                                     
 1144               			#else                                                                                  
 1145               			KER_TIMER2_DISABLE                                                                     
 1146               			#endif                                                                                 
 1147               			;save values for future use                                                            
1148:kernel.S      **** 		STS   KerBase+OFB_PRS    , R24                    ;KerBase[5] prescaler   (  2 clocks) 
1149:kernel.S      **** 		STS   KerBase+OFB_RLD    , R22                    ;KerBase[6] reload val  (  2 clocks) 
1150:kernel.S      ****         KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
1151:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1152               	;;===================================SysTick reg init end===================================;; 
 1153               	
 1154               	
 1155               	
 1156               	
 1157               	
 1158               	;;===============================kernel task create starting================================;; 
 1159               	;used registers          : R18, R19, R20, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)    
 1160               	;arg registers           : R25:R24(FuncPtr), R22(TaskPriority)                                 
 1161               	;return registers        : None                                                                
 1162               	;unsafe access registers : R18, R19, R20, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)    
 1163               	Kernel_Task_Create:                                       ;total 21.50uS @8MHz    (172 clocks) 
1164:kernel.S      ****         KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1165               			;set priority to KerSchPr+task_id                                                      
1166:kernel.S      **** 		LDI   R30                , lo8(KerSchPr)          ;load low byte          (  1 clock ) 
1167:kernel.S      **** 		LDI   R31                , hi8(KerSchPr)          ;load high byte         (  1 clock ) 
1168:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
1169:kernel.S      **** 		ST    Z                  , R22                    ;save priority          (  2 clocks) 
 1170               			;set task status to KerSchSts+task_id                                                  
1171:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1172:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1173:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;calc offset            (  5 clocks) 
1174:kernel.S      **** 		LDI   R18                , TASK_READY             ;set status as ready    (  1 clock ) 
1175:kernel.S      **** 		ST    Z                  , R18                    ;save status            (  2 clocks) 
 1176               			;stack pointer for current task (KerStack + KER_STK_SZ*(task_id+1) - 1) ->stack top    
1177:kernel.S      **** 		LDS   R18                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1178:kernel.S      **** 		INC   R18                                         ;increment task_id      (  1 clock ) 
1179:kernel.S      **** 		LDI   R19                , KER_STK_SZ             ;load stack size        (  1 clock ) 
1180:kernel.S      **** 		MUL   R18                , R19                    ;multiply to get offset (  2 clocks) 
1181:kernel.S      **** 		MOV   R30                , R0                     ;load multiplied low    (  1 clocks) 
1182:kernel.S      **** 		MOV   R31                , R1                     ;load multiplied high   (  1 clocks) 
1183:kernel.S      **** 		SBIW  R30                , 0x01                   ;dec multiplied val-1   (  2 clocks) 
1184:kernel.S      **** 		CLR   R1                                          ;gcc expects cleared    (  1 clock ) 
1185:kernel.S      **** 		LDI   R18                , lo8(KerStack)          ;load base addr low     (  1 clock ) 
1186:kernel.S      **** 		LDI   R19                , hi8(KerStack)          ;load base addr high    (  1 clock ) 
1187:kernel.S      **** 		ADD   R30                , R18                    ;add low bytes          (  1 clock ) 
1188:kernel.S      **** 		ADC   R31                , R19                    ;add high bytes+carry   (  1 clock ) 
1189:kernel.S      **** 		OUT   IOSPL              , R30                    ;load SPL               (  1 clock ) 
1190:kernel.S      ****         OUT   IOSPH              , R31                    ;load SPH               (  1 clock ) 
 1191               			;function argument directly returns word address                                       
1192:kernel.S      **** 	    PUSH  R24                                         ;push word addr low     (  2 clocks) 
1193:kernel.S      **** 		PUSH  R25                                         ;push word addr high    (  2 clocks) 
 1194               			;push context to stack of this task                                                    
1195:kernel.S      **** 		KER_CONTEXT_SAVE_HANDLER                          ;save context           ( 68 clocks) 
 1196               			;read stack pointer of current task (necessary when restore)                           
1197:kernel.S      **** 		IN    R18                , IOSPL                  ;read SPL               (  1 clock ) 
1198:kernel.S      ****         IN    R19                , IOSPH                  ;read SPH               (  1 clock ) 
 1199               			;calculate the address where current task's SP will be stored and store SP             
1200:kernel.S      **** 		LDS   R20                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1201:kernel.S      **** 		LSL   R20                                         ;left shift to multiply (  1 clock ) 
1202:kernel.S      **** 		LDI   R30                , lo8(KerPSP)            ;fetch base pos low     (  1 clock ) 
1203:kernel.S      **** 		LDI   R31                , hi8(KerPSP)            ;fetch base pos high    (  1 clock ) 
1204:kernel.S      **** 		ADD   R30                , R20                    ;add offset to array    (  1 clock ) 
1205:kernel.S      **** 		LDI   R20                , 0x00                   ;clear reg              (  1 clock ) 
1206:kernel.S      **** 		ADC   R31                , R20                    ;add carry if any       (  1 clock ) 
1207:kernel.S      **** 		ST    Z+                 , R18                    ;SPL at KerPSp+offset   (  2 clocks) 
1208:kernel.S      **** 		ST    Z                  , R19                    ;SPH at KerPSp+offset   (  2 clocks) 
 1209               			;increment task_id                                                                     
1210:kernel.S      **** 		LDS   R18                , KerBase+OFB_TID        ;load task_id           (  2 clocks) 
1211:kernel.S      **** 		INC   R18                                         ;increment task_id      (  1 clock ) 
1212:kernel.S      **** 		STS   KerBase+OFB_TID    , R18                    ;store task_id          (  2 clocks) 
 1213               			;increment ntask                                                                       
1214:kernel.S      **** 		LDS   R18                , KerBase+OFB_NTSK       ;load ntask             (  2 clocks) 
1215:kernel.S      **** 		INC   R18                                         ;increment ntask        (  1 clock ) 
1216:kernel.S      **** 		STS   KerBase+OFB_NTSK   , R18                    ;store ntask            (  2 clocks) 
1217:kernel.S      **** 		KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
1218:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1219               	;;==================================kernel task create end==================================;; 
 1220               	
 1221               	
 1222               	
 1223               	
 1224               	
 1225               	;;=================================kernel start tasks starting==============================;; 
 1226               	;used registers          : R0~R31                                                              
 1227               	;arg registers           : None                                                                
 1228               	;return registers        : None                                                                
 1229               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1230               	Kernel_Start_Tasks:                                       ;total 25.63uS @8MHz    (205 clocks) 
1231:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1232:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1233:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1234:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
 1235               			;config timer for system tick                                                          
1236:kernel.S      **** 		KER_TIMER_INIT                                    ;init timer, int enable ( 12 clocks) 
 1237               			;execute return to jump to highest priority task                                       
1238:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1239               	;;==================================kernel start tasks end==================================;; 
 1240               	
 1241               	
 1242               	
 1243               	
 1244               	
 1245               	;;===================================kernel init starting===================================;; 
 1246               	;used registers          : R1, R18, R19, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)     
 1247               	;arg registers           : None                                                                
 1248               	;return registers        : None                                                                
 1249               	;unsafe access registers : R1, R18, R19, R22, R24, R25, R26(XL), R27(XH), R30(ZL), R31(ZH)     
 1250               	Kernel_Init:                                              ;total 39.75uS @8MHz    (318 clocks) 
1251:kernel.S      **** 		CLR   R1                                          ;gcc expects            (  1 clock ) 
 1252               	        ;store stack top (for MSP) addr to KerSSZ+OFM_MSPI0:1                                  
1253:kernel.S      **** 		LDI   R18                , lo8(KerSSZ+OFM_MSPS)   ;load low address       (  1 clock ) 
1254:kernel.S      **** 		LDI   R19                , hi8(KerSSZ+OFM_MSPS)   ;load high address      (  1 clock ) 
1255:kernel.S      ****         STS   KerSSZ+OFM_MSPI+0  , R18                    ;set mspi to stack top  (  2 clocks) 
1256:kernel.S      **** 		STS   KerSSZ+OFM_MSPI+1  , R19                    ;set mspi to stack top  (  2 clocks) 
1257:kernel.S      **** 		KER_PUSH_MSP_ZP                                   ;push MSP and ZP        ( 18 clocks) 
 1258               			;init timer for kernel                                                                 
1259:kernel.S      **** 		LDI   R24                , 0x04                   ;set prescaler          (  1 clock ) 
1260:kernel.S      **** 		LDI   R22                , 0x7D                   ;set reload val         (  1 clock ) 
1261:kernel.S      **** 		CALL  Kernel_Tick_Init                            ;init timer             ( 92 clocks) 
 1262               			;create idle task at task_id 0, priority 0xFF (lowest)                                 
1263:kernel.S      **** 		LDI   R24                , lo8(Kernel_Task_Idle)  ;load func addr low     (  1 clock ) 
1264:kernel.S      **** 		LDI   R25                , hi8(Kernel_Task_Idle)  ;load func addr high    (  1 clock ) 
1265:kernel.S      **** 		LSR   R25                                         ;right shift to divide  (  1 clock ) 
1266:kernel.S      **** 		ROR   R24                                         ;rotate right th carry  (  1 clock ) 
1267:kernel.S      **** 		LDI   R22                , 0xFF                   ;set max val            (  1 clock ) 
1268:kernel.S      **** 		CALL  Kernel_Task_Create                          ;init idle task         (172 clocks) 
1269:kernel.S      **** 		KER_POP_MSP_ZP                                    ;pop MSP and ZP         ( 18 clocks) 
 1270               			;execute return to jump to task0, pushed while task init                               
1271:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1272               	;;======================================kernel init end=====================================;; 
 1273               	
 1274               	
 1275               	
 1276               	
 1277               	
 1278               	;;=================================kernel idle task starting================================;; 
 1279               	;used registers          : None                                                                
 1280               	;arg registers           : None                                                                
 1281               	;return registers        : None                                                                
 1282               	;unsafe access registers : None                                                                
 1283               	Kernel_Task_Idle:                                                                              
1284:kernel.S      **** 	    KER_SLEEP_INIT                                    ;sleep init             (  5 clocks) 
 1285               	    _IDLE_LOOP:                                           ;forever loop                        
1286:kernel.S      **** 	    KER_DISABLE_ANALOG_DOMAIN                         ;disable adc, ac        ( 10 clocks) 
 1287               			#ifdef KER_CALL_FUNC_BEFORE_SLEEP                                                      
 1288               			CALL  Kernel_PreSleep_Hook                        ;call func before sleep (  8 clocks) 
 1289               			#endif                                                                                 
1290:kernel.S      **** 	    KER_ENTER_SLEEP                                   ;enter sleep mode       (  6 clocks) 
1291:kernel.S      **** 		JMP   _IDLE_LOOP                                  ;jump to loop start     (  2 clocks) 
 1292               	;;==================================kernel idle task end====================================;; 
 1293               	
 1294               	
 1295               	
 1296               	
 1297               	
 1298               	;;================================kernel task sleep starting================================;; 
 1299               	;used registers          : R0~R31                                                              
 1300               	;arg registers           : R25:R24(SleepTime)                                                  
 1301               	;return registers        : None                                                                
 1302               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1303               	Kernel_Task_Sleep:                                        ;total 37.25uS @8MHz    (298 clocks) 
 1304               	        ;save current context                                                                  
1305:kernel.S      ****         KER_CONTEXT_SAVE_THREAD                           ;save context           ( 69 clocks) 
1306:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1307               			;create next task wakeup time (args R25:R24)                                           
1308:kernel.S      **** 		LDI   R30                , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1309:kernel.S      **** 		LDI   R31                , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1310:kernel.S      **** 		KER_CALC_ADDR_OFF_WORD                            ;offset calc            (  6 clocks) 
1311:kernel.S      **** 		STD   Z+0                , R24                    ;save sleep time low    (  2 clocks) 
1312:kernel.S      **** 		STD   Z+1                , R25                    ;save sleep time high   (  2 clocks) 
 1313               			;update task scheduler status as blocked                                               
1314:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1315:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1316:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1317:kernel.S      ****         LDI   R18                , TASK_BLOCKED           ;block task until cnt=0 (  1 clock ) 
1318:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
 1319               			;run scheduler, load next task sp, restore context                                     
1320:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1321:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1322:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1323:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
1324:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1325               	;;=================================kernel task sleep end====================================;; 
 1326               	
 1327               	
 1328               	
 1329               	
 1330               	
 1331               	;;========================kernel task constant latency starting=============================;; 
 1332               	;used registers          : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1333               	;arg registers           : R25:R24(SleepTime)                                                  
 1334               	;return registers        : None                                                                
 1335               	;unsafe access registers : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1336               	Kernel_Task_Constant_Latency:                             ;total 3.50uS @8MHz     ( 28 clocks) 
 1337               			;create next task wakeup time (args R25:R24)                                           
1338:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock ) 
1339:kernel.S      **** 		LDI   R30                , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1340:kernel.S      **** 		LDI   R31                , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1341:kernel.S      **** 		KER_CALC_ADDR_OFF_WORD                            ;offset calc            (  6 clocks) 
1342:kernel.S      **** 		STD   Z+0                , R24                    ;save sleep time low    (  2 clocks) 
1343:kernel.S      **** 		STD   Z+1                , R25                    ;save sleep time high   (  2 clocks) 
 1344               			;update task scheduler status as constant latency                                      
1345:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1346:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1347:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1348:kernel.S      ****         LDI   R18                , TASK_CONS_LAT          ;save as cons_lat       (  1 clock ) 
1349:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
1350:kernel.S      **** 		SEI                                               ;enable interrupt       (  1 clock ) 
1351:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1352               	;;=============================kernel task constant latency end=============================;; 
 1353               	
 1354               	
 1355               	
 1356               	
 1357               	
 1358               	;;=======================kernel task constant latency sleep starting========================;; 
 1359               	;used registers          : R0~R31                                                              
 1360               	;arg registers           : R25:R24(SleepTime)                                                  
 1361               	;return registers        : None                                                                
 1362               	;unsafe access registers : R18, R19, R20, R24, R25, R30(ZL), R31(ZH)                           
 1363               	Kernel_Task_Constant_Latency_Sleep:                       ;total 35.75uS @8MHz    (286 clocks) 
 1364               			;save current context                                                                  
1365:kernel.S      ****         KER_CONTEXT_SAVE_THREAD                           ;save context           ( 69 clocks) 
1366:kernel.S      **** 		KER_SAVE_CURR_TASK_SP                             ;save current task SP   ( 14 clocks) 
 1367               			;update task scheduler status as blocked                                               
1368:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1369:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1370:kernel.S      **** 		KER_CALC_ADDR_OFF_BYTES                           ;offset calc            (  5 clocks) 
1371:kernel.S      ****         LDI   R18                , TASK_BLOCKED           ;blocked until cnt=0    (  1 clock ) 
1372:kernel.S      **** 		STD   Z+0                , R18                    ;save block flag        (  2 clocks) 
 1373               			;run scheduler, load next task sp, restore context                                     
1374:kernel.S      **** 		LDI    R24               , SCH_MODE_THREAD        ;set sch mode           (  1 clock ) 
1375:kernel.S      **** 		KER_RUN_SCHEDULER                                 ;run scheduler          (106 clocks) 
1376:kernel.S      **** 		KER_LOAD_TASK_ID_AND_SP                           ;load next task id, SP  ( 14 clocks) 
1377:kernel.S      **** 		KER_CONTEXT_RESTORE_THREAD                        ;restore context        ( 68 clocks) 
1378:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1379               	;;=============================kernel task constant latency end=============================;; 
 1380               	
 1381               	
 1382               	
 1383               	
 1384               	
 1385               	;;=========================kernel call func before sleep starting===========================;; 
 1386               	;used registers          : R24, R25, R30(ZL), R31(ZH)                                          
 1387               	;arg registers           : R25:R24(FunctionPtr)                                                
 1388               	;return registers        : None                                                                
 1389               	;unsafe access registers : R24, R25, R30(ZL), R31(ZH)                                          
 1390               	Kernel_PreSleep_Hook:                                     ;total 1.00uS @8MHz     (  8 clocks) 
1391:kernel.S      ****         MOVW  R30                , R24                    ;move pointer to Z      (  1 clock ) 
1392:kernel.S      **** 		ICALL                                             ;indirect call          (  3 clocks) 
1393:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1394               	;;============================kernel call func before sleep end=============================;; 
 1395               	
 1396               	
 1397               	
 1398               	
 1399               	
 1400               	;;========================kernel main clock prescaler set starting==========================;; 
 1401               	;used registers          : R18, R24                                                            
 1402               	;arg registers           : R24(prescaler reg val)                                              
 1403               	;return registers        : None                                                                
 1404               	;unsafe access registers : R18, R24                                                            
 1405               	Kernel_Clock_Prescale:                                    ;total 1.75uS @8MHz     ( 14 clocks) 
1406:kernel.S      ****         LDS   R18                , SRSREG                 ;load sreg              (  2 clocks)
1407:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock )
1408:kernel.S      **** 		LDI   R19                , 0x80                   ;set CLKPCE             (  1 clock ) 
1409:kernel.S      **** 		STS   SRCLKPR            , R19                    ;store val              (  2 clocks) 
1410:kernel.S      **** 		STS   SRCLKPR            , R24                    ;store val              (  2 clocks)
1411:kernel.S      ****         STS   SRSREG             , R18                    ;store val              (  2 clocks) 
1412:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1413               	;;==========================kernel main clock prescaler set end=============================;; 
 1414               	
 1415               	
 1416               	
 1417               	
 1418               	
 1419               	;;===========================kernel task sleep time get starting============================;; 
 1420               	;used registers          : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1421               	;arg registers           : R24(TaskID)                                                         
 1422               	;return registers        : R25:R24(SleepTime)                                                  
 1423               	;unsafe access registers : R18, R24, R25, R30(ZL), R31(ZH)                                     
 1424               	Kernel_Task_Sleep_Time_Get:                               ;total 1.88uS @8MHz     ( 15 clocks) 
1425:kernel.S      **** 		MOV   R18                , R24                    ;copy                   (  1 clock ) 
1426:kernel.S      **** 		LSL   R18                                         ;x2                     (  1 clock ) 
1427:kernel.S      **** 		LDI   R30                , lo8(KerSchSlp)         ;load low byte          (  1 clock ) 
1428:kernel.S      **** 		LDI   R31                , hi8(KerSchSlp)         ;load high byte         (  1 clock ) 
1429:kernel.S      **** 		ADD   R30                , R18                    ;add low bytes          (  1 clock ) 
1430:kernel.S      **** 		LDI   R18                , 0x00                   ;load 0                 (  1 clock ) 
1431:kernel.S      **** 		ADC   R31                , R18                    ;add high byte+carry    (  1 clock ) 
1432:kernel.S      **** 		LDD   R24                , Z+0                    ;load sleep time        (  2 clocks) 
1433:kernel.S      **** 		LDD   R25                , Z+1                    ;load sleep time        (  2 clocks) 
1434:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1435               	;;==============================kernel task sleep time get end==============================;; 
 1436               	
 1437               	
 1438               	
 1439               	
 1440               	
 1441               	;;==============================kernel task status get starting=============================;; 
 1442               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 1443               	;arg registers           : R24(TaskID)                                                         
 1444               	;return registers        : R24(TaskSts)                                                        
 1445               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 1446               	Kernel_Task_Status_Get:                                   ;total 1.50uS @8MHz     ( 12 clocks) 
1447:kernel.S      **** 		MOV   R18                , R24                    ;copy                   (  1 clock ) 
1448:kernel.S      **** 		LDI   R30                , lo8(KerSchSts)         ;load low byte          (  1 clock ) 
1449:kernel.S      **** 		LDI   R31                , hi8(KerSchSts)         ;load high byte         (  1 clock ) 
1450:kernel.S      **** 		ADD   R30                , R18                    ;add low bytes          (  1 clock ) 
1451:kernel.S      **** 		LDI   R18                , 0x00                   ;load 0                 (  1 clock ) 
1452:kernel.S      **** 		ADC   R31                , R18                    ;add high byte+carry    (  1 clock ) 
1453:kernel.S      **** 		LD    R24                , Z                      ;load task status       (  2 clocks) 
1454:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1455               	;;================================kernel task status get end================================;; 
 1456               	
 1457               	
 1458               	
 1459               	
 1460               	
 1461               	;;================================kernel ntask get starting=================================;; 
 1462               	;used registers          : R24                                                                 
 1463               	;arg registers           : None                                                                
 1464               	;return registers        : R24(NTask)                                                          
 1465               	;unsafe access registers : R24                                                                 
 1466               	Kernel_NTask_Get:                                         ;total 0.75uS @8MHz     (  6 clocks) 
1467:kernel.S      **** 		LDS   R24                 , KerBase+OFB_NTSK      ;load ntask             (  2 clock ) 
1468:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1469               	;;===================================kernel ntask get end===================================;; 
 1470               	
 1471               	
 1472               	
 1473               	
 1474               	
 1475               	;;=============================kernel task priority get starting============================;; 
 1476               	;used registers          : R18, R24, R30(ZL), R31(ZH)                                          
 1477               	;arg registers           : R24(TaskID)                                                         
 1478               	;return registers        : R24(TaskPriority)                                                   
 1479               	;unsafe access registers : R18, R24, R30(ZL), R31(ZH)                                          
 1480               	Kernel_Task_Prio_Get:                                     ;total 1.50uS @8MHz     ( 12 clocks) 
 1481               			;get priority of the task id, arg (task_id->R24), return R24                           
1482:kernel.S      **** 		MOV   R18                , R24                    ;copy task_id           (  1 clock ) 
1483:kernel.S      **** 		LDI   R30                , lo8(KerSchPr)          ;load low byte          (  1 clock ) 
1484:kernel.S      **** 		LDI   R31                , hi8(KerSchPr)          ;load high byte         (  1 clock ) 
1485:kernel.S      **** 		ADD   R30                , R18                    ;add low bytes          (  1 clock ) 
1486:kernel.S      **** 		LDI   R18                , 0x00                   ;clear reg              (  1 clock ) 
1487:kernel.S      **** 		ADC   R31                , R18                    ;add high byte+carry    (  1 clock ) 
1488:kernel.S      **** 		LD    R24                , Z                      ;load priority          (  2 clocks) 
1489:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1490               	;;================================kernel task priority get end==============================;; 
 1491               	
 1492               	
 1493               	
 1494               	
 1495               	
 1496               	;;============================kernel lowest priority get starting===========================;; 
 1497               	;used registers          : R24                                                                 
 1498               	;arg registers           : None                                                                
 1499               	;return registers        : R24(LowestPriorityVal)                                              
 1500               	;unsafe access registers : R24                                                                 
 1501               	Kernel_Lowest_Prio_Get:                                   ;total 0.75uS @8MHz     (  6 clocks) 
1502:kernel.S      **** 		LDS   R24                , KerBase+OFB_LPR        ;load lowest priority   (  2 clocks) 
1503:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1504               	;;===============================kernel lowest priority get end=============================;; 
 1505               	
 1506               	
 1507               	
 1508               	
 1509               	
 1510               	;;===========================kernel high priority task id starting==========================;; 
 1511               	;used registers          : R24                                                                 
 1512               	;arg registers           : None                                                                
 1513               	;return registers        : R24(HighstPriorityTaskID)->UserTaskID (Excluding Idle Task)         
 1514               	;unsafe access registers : R24                                                                 
 1515               	Kernel_High_Prio_Task_ID_Get:                             ;total 0.88uS @8MHz     (  7 clocks) 
1516:kernel.S      **** 		LDS   R24                , KerBase+OFB_PTID       ;load priority tak_id   (  2 clocks) 
1517:kernel.S      **** 		DEC   R24                                         ;decrement by 1         (  1 clock ) 
1518:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1519               	;;==============================kernel high priority task id end============================;; 
 1520               	
 1521               	
 1522               	
 1523               	
 1524               	
 1525               	;;=========================kernel abs high priority task id starting========================;; 
 1526               	;used registers          : R24                                                                 
 1527               	;arg registers           : None                                                                
 1528               	;return registers        : R24(HighstPriorityTaskID)->AbsoluteTaskID (Including Idle Task)     
 1529               	;unsafe access registers : R24                                                                 
 1530               	Kernel_Abs_High_Prio_Task_ID_Get:                         ;total 0.75uS @8MHz     (  6 clocks) 
1531:kernel.S      **** 		LDS   R24                , KerBase+OFB_PTID       ;load priority tak_id   (  2 clocks) 
1532:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1533               	;;============================kernel abs high priority task id end==========================;; 
 1534               	
 1535               	
 1536               	
 1537               	
 1538               	
 1539               	;;================================kernel cpu usage get starting=============================;; 
 1540               	;used registers          : R24                                                                 
 1541               	;arg registers           : None                                                                
 1542               	;return registers        : R24(CurrentCpuUsage)->In percentage                                 
 1543               	;unsafe access registers : R24                                                                 
 1544               	Kernel_CPU_Usage_Get:                                     ;total 0.75uS @8MHz     (  6 clocks) 
 1545               			;get cpu usage, return R24                                                             
1546:kernel.S      **** 		LDS   R24                , KerBase+OFB_USAGE      ;load cpu usage         (  2 clocks) 
1547:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1548               	;;==================================kernel cpu usage get end================================;; 
 1549               	
 1550               	
 1551               	
 1552               	
 1553               	
 1554               	;;=================================kernel tick val get starting=============================;; 
 1555               	;used registers          : R22, R23, R24, R25                                                  
 1556               	;arg registers           : None                                                                
 1557               	;return registers        : R25:R22(TickVal)                                                    
 1558               	;unsafe access registers : R22, R23, R24, R25                                                  
 1559               	Kernel_Tick_Val_Get:                                      ;total 0.75uS @8MHz     (  6 clocks) 
1560:kernel.S      ****         IN    R18                , IOSREG                 ;save SREG              (  1 clock ) 
1561:kernel.S      **** 		CLI                                               ;disable interrupt      (  1 clock ) 
1562:kernel.S      **** 		LDS   R22                , KerBase+OFB_TICK0      ;load tick count        (  2 clocks) 
1563:kernel.S      **** 		LDS   R23                , KerBase+OFB_TICK1      ;load tick count        (  2 clocks) 
1564:kernel.S      **** 		LDS   R24                , KerBase+OFB_TICK2      ;load tick count        (  2 clocks) 
1565:kernel.S      **** 		LDS   R25                , KerBase+OFB_TICK3      ;load tick count        (  2 clocks) 
1566:kernel.S      **** 		OUT   IOSREG             , R18                    ;restore SREG           (  1 clock ) 
1567:kernel.S      **** 		RET                                               ;return from subroutine (  4 clocks) 
 1568               	;;===================================kernel tick val get end================================;; 
DEFINED SYMBOLS
            kernel.S:30     *ABS*:000003e8 KER_TR
            kernel.S:31     *ABS*:00000003 KER_PRS
            kernel.S:32     *ABS*:00000082 KER_RLD
            kernel.S:33     *ABS*:00000080 KER_STK_SZ
            kernel.S:34     *ABS*:0000000a KER_MX_NTSK
            kernel.S:42     *ABS*:00000000 OFB_TICK0
            kernel.S:43     *ABS*:00000001 OFB_TICK1
            kernel.S:44     *ABS*:00000002 OFB_TICK2
            kernel.S:45     *ABS*:00000003 OFB_TICK3
            kernel.S:46     *ABS*:00000004 OFB_TICK4
            kernel.S:47     *ABS*:00000005 OFB_PRS
            kernel.S:48     *ABS*:00000006 OFB_RLD
            kernel.S:49     *ABS*:00000007 OFB_TID
            kernel.S:50     *ABS*:00000008 OFB_NTSK
            kernel.S:51     *ABS*:00000009 OFB_LPR
            kernel.S:52     *ABS*:0000000a OFB_PTID
            kernel.S:53     *ABS*:0000000b OFB_UTC
            kernel.S:54     *ABS*:0000000c OFB_UATC
            kernel.S:55     *ABS*:0000000d OFB_USAGE
            kernel.S:56     *ABS*:0000000e OFB_SLCFG
            kernel.S:57     *ABS*:00000000 OFM_MSPI
            kernel.S:58     *ABS*:00000002 OFM_MSPS
            kernel.S:66     *ABS*:00000000 TASK_BLOCKED
            kernel.S:67     *ABS*:00000001 TASK_READY
            kernel.S:68     *ABS*:00000002 TASK_EXECUTING
            kernel.S:69     *ABS*:00000003 TASK_SUSPENDED
            kernel.S:70     *ABS*:00000004 TASK_CONS_LAT
            kernel.S:71     *ABS*:00000000 SCH_MODE_HANDLER
            kernel.S:72     *ABS*:00000001 SCH_MODE_THREAD
            kernel.S:81     *ABS*:000000b6 SRASSR
            kernel.S:82     *ABS*:000000b4 SROCR2B
            kernel.S:83     *ABS*:000000b3 SROCR2A
            kernel.S:84     *ABS*:000000b2 SRTCNT2
            kernel.S:85     *ABS*:000000b1 SRTCCR2B
            kernel.S:86     *ABS*:000000b0 SRTCCR2A
            kernel.S:87     *ABS*:0000007c SRADMUX
            kernel.S:88     *ABS*:0000007b SRADCSRB
            kernel.S:89     *ABS*:0000007a SRADCSRA
            kernel.S:90     *ABS*:00000070 SRTIMSK2
            kernel.S:91     *ABS*:0000006f SRTIMSK1
            kernel.S:92     *ABS*:0000006e SRTIMSK0
            kernel.S:93     *ABS*:00000061 SRCLKPR
            kernel.S:94     *ABS*:00000060 SRWDTCSR
            kernel.S:95     *ABS*:0000005f SRSREG
            kernel.S:96     *ABS*:0000005e SRSPH
            kernel.S:97     *ABS*:0000005d SRSPL
            kernel.S:98     *ABS*:00000055 SRMCUCR
            kernel.S:99     *ABS*:00000054 SRMCUSR
            kernel.S:100    *ABS*:00000053 SRSMCR
            kernel.S:101    *ABS*:00000050 SRACSR
            kernel.S:102    *ABS*:00000037 SRTIFR2
            kernel.S:103    *ABS*:00000036 SRTIFR1
            kernel.S:104    *ABS*:00000035 SRTIFR0
            kernel.S:106    *ABS*:0000003f IOSREG
            kernel.S:107    *ABS*:0000003e IOSPH
            kernel.S:108    *ABS*:0000003d IOSPL
            kernel.S:109    *ABS*:00000035 IOMCUCR
            kernel.S:110    *ABS*:00000034 IOMCUSR
            kernel.S:111    *ABS*:00000033 IOSMCR
            kernel.S:112    *ABS*:00000017 IOTIFR2
            kernel.S:113    *ABS*:00000016 IOTIFR1
            kernel.S:114    *ABS*:00000015 IOTIFR0
            kernel.S:125    .bss:00000000 KerBase
            kernel.S:128    .bss:00000010 KerPSP
            kernel.S:131    .bss:00000024 KerSSZ
            kernel.S:134    .bss:00000032 KerSchSts
            kernel.S:137    .bss:0000003c KerSchPr
            kernel.S:140    .bss:00000046 KerSchSlp
            kernel.S:143    .bss:0000005a KerStack
            kernel.S:1117   .text:000001dc Kernel_Tick_Init
            kernel.S:1163   .text:00000276 Kernel_Task_Create
            kernel.S:1230   .text:00000366 Kernel_Start_Tasks
            kernel.S:1250   .text:000004f8 Kernel_Init
            kernel.S:1283   .text:00000556 Kernel_Task_Idle
            kernel.S:1303   .text:00000584 Kernel_Task_Sleep
            kernel.S:1336   .text:0000071a Kernel_Task_Constant_Latency
            kernel.S:1363   .text:00000746 Kernel_Task_Constant_Latency_Sleep
            kernel.S:1390   .text:000008c8 Kernel_PreSleep_Hook
            kernel.S:1405   .text:000008ce Kernel_Clock_Prescale
            kernel.S:1424   .text:000008e4 Kernel_Task_Sleep_Time_Get
            kernel.S:1446   .text:000008f8 Kernel_Task_Status_Get
            kernel.S:1466   .text:00000908 Kernel_NTask_Get
            kernel.S:1480   .text:0000090e Kernel_Task_Prio_Get
            kernel.S:1501   .text:0000091e Kernel_Lowest_Prio_Get
            kernel.S:1515   .text:00000924 Kernel_High_Prio_Task_ID_Get
            kernel.S:1530   .text:0000092c Kernel_Abs_High_Prio_Task_ID_Get
            kernel.S:1544   .text:00000932 Kernel_CPU_Usage_Get
            kernel.S:1559   .text:00000938 Kernel_Tick_Val_Get
            kernel.S:1077   .text:00000000 __vector_7
            kernel.S:1084   .text:000000ae _KER_SCH_LOOP8
            kernel.S:1084   .text:000000e4 _VAL_NULL9
            kernel.S:1084   .text:000000f8 _VAL_NOT_NULL9
            kernel.S:1084   .text:00000108 _EXIT_SLP_TIME9
            kernel.S:1084   .text:00000112 _KER_CALC_PRIO8
            kernel.S:1084   .text:00000136 _KER_SCH_NEXT8
            kernel.S:1084   .text:00000146 _KER_SCH_EXIT8
            kernel.S:1085   .text:00000160 _KER_USG_TICK14
            kernel.S:1085   .text:0000017a _KER_USG_UTC_SV14
            kernel.S:1232   .text:00000376 _KER_SCH_LOOP32
            kernel.S:1232   .text:000003ac _VAL_NULL33
            kernel.S:1232   .text:000003c0 _VAL_NOT_NULL33
            kernel.S:1232   .text:000003d0 _EXIT_SLP_TIME33
            kernel.S:1232   .text:000003da _KER_CALC_PRIO32
            kernel.S:1232   .text:000003fe _KER_SCH_NEXT32
            kernel.S:1232   .text:0000040e _KER_SCH_EXIT32
            kernel.S:317    .text:0000049e _KER_TC2_AUB44
            kernel.S:317    .text:000004a6 _KER_TC2_BUB44
            kernel.S:317    .text:000004ae _KER_OC2_AUB44
            kernel.S:317    .text:000004b6 _KER_OC2_BUB44
            kernel.S:317    .text:000004be _KER_TC2_UB44
            kernel.S:317    .text:000004c6 _KER_TC2_TOV244
            kernel.S:317    .text:000004d4 _KER_TC2_OCF2A44
            kernel.S:317    .text:000004e2 _KER_TC2_OCF2B44
            kernel.S:317    .text:000004f0 _KER_TC2_INTEN44
            kernel.S:1285   .text:00000560 _IDLE_LOOP
            kernel.S:1321   .text:0000061a _KER_SCH_LOOP57
            kernel.S:1321   .text:00000650 _VAL_NULL58
            kernel.S:1321   .text:00000664 _VAL_NOT_NULL58
            kernel.S:1321   .text:00000674 _EXIT_SLP_TIME58
            kernel.S:1321   .text:0000067e _KER_CALC_PRIO57
            kernel.S:1321   .text:000006a2 _KER_SCH_NEXT57
            kernel.S:1321   .text:000006b2 _KER_SCH_EXIT57
            kernel.S:1375   .text:000007c8 _KER_SCH_LOOP76
            kernel.S:1375   .text:000007fe _VAL_NULL77
            kernel.S:1375   .text:00000812 _VAL_NOT_NULL77
            kernel.S:1375   .text:00000822 _EXIT_SLP_TIME77
            kernel.S:1375   .text:0000082c _KER_CALC_PRIO76
            kernel.S:1375   .text:00000850 _KER_SCH_NEXT76
            kernel.S:1375   .text:00000860 _KER_SCH_EXIT76

UNDEFINED SYMBOLS
Kernel_Tick_Val_Safely_Get
